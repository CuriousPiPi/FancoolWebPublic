(()=>{var e={5(){window.ThemePref||(window.ThemePref=function(){function e(e){return"dark"===e?"dark":"light"}return{resolve:function(){try{const e=localStorage.getItem("theme");if("dark"===e||"light"===e)return e}catch(e){}const e=document.documentElement.getAttribute("data-theme");if("dark"===e||"light"===e)return e;try{if(window.matchMedia&&window.matchMedia("(prefers-color-scheme: dark)").matches)return"dark"}catch(e){}return"light"},setDom:function(t){document.documentElement.setAttribute("data-theme",e(t))},save:function(t,n){const o=e(t);try{localStorage.setItem("theme",o)}catch(e){}if(n&&n.notifyServer)try{fetch("/api/theme",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({theme:o})}).catch(()=>{})}catch(e){}return o}}}())},285(){!function(e){const t="fc_selected_v2",n="fc_removed_v2",o="colorIndexMap_v1",i="x_axis_type",r="fc_prefs_v1",a="fc_likes_v1",s="fc_likes_fp_v1";function c(e,t){try{const n=localStorage.getItem(e);return n?JSON.parse(n):t}catch{return t}}function l(e,t){try{localStorage.setItem(e,JSON.stringify(t))}catch{}}!function(){try{const e=localStorage.getItem("fc_selected_v1"),i=localStorage.getItem("fc_removed_v1");let r=!(!e&&!i);if(!r){const e=localStorage.getItem(t);if(e)try{const t=JSON.parse(e);Array.isArray(t)&&t.some(e=>e&&(e.res_type||e.res_loc||e.brand||e.model||e.condition))&&(r=!0)}catch(e){}}r&&(localStorage.removeItem("fc_selected_v1"),localStorage.removeItem("fc_removed_v1"),localStorage.removeItem(t),localStorage.removeItem(n),localStorage.removeItem(o),console.warn("[LocalState] Purged legacy local data (v1 strings)."))}catch(e){}}();let d=c(t,[]),u=c(n,[]),m=c(o,{}),f=c(r,{legend_hidden_keys:[],pointer:{rpm:null,noise_db:null}}),h=(()=>{const e=(localStorage.getItem(i)||"").trim();return"rpm"===e||"noise_db"===e||"noise"===e?"noise"===e?"noise_db":e:"rpm"})();const p=c(a,[]);let y=new Set(Array.isArray(p)?p:[]),g=null,w=0;const b=0xffffffffffffffffn;let _={c:0,x:"0000000000000000",s:"0000000000000000"};function v(){let e=0,t=0n,n=0n;y.forEach(o=>{const i=function(e){let t=14695981039346656037n;for(let n=0;n<e.length;n++)t^=BigInt(e.charCodeAt(n)),t=1099511628211n*t&b;return t}(o);t^=i,n=n+i&b,e++}),_={c:e,x:t.toString(16).padStart(16,"0"),s:n.toString(16).padStart(16,"0")}}function x(){l(a,Array.from(y))}v(),function(){try{const e=localStorage.getItem(s);if(!e)return;const t=JSON.parse(e);if(!t||"object"!=typeof t)return;const{fp:n,ts:o}=t;if(!n||"object"!=typeof n)return;if(!("c"in n&&"x"in n&&"s"in n))return;if("number"!=typeof o)return;if(Date.now()-o>3e5)return;g={c:n.c,x:n.x,s:n.s},w=o}catch(e){}}();const S={setAll(e){y=new Set(Array.isArray(e)?e:[]),v(),x()},add(e){y.has(e)||(y.add(e),v(),x())},remove(e){y.has(e)&&(y.delete(e),v(),x())},has:e=>y.has(e),getAll:()=>Array.from(y),getCount:()=>y.size,getLocalFP:()=>({..._}),getServerFP:()=>g?{...g}:null,updateServerFP(e){e&&"object"==typeof e&&"c"in e&&"x"in e&&"s"in e&&(g={c:e.c,x:e.x,s:e.s},w=Date.now(),function(){try{g?localStorage.setItem(s,JSON.stringify({fp:g,ts:w})):localStorage.removeItem(s)}catch(e){}}())},compare:()=>({equal:!(!g||g.c!==_.c||g.x!==_.x||g.s!==_.s),server:g?{...g}:null,local:{..._}}),logCompare(){try{console.debug("[LocalState.likes] fingerprint compare:",S.compare())}catch(e){}},isSynced:()=>S.compare().equal,needRefresh:(e=3e5)=>!g||!S.isSynced()||!w||Date.now()-w>e,shouldSkipStatus:(e=3e5)=>S.isSynced()&&!S.needRefresh(e)};function A(e){if(!e)return 0;if(Object.prototype.hasOwnProperty.call(m,e))return 0|m[e];const t=new Set(Object.values(m).map(e=>0|e));let n=0;for(;t.has(n);)n++;return m[e]=n,L(),n}function L(){l(t,d),l(n,u),l(o,m),l(r,f);try{localStorage.setItem(i,h)}catch{}}function E(){l(r,f)}function M(e,t){window.dispatchEvent(new CustomEvent("localstate:changed",{detail:Object.assign({reason:e,selectedCount:d.length},t||{})}))}function C(e){return d.findIndex(t=>t.key===e)}function k(e){if(!e||!e.key)return;const t=(new Date).toISOString(),n=u.findIndex(t=>t.key===e.key);if(n>=0){const e=u[n];e.removed_time=t,u.splice(n,1),u.unshift(e)}else u.unshift({key:e.key,model_id:e.model_id,condition_id:e.condition_id,removed_time:t});u.length>50&&(u.length=50)}const P={getSelected:()=>d.slice(),getRecentlyRemoved:()=>u.slice(),addPairs:function(e){if(!Array.isArray(e))return{added:0,skipped:0,addedDetails:[]};let t=0,n=0;const o=[];return e.forEach(e=>{const i=Number(e.model_id),r=Number(e.condition_id);if(!Number.isFinite(i)||!Number.isFinite(r))return void n++;const a=(s=r,`${Number(i)}_${Number(s)}`);var s;C(a)>=0?n++:(d.push({key:a,model_id:i,condition_id:r}),A(a),t++,o.push({key:a,model_id:i,condition_id:r}))}),L(),t>0&&M("add",{added:t}),{added:t,skipped:n,addedDetails:o}},removeKey:function(e){const t=C(e);if(t<0)return!1;const n=d[t];return d.splice(t,1),k(n),L(),M("remove",{key:e}),!0},restoreKey:function(e){const t=u.findIndex(t=>t.key===e);if(t<0)return{ok:!1,reason:"not_in_removed"};if(C(e)>=0)return u.splice(t,1),L(),M("restore_skip",{key:e}),{ok:!1,reason:"already_selected"};const n=u[t];return u.splice(t,1),d.push({key:n.key,model_id:n.model_id,condition_id:n.condition_id}),A(e),L(),M("restore",{key:e}),{ok:!0,item:{key:n.key,model_id:n.model_id,condition_id:n.condition_id}}},clearAll:function(){d.slice().forEach(e=>k(e)),d=[],L(),M("clear_all",{})},removeFromRecentlyRemoved:e=>function(e){const t=u.findIndex(t=>t.key===e);return t>=0&&(u.splice(t,1),L(),M("purge_removed",{key:e}),!0)}(e),ensureColorIndex:A,getXAxisType:()=>h,setXAxisType:e=>function(e){const t="noise"===e?"noise_db":e;if(("rpm"===t||"noise_db"===t)&&h!==t){h=t;try{localStorage.setItem(i,h)}catch(e){}M("x_axis_changed",{xAxisType:h})}}(e),setLegendHiddenKeys:e=>function(e){f.legend_hidden_keys=Array.isArray(e)?e.slice():[],E(),M("legend_hidden",{})}(e),getLegendHiddenKeys:()=>(f.legend_hidden_keys||[]).slice(),setPointer:(e,t)=>function(e,t){f.pointer||(f.pointer={rpm:null,noise_db:null}),"rpm"!==e&&"noise_db"!==e||(f.pointer[e]=Number.isFinite(t)?t:null,E(),M("pointer_changed",{mode:e,value:f.pointer[e]}))}(e,t),getPointer:e=>function(e){return f.pointer?f.pointer[e]:null}(e),getSelectionPairs:()=>d.map(e=>({model_id:e.model_id,condition_id:e.condition_id})),persistAll:L,likes:S,patchCondition:function(e,t,n){}};e.LocalState=P,M("init",{selectedCount:d.length,xAxisType:h})}(window)},391(){!function(e){const t={init:function(){(function(){const e=document.getElementById("rightSubsegContainer");n=document.querySelector("#top-queries-pane .fc-seg"),o=document.querySelector("#search-results-pane .fc-seg"),e&&(n&&(n.dataset.paneId="top-queries-pane",e.appendChild(n)),o&&(o.dataset.paneId="search-results-pane",e.appendChild(o)))})(),function(){const n=document.querySelector(".fc-right-card");if(!n)return;const o=n.querySelector(".fc-tab-container"),i=n.querySelector(".fc-tab-wrapper");o&&i&&(o.id||(o.id="right-panel-container"),i.id||(i.id="right-panel-wrapper"),e.__RIGHT_PANEL_SNAP_ON=!0,"function"==typeof initSnapTabScrolling&&initSnapTabScrolling({containerId:o.id,group:"right-panel",persistKey:null,defaultTab:"top-queries",onActiveChange:e=>{h(e),"recent-updates"===e&&t.recentUpdates?.loadIfNeeded?.(),p()},clickScrollBehavior:"smooth"}))}(),function(){function e(e,t){return e&&e.classList&&e.classList.contains("fc-subrow")&&e.dataset.parentMid===String(t)}function t(e){const t=new Map;return e.forEach(e=>{t.set(e,e.getBoundingClientRect().top)}),t}function n(e){return Number(e.cond_rank||1e9)}function o(e){return Number(e.count||0)}function i(e,t,n,o){if(!e||!isFinite(t)||t<=0)return;const i=r.rowMs,a=e.scrollTop,s=Math.max(0,n||0),c=o?.anchorRow??null,l=Number.isFinite(o?.theadHeight)?o.theadHeight:0,d=Number.isFinite(o?.safeMargin)?o.safeMargin:0;let u=null;if(c)try{const t=e.getBoundingClientRect();u=c.getBoundingClientRect().top-t.top}catch(e){u=null}let m=1/0;if(null!=u&&u>0){const e=u-(l+d);m=e>0?e:0}let f=0;requestAnimationFrame(function n(o){f||(f=o);const r=Math.min(1,(o-f)/Math.max(1,i)),c=((l=r)<.5?2*l*l:1-Math.pow(-2*l+2,2)/2)*t-s;var l;if(c<=0)k(e,a);else{const t=c,n=Math.min(t,m);k(e,a+n)}r<1&&requestAnimationFrame(n)})}async function c(e){const c=safeClosest(e,"tr");if(!c)return;if(a(c))return;s(c,!0,e);const u=()=>s(c,!1,e,r.unlockDelayMs),m=C(c),f=c.getBoundingClientRect();!function(e){try{const t=e.closest("table");if(!t)return;const n=e.getBoundingClientRect(),o="1"===t.dataset.hotColLocked,i=e.children&&e.children[6];if(i){let r,a=i.querySelector(".fc-marquee-inner");if(a||(a=i.querySelector('[data-role="top-cond"], .js-top-cond, span, div')),a)r=a.getBoundingClientRect().left-n.left;else{const e=i.getBoundingClientRect(),t=getComputedStyle(i),o=parseFloat(t.paddingLeft)||0,a=i.querySelector(".fc-row-expander"),s=a?a.getBoundingClientRect().width:0,c=a&&parseFloat(getComputedStyle(a).marginRight)||0,l=4;r=e.left+o+s+c+l-n.left}if(t.style.setProperty("--subrow-anchor-x",Math.round(r)+"px"),!o){const n=i.getBoundingClientRect();let o=0;if(a){const e=a.getBoundingClientRect();o=Math.max(0,e.left-n.left)}else{const e=getComputedStyle(i),t=parseFloat(e.paddingLeft)||0,n=i.querySelector(".fc-row-expander"),r=n?n.getBoundingClientRect().width:0;o=t+r+(n&&parseFloat(getComputedStyle(n).marginRight)||0)+4}let r=[];try{r=JSON.parse(e.dataset.conditions||"[]")||[]}catch(e){}if(Array.isArray(r)&&r.length){let e=0;r.forEach(t=>{const n=String(t.condition_name_zh||"");n&&(e=Math.max(e,l(n,i,14,400)))});const a=12;let s=Math.round(o+e+a);const c=Math.round(n.width);s<c&&(s=c);const u=t.closest(".fc-right-card"),m=u?u.getBoundingClientRect().width:window.innerWidth,f=u?getComputedStyle(u).getPropertyValue("--hot-col-max-frac").trim():"",h=Number.isFinite(parseFloat(f))?parseFloat(f):.38,p=Math.max(180,Math.floor(m*h));s=Math.min(s,p);const y=d(t);t.style.setProperty("--hot-col-min-w",s+"px");const g=y&&y.children&&y.children[6];g&&(g.style.width=s+"px"),t.dataset.hotColLocked="1"}}}const r=e.children&&e.children[7];if(r){const e=getComputedStyle(r),n=parseFloat(e.paddingLeft)||0;t.style.setProperty("--subrow-count-pl",Math.round(n)+"px")}}catch(e){}}(c);const h=function(e){const t=[];let n=e.nextElementSibling;for(;n;)t.push(n),n=n.nextElementSibling;return t}(c),y=t(h),g=function(e){const t=new Map;return e.forEach(e=>{const n=e.getBoundingClientRect();t.set(e,{top:n.top,height:n.height,bottom:n.bottom})}),t}(h),w=function(e){try{return JSON.parse(e.dataset.conditions||"[]")||[]}catch(e){return[]}}(c).slice().sort((e,t)=>{const i=n(e),r=n(t);if(i!==r)return i-r;const a=o(e);return o(t)-a});c.insertAdjacentHTML("afterend",w.map(e=>function(e,t,n){const o=e.dataset.brand||"",i=e.dataset.model||"",r=e.dataset.modelId||"",a=String(t.condition_id||""),s=String(t.condition_name_zh||""),c=t.resistance_type_zh||"",l=t.resistance_location_zh||"";let d="";if("function"==typeof window.formatScenario)d=window.formatScenario(c,l);else{const e=escapeHtml(c||""),t=String(l||"").trim();d=t&&"无"!==t?`${e}(${escapeHtml(l)})`:e}const u=d?`<span class="fc-subrow__extra-left">${escapeHtml(d)}&nbsp;&nbsp;&nbsp;</span>`:"",m=Number(n||0);return`\n      <tr class="fc-subrow" data-parent-mid="${escapeHtml(r)}">\n        <td colspan="7">\n          <div class="fc-subrow__row">\n            <div class="fc-subrow__indent">\n              ${u}\n              <span class="fc-subrow__dot"></span>\n              <span class="fc-subrow__label">${escapeHtml(s)}</span>\n            </div>\n          </div>\n        </td>\n        <td>\n          <div class="fc-subrow__row fc-subrow__row--count">\n            <span class="text-blue-600 font-medium">${escapeHtml(m)}</span>\n          </div>\n        </td>\n        <td>\n          <div class="fc-subrow__row fc-subrow__row--actions">\n            ${buildQuickBtnHTML("ranking",o,i,r,a,s,function(e){const t=e&&e.closest("table");return!(!t||"ratingRankTable"!==t.id)}(e)?"top_rating_expand":"top_query_expand")}\n          </div>\n        </td>\n      </tr>`}(c,e,o(e))).join(""));let v=0;{let e=c.nextElementSibling;for(;e&&e.classList.contains("fc-subrow");)v+=e.getBoundingClientRect().height,e=e.nextElementSibling;if(!isFinite(v)||v<=0){const e=getComputedStyle(document.documentElement).getPropertyValue("--subrow-h").trim();v=(parseFloat(e)||26)*w.length}}const x=c.nextElementSibling&&c.nextElementSibling.classList.contains("fc-subrow")?c.nextElementSibling:null;let E=null,M=null;if(x){const e=c.children[6]?.querySelector(".fc-marquee-inner")||c.querySelector('[data-role="top-cond"], .js-top-cond'),t=x.querySelector("td[colspan] .fc-subrow__label"),n=c.querySelector("td:last-child .fc-btn-icon-add"),o=x.querySelector("td:last-child .fc-btn-icon-add");if(e&&t){const n=e.getBoundingClientRect(),o=t.getBoundingClientRect(),i=n.top+n.height/2,r=o.top+o.height/2;E=Math.round(r-i);const a=Math.round(i-r);t.style.transition="none",t.style.transform=`translateY(${a}px)`,A(x.querySelector("td[colspan]"))}if(n&&o){const e=n.getBoundingClientRect(),t=o.getBoundingClientRect();M=Math.round(t.top-e.top),o.style.transition="none",o.style.transform=`translateY(${Math.round(e.top-t.top)}px)`,A(x.querySelector("td:last-child"))}requestAnimationFrame(()=>{t&&(t.style.transition=`transform ${r.rowMs}ms ${r.rowEase}`,t.style.transform="translateY(0)"),o&&(o.style.transition=`transform ${r.rowMs}ms ${r.rowEase}`,o.style.transform="translateY(0)"),setTimeout(()=>{L(x.querySelector("td[colspan]")),L(x.querySelector("td:last-child")),t&&(t.style.transition="",t.style.transform=""),o&&(o.style.transition="",o.style.transform="")},r.rowMs+r.cleanupMs)})}const k=t(h);if(S(c,!0,{mode:"relay",duration:r.rowMs,easing:r.rowEase,dyLabel:E,dyBtn:M}),m){const e=m.getBoundingClientRect();let t=0;if(0===h.length)t=Math.max(0,Math.round(e.bottom-f.bottom));else{const n=h[0],o=g.get(n)||null;if(o&&Number.isFinite(o.top)&&Number.isFinite(o.height)){const n=o.top+o.height;t=Math.max(0,Math.round(e.bottom-n))}else{const o=y.get(n),i=Math.round(n&&n.getBoundingClientRect().height||parseFloat(getComputedStyle(document.documentElement).getPropertyValue("--rank-row-h"))||32);if("number"==typeof o){const n=o+i;t=Math.max(0,Math.round(e.bottom-n))}else{const o=n.getBoundingClientRect();t=Math.max(0,Math.round(e.bottom-(o.top-v+i)))}}}let n=0;try{const e=m.querySelector(".fc-rank-table");e&&e.tHead&&e.tHead.rows&&e.tHead.rows[0]&&(n=e.tHead.rows[0].getBoundingClientRect().height)}catch(e){n=0}i(m,+v,t,{anchorRow:c,theadHeight:n,safeMargin:0})}if(P=!0,h.forEach(e=>{P?e.classList.add("fc-row-animating"):e.classList.remove("fc-row-animating")}),h.length){b(h),h.forEach(e=>{const t=y.get(e),n=k.get(e);if(null==t||null==n)return;const o=t-n;Math.abs(o)<.5||(e.style.transition="none",e.style.transform=`translateY(${o}px)`)}),document.body.offsetWidth;let e=h.length;requestAnimationFrame(()=>{h.forEach(e=>{y.has(e)&&(e.style.transition=`transform ${r.rowMs}ms ${r.rowEase}`,e.style.transform="translateY(0)")});const t=n=>{if("transform"!==n.propertyName)return;const o=n.currentTarget;o.removeEventListener("transitionend",t),o.style.transition="",o.style.transform="",o.classList.remove("fc-row-animating"),0===--e&&(_(),u())};h.forEach(e=>e.addEventListener("transitionend",t)),setTimeout(()=>{e>0&&(e=0,_(),u())},r.rowMs+r.guardMs)})}else setTimeout(()=>{_(),u()},r.rowMs+r.cleanupMs);var P;e.setAttribute("aria-expanded","true"),e.removeAttribute("title"),e.classList.add("is-open"),"function"==typeof syncQuickActionButtons&&syncQuickActionButtons(),p()}function u({scroller:e,followers:t,totalDelta:n,freeSpacePx:o,duration:i=r.rowMs,onDone:a=()=>{}}){if(!t||!t.length||!isFinite(n)||n<=0)return void a();t.forEach(e=>{e.classList.add("fc-row-animating"),e.style.transition="none",e.style.transform="translate3d(0,0,0)",e.style.willChange="transform"}),b(t);const s=e?e.scrollTop:0,c=s;let l=0;requestAnimationFrame(function r(d){l||(l=d);const u=Math.min(1,(d-l)/Math.max(1,i)),m=n*((p=u)<.5?2*p*p:1-Math.pow(-2*p+2,2)/2),f=Math.max(0,m-(o||0)),h=e?Math.min(f,c):0;var p;e&&k(e,s-h);const y=`translate3d(0, ${-m}px, 0)`;t.forEach(e=>{e.style.transform=y}),u<1?requestAnimationFrame(r):(_(),a(),t.forEach(e=>{e.style.transition="none",e.style.transform="",e.style.willChange="",e.classList.remove("fc-row-animating"),requestAnimationFrame(()=>{e.style.transition=""})}))})}function m(t){const n=safeClosest(t,"tr");if(!n)return;if(a(n))return;s(n,!0,t);const o=()=>s(n,!1,t,0),i=C(n),c=n.dataset.modelId||"",l=[];let d=n.nextElementSibling;for(;e(d,c);)l.push(d),d=d.nextElementSibling;if(!l.length)return S(n,!1),o(),t.setAttribute("aria-expanded","false"),t.classList.remove("is-open"),void t.removeAttribute("title");const m=l[0]||null;let f=null,h=null;if(m){const e=n.children[6]?.querySelector(".fc-marquee-inner")||n.querySelector('[data-role="top-cond"], .js-top-cond'),t=m.querySelector("td[colspan] .fc-subrow__label"),o=n.querySelector("td:last-child .fc-btn-icon-add"),i=m.querySelector("td:last-child .fc-btn-icon-add");if(e&&t){const n=e.getBoundingClientRect(),o=t.getBoundingClientRect(),i=n.top+n.height/2,a=o.top+o.height/2;f=Math.round(a-i),A(m.querySelector("td[colspan]")),t.style.transition=`transform ${r.rowMs}ms ${r.rowEase}`,t.style.transform=`translateY(${Math.round(i-a)}px)`,setTimeout(()=>{L(m.querySelector("td[colspan]")),t.style.transition="",t.style.transform=""},r.rowMs+r.cleanupMs)}if(o&&i){const e=o.getBoundingClientRect(),t=i.getBoundingClientRect();h=Math.round(t.top-e.top),A(m.querySelector("td:last-child")),i.style.transition=`transform ${r.rowMs}ms ${r.rowEase}`,i.style.transform=`translateY(${Math.round(e.top-t.top)}px)`,setTimeout(()=>{L(m.querySelector("td:last-child")),i.style.transition="",i.style.transform=""},r.rowMs+r.cleanupMs)}}S(n,!1,{mode:"relay",duration:r.rowMs,easing:r.rowEase,fromDyLabel:f,fromDyBtn:h});let y=0;for(const e of l)y+=e.getBoundingClientRect().height;if(!isFinite(y)||y<=0){const e=getComputedStyle(document.documentElement).getPropertyValue("--subrow-h").trim();y=(parseFloat(e)||26)*l.length}const g=function(e){const t=[];let n=e?e.nextElementSibling:null;for(;n;)t.push(n),n=n.nextElementSibling;return t}(l[l.length-1]);if(0===g.length)i?function(e,t,n,o=r.rowMs,i){try{if(!n||!n.length)return void("function"==typeof i&&i());let e=0;for(const t of n)e+=t.getBoundingClientRect().height;if(!isFinite(e)||e<=0){const t=getComputedStyle(document.documentElement).getPropertyValue("--subrow-h").trim();e=(parseFloat(t)||26)*n.length}t&&function(e,t,n=r.rowMs){if(!e||!isFinite(t)||t<=0)return;const o=e.scrollTop;let i=0,a=0,s=!1;a=requestAnimationFrame(function r(c){i||(i=c);const l=Math.min(1,(c-i)/Math.max(1,n)),d=(u=l)<.5?2*u*u:1-Math.pow(-2*u+2,2)/2;var u;k(e,o-d*t),e.scrollTop<=0&&(s=!0),l<1&&!s&&(a=requestAnimationFrame(r))})}(t,e,o),setTimeout(()=>{n.forEach(e=>e.remove()),"function"==typeof i&&i()},o+r.cleanupMs)}catch(e){"function"==typeof i&&i()}}(0,i,l,r.rowMs,()=>{o()}):setTimeout(()=>{l.forEach(e=>e.remove()),o()},r.rowMs+r.cleanupMs);else{let e=0;if(i){const t=i.getBoundingClientRect(),o=function(e){const t=e?.closest?.("tbody");if(!t)return null;const n=t.querySelectorAll("tr:not(.fc-subrow)");return n.length?n[n.length-1]:null}(n);if(o){const n=o.getBoundingClientRect(),i=Math.round(n.bottom-t.bottom);e=Math.abs(i)}}u({scroller:i,followers:g,totalDelta:y,freeSpacePx:e,duration:r.rowMs,onDone:()=>{l.forEach(e=>e.remove()),requestAnimationFrame(()=>{g.forEach(e=>{e.style.transition="none",e.style.transform="",e.style.willChange="",e.classList.remove("fc-row-animating")}),requestAnimationFrame(()=>{g.forEach(e=>{e.style.transition=""}),o()})})}})}t.setAttribute("aria-expanded","false"),t.classList.remove("is-open"),t.removeAttribute("title"),p()}document.addEventListener("click",e=>{const t=safeClosest(e.target,".fc-expand-toggle");if(!t)return;const n=safeClosest(t,"tr");if(n&&a(n))return e.preventDefault(),void e.stopPropagation();e.preventDefault(),e.stopPropagation(),"true"===t.getAttribute("aria-expanded")?m(t):c(t)})}(),function(){const e=document.querySelector(".fc-right-card");if(!e)return;const t=t=>{t<520?e.classList.add("rp-narrow"):e.classList.remove("rp-narrow")};t(e.getBoundingClientRect().width),"ResizeObserver"in window?new ResizeObserver(e=>{for(const n of e)t(n.contentRect.width)}).observe(e):window.addEventListener("resize",()=>t(e.getBoundingClientRect().width))}(),function(){if(e.__MAIN_STACK_BOUND__)return;const t=document.getElementById("main-panels");if(!t)return;const n=e=>{e<980?t.classList.add("fc-force-col"):t.classList.remove("fc-force-col")};n(t.getBoundingClientRect().width),"ResizeObserver"in window?new ResizeObserver(e=>{for(const t of e)n(t.contentRect.width)}).observe(t):window.addEventListener("resize",()=>n(t.getBoundingClientRect().width)),e.__MAIN_STACK_BOUND__=!0}(),function(){const e=document.querySelectorAll("#rightSubsegContainer .fc-seg");e.length&&e.forEach(e=>{const t=e.querySelector(".fc-seg__thumb"),n=e.querySelectorAll(".fc-seg__btn");if(!t||2!==n.length)return;let o=!1,i=0,r=0,a=0;function s(n){const s=(n.touches?n.touches[0].clientX:n.clientX)||0;((e,n)=>{const o=t.getBoundingClientRect();return e>=o.left&&e<=o.right&&n>=o.top&&n<=o.bottom})(s,(n.touches?n.touches[0].clientY:n.clientY)||0)&&(o=!0,i=s,r=(e.getAttribute("data-active")||"").endsWith("likes-panel")||(e.getAttribute("data-active")||"").endsWith("search-likes-panel")?100:0,a=r,t.style.transition="none",n.cancelable&&n.preventDefault())}function c(e){if(!o)return;const n=((e.touches?e.touches[0].clientX:e.clientX)||0)-i,s=t.getBoundingClientRect().width||1;let c=r+n/s*100;c=Math.max(0,Math.min(100,c)),a=c,t.style.transform=`translateX(${c}%)`,e.cancelable&&e.preventDefault()}function l(){if(!o)return;o=!1;const e=a>=50?n[1]:n[0];t.style.transition="",t.style.transform="",e.click()}e.addEventListener("mousedown",s),document.addEventListener("mousemove",c,{passive:!1}),document.addEventListener("mouseup",l),e.addEventListener("touchstart",s,{passive:!1}),document.addEventListener("touchmove",c,{passive:!1}),document.addEventListener("touchend",l)})}(),function(){const e=Array.from(document.querySelectorAll(".fc-right-card .fc-rank-table")),t=e.filter(e=>null!==e.offsetParent);let n=!1;for(const e of t)m(e)&&(n=!0);n&&f(),e.forEach(e=>{if("1"===e.dataset.hotColLocked)return;const t=e.tBodies&&e.tBodies[0]?e.tBodies[0]:e,n=new MutationObserver(()=>{if(i>0)return f(),void n.disconnect();m(e)&&(f(),n.disconnect())});n.observe(t,{childList:!0,subtree:!0}),setTimeout(()=>n.disconnect(),5e3)})}(),h("top-queries"),function(){const e=document.getElementById("rightSubsegContainer");if(!e)return;let t=!1;e.addEventListener("click",n=>{const o=safeClosest(n.target,".fc-seg__btn");if(!o||!e.contains(o))return;if(t)return;const i=o.closest(".fc-seg");if(!i)return;const r=o.dataset.target;if(!r)return;const a=i.dataset.paneId,s=a?document.getElementById(a):null;if(!s)return;const c=Array.from(s.querySelectorAll(".fc-rank-panel"));if(!c.length)return;const l=c.find(e=>e.id===r),d=c.find(e=>e.classList.contains("active"));if(l===d)return i.querySelectorAll(".fc-seg__btn").forEach(e=>{e.classList.toggle("is-active",e===o)}),void i.setAttribute("data-active",r);if(i.querySelectorAll(".fc-seg__btn").forEach(e=>{e.classList.toggle("is-active",e===o)}),i.setAttribute("data-active",r),l&&(l.classList.add("active"),l.classList.remove("is-leaving"),l.style.animation="none",l.offsetWidth,l.style.animation=""),!d)return void(t=!1);d.classList.add("is-leaving"),t=!0;const u=e=>{e.target===d&&"fadePanelOut"===e.animationName&&(d.removeEventListener("animationend",u),d.classList.remove("is-leaving"),d.classList.remove("active"),t=!1)};d.addEventListener("animationend",u)})}(),p(),window.addEventListener("resize",()=>{p()})}};e.RightPanel=t;let n=null,o=null,i=null;const r={rowMs:240,rowEase:"ease",fadeOutMs:200,fadeInMs:220,cleanupMs:120,guardMs:200,relayNudgeLabelY:0,unlockDelayMs:120};function a(e){return!(!e||!e.dataset||"1"!==e.dataset._relay_anim)}function s(e,t,n,o=0){if(e)if(t)e.dataset._relay_anim="1",n&&(n.style.pointerEvents="none");else{const t=()=>{delete e.dataset._relay_anim,n&&(n.style.pointerEvents="")};o>0?setTimeout(t,o):t()}}let c=null;function l(e,t,n=14,o=400){c||(c=document.createElement("span"),c.style.position="absolute",c.style.left="-99999px",c.style.top="-99999px",c.style.visibility="hidden",c.style.whiteSpace="nowrap",document.body.appendChild(c));const i=t?getComputedStyle(t):getComputedStyle(document.body);return c.style.fontFamily=i.fontFamily||'system-ui,-apple-system,"Segoe UI","Helvetica Neue","Microsoft YaHei",Arial,sans-serif',c.style.fontSize=`${n}px`,c.style.fontWeight=String(o),c.textContent=String(e||""),c.offsetWidth||0}function d(e){if(!e)return null;let t=e.querySelector("colgroup");const n=(()=>{const t=e.tHead;if(t&&t.rows&&t.rows[0])return t.rows[0].children.length||0;const n=e.querySelector("tr");return n?n.children.length:0})();if(t){if(t.children.length!==n){t.innerHTML="";for(let e=0;e<n;e++)t.appendChild(document.createElement("col"));e.dataset.colCount=String(n)}}else{t=document.createElement("colgroup");for(let e=0;e<n;e++)t.appendChild(document.createElement("col"));e.insertBefore(t,e.firstChild),e.dataset.colCount=String(n)}return t}function u(e,t){if(!e||!Number.isFinite(t)||t<=0)return;const n=d(e),o=e.closest(".fc-right-card"),i=o?o.getBoundingClientRect().width:window.innerWidth,r=o?getComputedStyle(o).getPropertyValue("--hot-col-max-frac").trim():"",a=Number.isFinite(parseFloat(r))?parseFloat(r):.38,s=Math.max(180,Math.floor(i*a)),c=Math.min(Math.round(t),s);e.style.setProperty("--hot-col-min-w",c+"px");const l=n&&n.children&&n.children[6];l&&(l.style.width=c+"px"),e.dataset.hotColLocked="1"}function m(e){try{if(!e||"1"===e.dataset.hotColLocked)return!0;const t=e.querySelectorAll("tbody > tr:not(.fc-subrow)[data-conditions]");if(!t.length)return!1;const n=t[0],o=n.children&&n.children[6];if(!o)return e.dataset.hotColLocked="1",!0;const r=o.getBoundingClientRect(),a=(r.width||0)>0&&null!==o.offsetParent;let s=0;if(a){let e=o.querySelector(".fc-marquee-inner");if(e||(e=o.querySelector('[data-role="top-cond"], .js-top-cond, span, div')),e){const t=e.getBoundingClientRect();s=Math.max(0,t.left-r.left)}}if(!s){const e=getComputedStyle(o),t=parseFloat(e.paddingLeft)||0,n=o.querySelector(".fc-row-expander"),i=n?n.getBoundingClientRect().width:22;s=t+i+(n&&parseFloat(getComputedStyle(n).marginRight)||6)+4}let c=0;t.forEach(e=>{let t=[];try{t=JSON.parse(e.dataset.conditions||"[]")||[]}catch(e){}Array.isArray(t)&&t.length&&t.forEach(e=>{const t=String(e.condition_name_zh||"");t&&(c=Math.max(c,l(t,o,14,400)))})});const d=12;let m=Math.round(s+c+d);const f=Math.round(r.width||0);return f&&m<f&&(m=f),u(e,m),i=Math.max(i||0,m),!0}catch(e){return!0}}function f(){i>0&&document.querySelectorAll(".fc-right-card .fc-rank-table").forEach(e=>{"1"!==e.dataset.hotColLocked&&u(e,i)})}function h(e){n&&(n.style.display="top-queries"===e?"inline-flex":"none"),o&&(o.style.display="search-results"===e?"inline-flex":"none")}function p(){const e=document.querySelector(".fc-right-card");if(!e)return;const t=e.querySelector(".fc-rank-panel.active"),n=t?.querySelector(".fc-rank-scroll");n&&n.scrollWidth>n.clientWidth+1?e.classList.add("rp-compact-quick-btns"):e.classList.remove("rp-compact-quick-btns")}let y=null,g=null;function w(){if(g){for(const e of g){if(!e||!e.isConnected)continue;const t=e.getBoundingClientRect();e.style.setProperty("--row-vp-left",Math.round(t.left)+"px"),e.style.setProperty("--row-vp-top",Math.round(t.top)+"px")}y=requestAnimationFrame(w)}}function b(e){"dark"===document.documentElement.getAttribute("data-theme")&&function(){try{const e=getComputedStyle(document.documentElement).getPropertyValue("--dark-rand-gradient");return!!e&&""!==e.trim()&&"none"!==e.trim()}catch(e){return!1}}()?(cancelAnimationFrame(y),g=Array.from(e||[]),w()):_()}function _(){if(cancelAnimationFrame(y),y=null,g)for(const e of g)e&&(e.style.removeProperty("--row-vp-left"),e.style.removeProperty("--row-vp-top"));g=null}function v(e,t=0,n=6,o=r.fadeOutMs){if(!e||"hiding"===e.dataset._anim_state)return;e.dataset._anim_state="hiding",e.classList.add("fc-fade-slide"),e.style.visibility="",e.style.opacity="1",e.style.transform="translate3d(0,0,0)",e.offsetWidth,e.style.transition=`transform ${o}ms ${r.rowEase}, opacity ${o}ms ${r.rowEase}`,requestAnimationFrame(()=>{e.style.opacity="0",e.style.transform=`translate3d(${t}px, ${n}px, 0)`});const i=t=>{"opacity"===t.propertyName&&(e.removeEventListener("transitionend",i),e.style.visibility="hidden",e.style.transition="",e.dataset._anim_state="")};e.addEventListener("transitionend",i)}function x(e,t=0,n=-6,o=r.fadeInMs){if(!e||"showing"===e.dataset._anim_state)return;e.dataset._anim_state="showing",e.classList.add("fc-fade-slide"),e.style.visibility="visible",e.style.opacity="0",e.style.transform=`translate3d(${t}px, ${n}px, 0)`,e.offsetWidth,e.style.transition=`transform ${o}ms ${r.rowEase}, opacity ${o}ms ${r.rowEase}`,requestAnimationFrame(()=>{e.style.opacity="1",e.style.transform="translate3d(0,0,0)"});const i=t=>{"opacity"===t.propertyName&&(e.removeEventListener("transitionend",i),e.style.transition="",e.dataset._anim_state="")};e.addEventListener("transitionend",i)}function S(e,t,n={}){if(!e)return;const o=e.children&&e.children[6],i=e.children&&e.children[e.children.length-1],a=e.querySelector('[data-role="top-cond"] .fc-marquee-inner, td:nth-child(7) .fc-marquee-inner')||e.querySelector('[data-role="top-cond"], .js-top-cond'),s=e.querySelector("td:last-child .fc-btn-icon-add")||null;if("relay"===n.mode){const e=n.duration||r.rowMs,c=n.easing||"ease";return A(o),A(i),t?(a&&"number"==typeof n.dyLabel&&E(a,n.dyLabel,e,c),s&&"number"==typeof n.dyBtn&&E(s,n.dyBtn,e,c)):(a&&"number"==typeof n.fromDyLabel&&M(a,n.fromDyLabel,e,c),s&&"number"==typeof n.fromDyBtn&&M(s,n.fromDyBtn,e,c)),void setTimeout(()=>{L(o),L(i)},(n.duration||r.rowMs)+r.cleanupMs)}t?(a&&v(a),s&&v(s)):(a&&x(a),s&&x(s))}function A(e){e&&(e.classList.add("fc-col-clip"),e.style.position?e.dataset._orig_pos="keep":"static"===getComputedStyle(e).position?(e.dataset._orig_pos="static",e.style.position="relative"):e.dataset._orig_pos="keep")}function L(e){e&&(e.classList.remove("fc-col-clip"),"static"===e.dataset._orig_pos&&(e.style.position=""),delete e.dataset._orig_pos)}function E(e,t,n=r.rowMs,o=r.rowEase){if(!e)return;e.style.visibility="visible",e.style.willChange="transform",e.style.transition=`transform ${n}ms ${o}`,requestAnimationFrame(()=>{e.style.transform=`translateY(${Math.round(t)}px)`});const i=t=>{"transform"===t.propertyName&&(e.removeEventListener("transitionend",i),e.style.visibility="hidden",e.style.transition="",e.style.transform="",e.style.willChange="")};e.addEventListener("transitionend",i)}function M(e,t,n=r.rowMs,o=r.rowEase){if(!e)return;e.style.visibility="visible",e.style.willChange="transform",e.style.transition="none",e.style.transform=`translateY(${Math.round(t)}px)`,e.offsetWidth,requestAnimationFrame(()=>{e.style.transition=`transform ${n}ms ${o}`,e.style.transform="translateY(0)"});const i=t=>{"transform"===t.propertyName&&(e.removeEventListener("transitionend",i),e.style.transition="",e.style.transform="",e.style.willChange="")};e.addEventListener("transitionend",i)}function C(e){return e?.closest?.(".fc-rank-scroll")||null}function k(e,t){const n=Math.max(0,e.scrollHeight-e.clientHeight);e.scrollTop=Math.max(0,Math.min(n,t))}let P=!1,$=0;const F=6e5;let N=!1,T=null;function I(){return!P||Date.now()-$>F}function q(e){const t=document.getElementById("recentUpdatesTbody");if(!t)return;const n=e&&e.items||(e&&e.data&&Array.isArray(e.data.items)?e.data.items:[]);if(!Array.isArray(n))return void(t.innerHTML='<tr><td colspan="8" class="text-center text-red-500 py-6">数据格式异常</td></tr>');if(0===n.length)return void(t.innerHTML='<tr><td colspan="8" class="text-center text-gray-500 py-6">暂无近期更新数据</td></tr>');let o="";n.forEach(e=>{const t=e.brand_name_zh||"",n=e.model_name||"",i=null!=e.max_speed?` (${e.max_speed} RPM)`:"",r=`${escapeHtml(e.size)}x${escapeHtml(e.thickness)}`,a=escapeHtml(e.condition_name_zh||""),s=escapeHtml(e.update_date),c=null!=e.description&&""!==String(e.description).trim()?String(e.description):"-",l=escapeHtml(c);o+=`\n        <tr class="hover:bg-gray-50">\n          <td class="nowrap fc-marquee-cell"><span class="fc-marquee-inner">${escapeHtml(t)}</span></td>\n          <td class="nowrap fc-marquee-cell"><span class="fc-marquee-inner">${escapeHtml(n)}${i}</span></td>\n          <td class="nowrap fc-marquee-cell"><span class="fc-marquee-inner">${r}</span></td>\n          <td class="nowrap">${escapeHtml(e.rgb_light||"—")}</td>\n          <td class="nowrap fc-marquee-cell"><span class="fc-marquee-inner">${a}</span></td>\n          <td class="nowrap fc-marquee-cell"><span class="fc-marquee-inner">${s}</span></td>\n          <td class="nowrap fc-marquee-cell"><span class="fc-marquee-inner">${l}</span></td>\n          <td>\n            ${buildQuickBtnHTML("ranking",t,n,e.model_id,e.condition_id,e.condition_name_zh,"update_notice")}\n          </td>\n        </tr>`}),t.innerHTML=o,P=!0,$=Date.now(),"function"==typeof syncQuickActionButtons&&syncQuickActionButtons(),p()}function R(e=!0){if(e)return T&&clearTimeout(T),new Promise(e=>{T=setTimeout(()=>e(R(!1)),220)});if(N)return Promise.resolve();N=!0;const t="recent_updates",n={},o=window.__APP?.cache?.get(t,n);if(o&&!I())return q(o.data),N=!1,Promise.resolve();const i=document.getElementById("recentUpdatesTbody");return i&&!P&&(i.innerHTML='<tr><td colspan="8" class="text-center text-gray-500 py-6">加载中...</td></tr>'),fetch("/api/recent_updates").then(e=>e.json()).then(e=>{const o=normalizeApiResponse(e);if(!o.ok)return void("function"==typeof showError&&showError(o.error_message||"获取近期更新失败"));const i=o.data;window.__APP?.cache?.set(t,n,{data:i},F),q(i)}).catch(e=>{"function"==typeof showError&&showError("获取近期更新异常: "+e.message)}).finally(()=>{N=!1})}e.RightPanel.recentUpdates={loadIfNeeded:function(){I()&&("function"==typeof showLoading&&showLoading("updates-refresh","加载近期更新..."),R(!1).finally(()=>{"function"==typeof hideLoading&&hideLoading("updates-refresh")}))},reload:()=>R(!1)},e.RightPanel.updateSubseg=h,e.RightPanel.updateQuickBtnCompactMode=p}(window),"loading"!==document.readyState?window.RightPanel?.init():document.addEventListener("DOMContentLoaded",()=>window.RightPanel?.init(),{once:!0})},442(){!function(){const e=e=>window.__APP&&window.__APP.dom&&window.__APP.dom.one?window.__APP.dom.one(e):document.querySelector(e);window.__VERT_DRAGGING=!1,window.__SIDEBAR_USER_ADJUSTED_VERTICAL=!1;const t=e("#sidebar"),n=document.getElementById("sidebar-toggle"),o=e("#main-content"),i=document.getElementById("sidebar-resizer"),r=document.getElementById("sidebar-splitter"),a=document.getElementById("top-panel"),s=document.getElementById("bottom-panel");function c(){return window.innerWidth||document.documentElement.clientWidth||0}const l=function(){let e=null,t=null,n=!1;function o(e){return Array.from(e.querySelectorAll('a[href],button:not([disabled]),input:not([disabled]),select:not([disabled]),textarea:not([disabled]),[tabindex]:not([tabindex="-1"])')).filter(e=>null!==e.offsetParent)}function i(t){if("Tab"!==t.key)return;if(!e)return;const n=o(e);if(!n.length)return t.preventDefault(),void e.focus();const i=n[0],r=n[n.length-1];t.shiftKey?document.activeElement===i&&(t.preventDefault(),r.focus()):document.activeElement===r&&(t.preventDefault(),i.focus())}return{activate(r){r&&(e=r,t=document.activeElement,(o(r)[0]||r).focus({preventScroll:!0}),n||(document.addEventListener("keydown",i,!0),n=!0))},deactivate(){if(n&&(document.removeEventListener("keydown",i,!0),n=!1),t&&"function"==typeof t.focus)try{t.focus({preventScroll:!0})}catch(e){}e=null,t=null}}}();function d(){return document.documentElement.classList.contains("sidebar-overlay-mode")}function u(){const e=document.getElementById("sidebar-toggle");if(!e||!t)return;const n=t.classList.contains("collapsed");e.setAttribute("aria-label",n?"展开侧栏":"收起侧栏"),e.setAttribute("aria-expanded",String(!n))}!function(){if(c()>=600)return;if(document.documentElement.classList.add("sidebar-overlay-mode"),!t)return;t.classList.contains("collapsed")||t.classList.add("collapsed");let e=0,n="";function o(){d()&&t&&(t.classList.remove("collapsed"),0===e&&(n=document.body.style.overflow,document.body.style.overflow="hidden"),e++,ensureGestureZone(),l.activate(t),u())}function i(){if(d()&&t&&!t.classList.contains("collapsed")){t.classList.add("collapsed"),e=Math.max(0,e-1),0===e&&(document.body.style.overflow=n),l.deactivate();const o=document.getElementById("main-content");o&&(o.style.marginLeft=""),u()}}window.overlayOpenSidebar=o,window.overlayCloseSidebar=i,window.overlayToggleSidebar=function(){t&&(t.classList.contains("collapsed")?o():i())},document.addEventListener("keydown",e=>{"Escape"===e.key&&i()})}(),function(){if(!document.documentElement.classList.contains("sidebar-overlay-mode"))return void window.addEventListener("resize",function(){window.innerWidth<600&&e()},{once:!0});function e(){window.ensureGestureZone=function(){if(!t)return;if(document.getElementById("sidebar-gesture-close-zone"))return;const e=document.createElement("div");e.id="sidebar-gesture-close-zone",e.setAttribute("role","presentation"),t.appendChild(e),function(e,t){let s=null;function c(e){if(e.changedTouches&&e.changedTouches.length){const t=e.changedTouches[0];return{x:t.clientX,y:t.clientY}}return{x:e.clientX,y:e.clientY}}function l(){if(!s)return;const e=s.lastX-s.startX,n=Math.abs(e);let o=n>s.width*i;if(!o&&n>a&&s.trace&&s.trace.length>=2){const e=s.trace[s.trace.length-2],t=s.trace[s.trace.length-1],n=Math.max(1,t.t-e.t);(t.x-e.x)/n<=r&&(o=!0)}if(t.style.transition="",o)window.overlayCloseSidebar&&window.overlayCloseSidebar(),requestAnimationFrame(()=>{t.style.transform=""});else{t.style.transform="translateX(0)";const e=document.querySelector(".sidebar-overlay-backdrop");e&&(e.style.opacity=""),requestAnimationFrame(()=>{t.classList.contains("collapsed")||(t.style.transform="")})}s=null}e.addEventListener("pointerdown",n=>{if("mouse"===n.pointerType)return;if(t.classList.contains("collapsed"))return;const o=c(n);s={startX:o.x,startY:o.y,lastX:o.x,lastY:o.y,width:t.getBoundingClientRect().width,dragging:!1,pointerId:n.pointerId,trace:[{x:o.x,t:performance.now()}]};try{e.setPointerCapture(n.pointerId)}catch(e){console.error("Failed to setPointerCapture:",e)}},{passive:!0}),e.addEventListener("pointermove",e=>{if(!s||s.pointerId!==e.pointerId)return;const i=c(e);s.lastX=i.x,s.lastY=i.y;const r=i.x-s.startX,a=i.y-s.startY;if(!s.dragging)return void(r<-n&&(Math.abs(a/r)<=o?(s.dragging=!0,t.style.transition="none"):s=null));e.preventDefault();const l=Math.max(-s.width,r);t.style.transform=`translateX(${l}px)`;const d=document.querySelector(".sidebar-overlay-backdrop");if(d){const e=.8*(1-(1-(u=Math.max(0,Math.min(1,1+l/s.width))))*(1-u));d.style.opacity=e.toFixed(3);const t=performance.now();s.trace.push({x:i.x,t}),s.trace.length>5&&s.trace.shift()}var u},{passive:!1}),e.addEventListener("pointerup",e=>{s&&s.pointerId===e.pointerId&&(s.dragging?l():s=null)},{passive:!0}),e.addEventListener("pointercancel",e=>{s&&s.pointerId===e.pointerId&&(s.dragging?l():s=null)},{passive:!0})}(e,t)},window.ensureGestureZone()}e();const n=12,o=.65,i=.3,r=-.8,a=24}(),t&&o&&(d()||c()<1024||requestAnimationFrame(()=>{t.classList.contains("collapsed")&&(t.classList.remove("collapsed"),m=t.getBoundingClientRect().width||g,o.style.marginLeft=m+"px",f=!1,u(),"function"==typeof window.scheduleAdjust&&window.scheduleAdjust(),"function"==typeof window.syncTopTabsViewportHeight&&window.syncTopTabsViewportHeight())}));let m=t?.getBoundingClientRect().width||0,f=t?.classList.contains("collapsed")||!1;function h(){t&&(d()?t.classList.contains("collapsed")&&window.overlayOpenSidebar&&window.overlayOpenSidebar():f&&(t.classList.remove("collapsed"),o&&(o.style.marginLeft=m+"px"),f=!1,setTimeout(()=>window.__APP?.modules?.chart?.resizeChart&&window.__APP.modules.chart.resizeChart(),300),requestAnimationFrame(()=>{"function"==typeof window.syncTopTabsViewportHeight&&window.syncTopTabsViewportHeight(),window.RightPanel?.updateQuickBtnCompactMode?.()}),u()))}let p=!1;function y(){p&&(p=!1,window.__SIDEBAR_USER_ADJUSTED_VERTICAL=!1,window.__VERT_DRAGGING=!1,document.body.classList.remove("is-vert-dragging"),a&&(a.style.height="",a.style.flex=""),s&&(s.style.flex="",s.style.height=""),"function"==typeof window.scheduleAdjust&&window.scheduleAdjust())}t&&new MutationObserver(e=>{for(const n of e)"attributes"===n.type&&"class"===n.attributeName&&(u(),t.classList.contains("collapsed")?p=!0:requestAnimationFrame(y))}).observe(t,{attributes:!0}),n?.addEventListener("click",()=>{E(),t&&o&&(d()?window.overlayToggleSidebar&&window.overlayToggleSidebar():(f?h():(m=t.getBoundingClientRect().width,t.classList.add("collapsed"),o.style.marginLeft="0",f=!0),u()))}),u(),function(){if(!(r&&a&&s&&t))return;let e=document.getElementById("sidebar-splitter-handle");e||(e=document.createElement("button"),e.id="sidebar-splitter-handle",e.className="splitter-handle",e.type="button",e.setAttribute("role","separator"),e.setAttribute("aria-orientation","horizontal"),e.setAttribute("aria-label","拖拽调整上下面板高度"),r.appendChild(e)),e.addEventListener("mousedown",e=>e.stopPropagation(),{passive:!1}),e.addEventListener("touchstart",e=>e.stopPropagation(),{passive:!1});let n=!1,o=0,i=0,c=0;e.addEventListener("pointerdown",function(l){l.preventDefault(),l.stopPropagation(),e.setPointerCapture?.(l.pointerId),window.__SIDEBAR_USER_ADJUSTED_VERTICAL=!0,window.__VERT_DRAGGING=!0,document.body.classList.add("is-vert-dragging");const{headerH:d,maxTop:u}=function(){const e=document.getElementById("sidebar-header"),n=t.getBoundingClientRect(),o=e?e.getBoundingClientRect().height:0,i=n.height-o-r.offsetHeight,a=s?.querySelector(".fc-sidebar-panel__content"),c=a?.querySelector("h2"),l=document.getElementById("clearAllContainer"),d=a?getComputedStyle(a):null,u=c?Math.ceil(c.getBoundingClientRect().height):0,m=c&&parseFloat(getComputedStyle(c).marginBottom)||0,f=d&&parseFloat(d.paddingTop)||0,h=l&&!l.classList.contains("hidden")?Math.ceil(l.getBoundingClientRect().height):0,p=Math.ceil(u+m+f+h),y=Math.max(0,p);return{headerH:o,maxTop:Math.max(0,i-y)}}();c=u;const m=Math.max(0,Math.ceil(a.getBoundingClientRect().height));function f(t){if(!n)return;const r=t.clientY??(t.touches&&t.touches[0]?.clientY)??0;let l=i+(r-o);l=Math.max(0,Math.min(l,c));const u=Math.max(1,window.devicePixelRatio||1),m=Math.round((d+l)*u)/u-d;a.style.height=m.toFixed(2)+"px",a.style.flex="0 0 auto",s.style.flex="1 1 auto",s.style.height="",e.setAttribute("aria-valuenow",String(Math.round(m)))}function h(){n=!1,window.__VERT_DRAGGING=!1,document.body.classList.remove("is-vert-dragging"),document.body.style.cursor="",document.body.style.userSelect="",window.removeEventListener("pointermove",f,{capture:!1}),window.removeEventListener("pointerup",h,{capture:!1}),window.removeEventListener("pointercancel",h,{capture:!1})}n=!0,o=l.clientY??(l.touches&&l.touches[0]?.clientY)??0,i=m,document.body.style.cursor="ns-resize",document.body.style.userSelect="none",window.addEventListener("pointermove",f,{passive:!1}),window.addEventListener("pointerup",h,{passive:!0}),window.addEventListener("pointercancel",h,{passive:!0})},{passive:!1})}(),function(){if(!r)return;const e=r.querySelector("svg.splitter-rails"),t=r.querySelector("#sr-top-left"),n=r.querySelector("#sr-top-right"),o=r.querySelector("#sr-bot-left"),i=r.querySelector("#sr-bot-right");function a(){if(!(r&&e&&t&&n&&o&&i))return;const a=Math.max(0,Math.round(r.clientWidth)),s=Math.max(0,Math.round(r.clientHeight)),c=document.getElementById("sidebar-splitter-handle"),l=Math.max(0,Math.round(c?c.offsetWidth:72)),d=Math.min(a,l+0),u=Math.max(0,a-d),m=Math.floor(u/2),f=0+m,h=a,p=h-(u-m),y=.5,g=(s||12)-.5;t.setAttribute("x1",0),t.setAttribute("y1",y),t.setAttribute("x2",f),t.setAttribute("y2",y),n.setAttribute("x1",p),n.setAttribute("y1",y),n.setAttribute("x2",h),n.setAttribute("y2",y),o.setAttribute("x1",0),o.setAttribute("y1",g),o.setAttribute("x2",f),o.setAttribute("y2",g),i.setAttribute("x1",p),i.setAttribute("y1",g),i.setAttribute("x2",h),i.setAttribute("y2",g)}function s(){requestAnimationFrame(a)}s(),window.addEventListener("resize",s),window.updateSplitterRails=a}();const g=300;if(i&&t&&o){let C=!1,k=0,P=0,$=null;function w(e){C=!0,k=e,P=t.getBoundingClientRect().width,document.body.classList.add("resizing-sidebar"),document.body.classList.add("sidebar-hdragging"),document.body.style.userSelect="none"}function b(e){if(!C)return;let n=P+(e-k);n=Math.max(g,Math.min(700,n)),$||($=requestAnimationFrame(()=>{var e;e=n,t.style.width=e+"px",f||(o.style.marginLeft=e+"px",m=e,"function"==typeof window.updateSplitterRails&&window.updateSplitterRails()),$=null}))}function _(){C=!1,document.body.classList.remove("resizing-sidebar"),document.body.classList.remove("sidebar-hdragging"),document.body.style.userSelect="",document.removeEventListener("mousemove",v),document.removeEventListener("mouseup",x),window.removeEventListener("pointermove",S),window.removeEventListener("pointerup",A),window.removeEventListener("pointercancel",A),setTimeout(()=>window.__APP?.modules?.chart?.resizeChart&&window.__APP.modules.chart.resizeChart(),120),requestAnimationFrame(()=>{"function"==typeof window.syncTopTabsViewportHeight&&window.syncTopTabsViewportHeight(),window.RightPanel?.updateQuickBtnCompactMode?.()}),"function"==typeof window.scheduleAdjust&&window.scheduleAdjust()}function v(e){e.cancelable&&e.preventDefault(),b(e.clientX)}function x(){_()}function S(e){C&&(e.cancelable&&e.preventDefault(),b(e.clientX))}function A(){_()}i.addEventListener("mousedown",e=>{f||d()||(e.preventDefault(),w(e.clientX),document.addEventListener("mousemove",v,{passive:!1}),document.addEventListener("mouseup",x,{passive:!0}))}),i.addEventListener("pointerdown",e=>{f||d()||"touch"!==e.pointerType&&"pen"!==e.pointerType||(e.preventDefault(),w(e.clientX),window.addEventListener("pointermove",S,{passive:!1}),window.addEventListener("pointerup",A,{passive:!0}),window.addEventListener("pointercancel",A,{passive:!0}))})}!function(){const e=e=>Number.parseFloat(e)||0,t=e=>e?Math.ceil(e.getBoundingClientRect().height):0;window.adjustBottomPanelAuto=function(){if(window.__SIDEBAR_USER_ADJUSTED_VERTICAL)return;const n=document.getElementById("bottom-panel"),o=document.getElementById("top-panel");if(!n||!o)return;const i=function(){const n=document.getElementById("bottom-panel"),o=n?.querySelector(".fc-sidebar-panel__content"),i=o?.querySelector("h2"),r=document.getElementById("selectedFansList"),a=document.getElementById("clearAllContainer"),s=window.innerHeight,c=t(i),l=i?e(getComputedStyle(i).marginBottom):0,d=o?e(getComputedStyle(o).paddingTop):0,u=(m=a)&&!m.classList.contains("hidden")?t(a):0;var m;let f=0,h=56,p=0,y=0,g=0;if(r){const n=r.querySelectorAll(".fan-item");if(f=n.length,f>0){h=t(n[0]);let o=0;const i=getComputedStyle(n[0]);o=e(i.marginBottom),p=o}const o=getComputedStyle(r);y=e(o.paddingTop),g=e(o.paddingBottom)}const w=f>0?f*h+Math.max(0,f-1)*p+y+g:0,b=d+c+l+u,_=.72*s,v=s-260,x=Math.max(140,Math.min(_,v)),S=Math.max(0,x-b),A=b+Math.min(w,S),L=Math.max(Math.min(A,x),Math.min(140,x));return Math.round(L)}();n.style.flex=`0 0 ${i}px`,o.style.flex="1 1 auto",requestAnimationFrame(()=>{"function"==typeof window.syncTopTabsViewportHeight&&window.syncTopTabsViewportHeight()})},function(){const e=document.getElementById("selectedFansList");e&&"ResizeObserver"in window&&new ResizeObserver(()=>{window.__SIDEBAR_USER_ADJUSTED_VERTICAL||"function"==typeof window.scheduleAdjust&&window.scheduleAdjust()}).observe(e)}();const n=document.getElementById("clearAllContainer");n&&"ResizeObserver"in window&&new ResizeObserver(()=>{window.__SIDEBAR_USER_ADJUSTED_VERTICAL||requestAnimationFrame(()=>window.adjustBottomPanelAuto())}).observe(n),window.addEventListener("resize",()=>{window.__SIDEBAR_USER_ADJUSTED_VERTICAL||requestAnimationFrame(()=>window.adjustBottomPanelAuto())})}();const L="sidebar_toggle_clicked";function E(){try{localStorage.setItem(L,"1")}catch(e){}}function M(){try{return"1"===localStorage.getItem(L)}catch(e){return!1}}window.__APP=window.__APP||{},window.__APP.sidebar={open:window.overlayOpenSidebar,close:window.overlayCloseSidebar,toggle:window.overlayToggleSidebar,ensureGestureZone:window.ensureGestureZone||function(){},refreshToggleUI:u,expandSidebarIfCollapsed:h,adjustBottomPanelAuto:window.adjustBottomPanelAuto,markSidebarToggleClicked:E,userHasClickedSidebarToggle:M,maybeAutoOpenSidebarOnAdd:function(){M()||h()}}}()},654(){!function(){const e="home",t="/api/log_query";function n(){try{if("1"===sessionStorage.getItem("visit_started"))return}catch(e){}const e=document.documentElement.getAttribute("data-theme")||"light",t={screen_w:"undefined"!=typeof screen&&screen.width||null,screen_h:"undefined"!=typeof screen&&screen.height||null,device_pixel_ratio:"undefined"!=typeof window&&window.devicePixelRatio||null,language:"undefined"!=typeof navigator&&navigator.languages&&navigator.languages[0]||navigator.language||null,is_touch:"ontouchstart"in window||navigator.maxTouchPoints>0,theme:e};fetch("/api/visit_start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t),keepalive:!0}).catch(e=>{console.error("Analytics visit_start failed:",e)}).finally(()=>{try{sessionStorage.setItem("visit_started","1")}catch(e){}})}function o({event_type_code:t,page_key:n=e,target_url:o=null,model_id:i,condition_id:r,payload_json:a}={}){if(!t)return;const s={event_type_code:String(t).slice(0,64),page_key:String(n||e).slice(0,64),target_url:null==o||""===o?null:String(o).slice(0,512)};null!=i&&(s.model_id=i),null!=r&&(s.condition_id=r),null!=a&&(s.payload_json=a),function(e,t){try{const n=JSON.stringify(t||{});if(navigator.sendBeacon){const t=new Blob([n],{type:"application/json"});return navigator.sendBeacon(e,t)}return fetch(e,{method:"POST",headers:{"Content-Type":"application/json"},body:n,keepalive:!0}).catch(()=>{}),!0}catch(e){return!1}}("/api/log_event",s)}const i={};n(),document.addEventListener("click",e=>{e.target.closest&&e.target.closest('a[data-track-id="link_source_info"]')&&o({event_type_code:"click_source_info",target_url:"/source-info"})},!0),document.addEventListener("click",e=>{const t=e.target.closest&&e.target.closest('a[data-track-id="link_github_open_source"]');t&&o({event_type_code:"click_github_link",target_url:t.getAttribute("href")||""})},!0),function(){const e=document.getElementById("themeToggle");e&&e.addEventListener("click",()=>{try{o({event_type_code:"click_theme_toggle",target_url:"theme:"+("light"===(document.documentElement.getAttribute("data-theme")||"light")?"dark":"light")})}catch(e){}})}(),document.addEventListener("click",e=>{const t=e.target.closest&&e.target.closest(".fc-expand-toggle");if(!t)return;if("true"===t.getAttribute("aria-expanded"))return;const n=t.closest("tr"),i=n&&n.dataset&&n.dataset.modelId?parseInt(n.dataset.modelId,10):null;o({event_type_code:"click_right_panel_expander",...null!=i?{model_id:i}:{}})},!0),window.Analytics={initVisitStartOnce:n,logEvent:o,logPlayAudio:function(e,t,n,r,a,s){const c=Math.round(a),l=null!=s?Math.round(10*s)/10:null,d="db"===n?Math.round(10*r)/10:Math.round(r),u=`${e}|${t}|${n}|${d}|${c}|${l}`,m=Date.now();if(i[u]&&m-i[u]<1e3)return;const f=Object.keys(i);if(f.length>=200){const e=f.sort((e,t)=>i[e]-i[t]);for(let t=0;t<Math.floor(100);t++)delete i[e[t]]}i[u]=m,o({event_type_code:"click_play_audio",model_id:e,condition_id:t,payload_json:{x_axis_mode:n,pointer_x:d,rpm:c,db:l}})},logQueryPairs:async function(e,n){try{const o=Array.isArray(n)?n.map(e=>({model_id:Number(e.model_id),condition_id:Number(e.condition_id)})).filter(e=>Number.isInteger(e.model_id)&&Number.isInteger(e.condition_id)):[];if(!o.length)return;const i={source:(e||"").slice(0,64),pairs:o},r=JSON.stringify(i);if(navigator.sendBeacon){const e=new Blob([r],{type:"application/json"});navigator.sendBeacon(t,e)}else await fetch(t,{method:"POST",headers:{"Content-Type":"application/json"},body:r,keepalive:!0})}catch(e){}}}}()},768(){!function(){const e={mount:function(e){if(!e)return void oe("[ChartRenderer] mount(rootEl) 需要一个有效的 DOM 容器");t=e,ge();const o=t.closest(".fc-chart-container");if(o){let e=o.querySelector(".chart-stack");e||(e=document.createElement("div"),e.className="chart-stack",t.parentElement&&t.parentElement.insertBefore(e,t),e.appendChild(t)),c&&c.parentElement!==e&&e.appendChild(c)}j(),W(),le();const i=window.ThemePref&&"function"==typeof window.ThemePref.resolve?window.ThemePref.resolve():document.documentElement.getAttribute("data-theme")||"light";window.ThemePref&&"function"==typeof window.ThemePref.setDom?window.ThemePref.setDom(i):document.documentElement.setAttribute("data-theme",i),n&&be({chartData:{series:[]},theme:i})},render:be,resize:function(){n&&n.resize()},setOnXAxisChange:function(e){o="function"==typeof e?e:null},__ensureDock:()=>R()};let t=null,n=null,o=null,i=null,r=null,a=null,s=!1,c=null,l=null,d=null,u=!1,m=null;const f=new Map,h=20,p=2e4,y=-10;let g="1_48",w=null,b=!1,_=null,v=null,x=null,S=!1,A=!1,L=!1;const E=1024,M=48,C=50;let k=null;const P={3:[1,2,5],10:[1,1.25,1.6,2,2.5,3.15,4,5,6.3,8],20:[1,1.12,1.25,1.4,1.6,1.8,2,2.24,2.5,2.8,3.15,3.55,4,4.5,5,5.6,6.3,7.1,8,9],40:[1,1.06,1.12,1.18,1.25,1.32,1.4,1.5,1.6,1.7,1.8,1.9,2,2.12,2.24,2.36,2.5,2.65,2.8,3,3.15,3.35,3.55,3.75,4,4.25,4.5,4.75,5,5.3,5.6,6,6.3,6.7,7.1,7.5,8,8.5,9,9.5]};function $(e){return Math.round(10*e/3)}function F(e,t){const n=$(t),o=Math.pow(10,1/(2*n)),i=[],r=[];for(const t of e)i.push(t/o),r.push(t*o);return{f1:i,f2:r}}function N(){return g}function T(e,t,n,o){const i=e.map(Number),r=t.map(Number),a=Math.min(i.length,r.length);if(!a||!Number.isFinite(n)||!Number.isFinite(o))return{centers:[],valuesDb:[]};const s=function(e,t,n){const o=$(e),i=Math.max(t,1e-12),r=Math.max(n,1e-12),a=Math.ceil(o*Math.log10(i)),s=Math.floor(o*Math.log10(r));if(s<a)return[];const c=[];for(let e=a;e<=s;e++)c.push(e);return function(e,t){const n=P[t];if(!n||!n.length)return e.slice();const o=n.map(Number),i=[];for(let t=0;t<e.length;t++){const n=Number(e[t]);if(!(Number.isFinite(n)&&n>0))continue;const r=Math.floor(Math.log10(n)),a=n/Math.pow(10,r);let s=0,c=1/0;for(let e=0;e<o.length;e++){const t=Math.abs(o[e]-a);t<c&&(c=t,s=e)}const l=o[s]*Math.pow(10,r);i.push(l)}return Array.from(new Set(i.map(e=>Number(e.toFixed(6))))).sort((e,t)=>e-t)}(c.map(e=>Math.pow(10,e/o)),o).filter(e=>e>=t&&e<=n)}(o,h,p);if(!s.length)return{centers:[],valuesDb:[]};const{f1:c,f2:l}=F(s,o),{f1:d,f2:u}=F(i,n),m=Math.pow(2e-5,2),f=new Array(a);for(let e=0;e<a;e++){const t=r[e];Number.isFinite(t)?f[e]=m*Math.pow(10,t/10):f[e]=0}const y=[],g=[];for(let e=0;e<s.length;e++){const t=c[e],n=l[e];let o=0;for(let e=0;e<a;e++){const i=f[e];if(i<=0)continue;const r=d[e],a=u[e];if(!(a>r))continue;const s=Math.max(t,r),c=Math.min(n,a);if(c<=s)continue;const l=(c-s)/(a-r||1e-9);l>0&&(o+=i*l)}if(o>0){const t=10*Math.log10(o/m);y.push(s[e]),g.push(t)}}return{centers:y,valuesDb:g}}function I(){return!!window.__forceSpectrumDockFromUrl?.()||!(!window.APP_CONFIG||!window.APP_CONFIG.spectrumDockEnabled)}function q(){return!!window.__forcePlayAudioFromUrl?.()||!(!window.APP_CONFIG||!window.APP_CONFIG.playAudioEnabled)}function R(){if(!I()){if(k&&k.parentElement){try{k.remove()}catch(e){}k=null}return null}if(k&&k.isConnected)return k;const e=document.createElement("button");e.id="spectrumDock",e.type="button",e.className="spectrum-dock",e.setAttribute("aria-label","展开/收起频谱"),e.innerHTML='\n    <svg class="chev" viewBox="0 0 16 16" width="16" height="16" aria-hidden="true" focusable="false">\n      <path d="M3.2 6.2a1 1 0 0 1 1.4 0L8 9.6l3.4-3.4a1 1 0 1 1 1.4 1.4L8.7 11.7a1 1 0 0 1-1.4 0L3.2 7.6a1 1 0 0 1 0-1.4z" fill="currentColor"></path>\n    </svg>\n    <span class="label">展开频谱</span>\n  ',e.addEventListener("click",e=>{e.preventDefault(),At.setEnabled(!At.isEnabled(),{animate:!0})});const n=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||document.body;try{n.appendChild(e)}catch(t){document.body.appendChild(e)}return k=e,B(),k}function B(){if(!k)return;if(!I())return void(k.style.visibility="hidden");const e=!!u;k.classList.toggle("is-open",e);const t=k.querySelector(".label");t&&(t.textContent=e?"收起频谱":"展开频谱"),k.style.visibility="visible"}function D(){if(!I())return;const e=R();if(!e)return;const n=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||null;if(n){if(e.parentElement!==n)try{n.appendChild(e)}catch(e){}e.style.visibility="visible"}else e.style.visibility="hidden"}window.__forceSpectrumDockFromUrl||(window.__forceSpectrumDockFromUrl=function(){try{return"1"===new URLSearchParams(window.location.search).get("force_spectrum_dock")}catch(e){return!1}}),window.__forcePlayAudioFromUrl||(window.__forcePlayAudioFromUrl=function(){try{return"1"===new URLSearchParams(window.location.search).get("force_play_audio")}catch(e){return!1}});let H=0;const O=new Set;function z(e,t){const n=H,o=setTimeout(()=>{O.delete(o),n===H&&e()},t);return O.add(o),o}function j(){const e=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||null;if(!e)return null;e.classList.add("chart-flex");let n=e.querySelector(".chart-stack");if(n||(n=document.createElement("div"),n.className="chart-stack",t&&n.appendChild(t),c&&n.appendChild(c),e.insertBefore(n,e.firstChild)),_&&_.isConnected)return _;const o=document.createElement("aside");return o.id="legendRail",o.innerHTML='\n    <div class="rail-actions"></div>\n    <div class="legend-scroll" id="legendRailScroll"></div>\n  ',e.appendChild(o),_=o,v=o.querySelector("#legendRailScroll"),x=o.querySelector(".rail-actions"),o}function W(){const e=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||null;if(!e)return;e.classList.add("chart-flex");const n=he(),o=ut();if(e.classList.toggle("legend-integrated",o),e.classList.toggle("is-narrow",!!n),!_)return;try{const e=n?0:C;_.style.setProperty("--legend-top-gap",`${e}px`)}catch(e){}const r=s&&o&&Z;if(x&&(x.style.display=r?"none":"flex"),n&&!s){if("0"!==_.getAttribute("data-last-width")){_.style.width="100%";try{e.style.setProperty("--legend-rail-w","0px")}catch(e){}_.setAttribute("data-last-width","0")}return}const a=Math.max(0,Math.round(e.getBoundingClientRect().width||0)),c=a<200?Math.max(window.innerWidth||0,document.documentElement.clientWidth||0):a,l=Array.isArray(i?.chartData?.series)?i.chartData.series:[],d=_e(i&&i.theme||document.documentElement.getAttribute("data-theme")||"light"),u=!!Z&&!!l.length&&o,m=function({sList:e,integrated:t,fitOn:n,t:o,baseW:i,hasPlayBtn:r=!1}){if(!Array.isArray(e)||!e.length)return t?180:160;const a=function(e,{t,integrated:n,isNarrow:o}){const i=document.createElement("canvas").getContext("2d"),r=n&&!s?`500 13px ${t.fontFamily}`:n?`800 13px ${t.fontFamily}`:`600 13px ${t.fontFamily}`,a=`500 11px ${t.fontFamily}`;let c=0;return e.forEach(e=>{const t=e.brand||e.brand_name_zh||e.brand_name||"",s=e.model||e.model_name||"",l=e.condition_name_zh||e.condition||"",d=t||s?`${t} ${s}`:e.name||"";i.font=r;const u=i.measureText(d).width||0;let m=0;if(l){i.font=a;const e=window.innerWidth||document.documentElement.clientWidth||0,t=!n||!o||e<500?l:` - ${l}`;m=i.measureText(t).width||0}c=Math.max(c,u,m)}),c||0}(e,{t:o,integrated:t,isNarrow:he()}),c=r?42:0;if(t){if(n){const e=document.createElement("canvas").getContext("2d");e.font=`500 11px ${o.fontFamily}`;const t=e.measureText("0").width||7,n=7*t,r=7*t,s=8*t,l=8;let d=4;try{const e=v?.querySelector(".legend-fit-grid.is-fit-on .legend-row");if(e){const t=getComputedStyle(e);d=parseFloat(t.columnGap||t.gap||"4")||4}}catch(e){}const u=40+(n+r+l+s+c)+6*d,m=110;let f=u+Math.max(m,a+10)+6;const h=560,p=u+m+6;return f<p&&(f=p),f>h&&(f=h),f>i-24&&(f=Math.min(h,Math.max(p,i-24))),Math.round(f)}{const e=40+c,t=100;let n=e+Math.max(t,a+10)+6;const o=460;return n>o&&(n=o),n>i-24&&(n=Math.max(e+t,i-24)),Math.round(n)}}{const e=20+a+10+12+10+c,t=160,n=320;let o=Math.max(t,Math.min(n,Math.ceil(e)));return o>i-24&&(o=Math.max(t,i-24)),o}}({sList:l,integrated:o,fitOn:u,t:d,baseW:c,hasPlayBtn:!!(o&&u&&q())});if(_.getAttribute("data-last-width")!==String(m)){_.style.width=`${m}px`,o&&(_.style.minWidth="0px");try{e.style.setProperty("--legend-rail-w",`${m}px`)}catch(e){}_.setAttribute("data-last-width",String(m))}}function X(){if(j(),!v)return;const e=xt(),t=tt(),o=he(),i=ut();if(!(i&&Z&&e.length)){const r=e.map(e=>{const n=e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`;return{name:n,brand:e.brand||"",model:e.model||"",condition:e.condition||"",color:e.color,selected:!t||!1!==t[n]}});return v.innerHTML=r.map(e=>{const t=e.brand||e.model?`${e.brand} ${e.model}`:e.name,n=e.selected?"":"is-off";if(o){const o=window.innerWidth||document.documentElement.clientWidth||0;if(i&&o<500)return`\n            <div class="legend-row hoverable-row ${n}" data-name="${e.name}">\n              <span class="dot" style="background:${e.color}"></span>\n              <span class="name has-l2" title="${t}${e.condition?" / "+e.condition:""}">\n                <span class="l1">${t}</span>\n                ${e.condition?`<span class="l2" style="color: var(--text-secondary);">${e.condition}</span>`:""}\n              </span>\n            </div>\n          `;if(i){const o=e.condition?`<span class="cond-inline" style="color: var(--text-secondary);"> - ${e.condition}</span>`:"";return`\n            <div class="legend-row hoverable-row ${n}" data-name="${e.name}">\n              <span class="dot" style="background:${e.color}"></span>\n              <span class="name" title="${t}${e.condition?" / "+e.condition:""}">\n                <span class="l1">${t}</span>${o}\n              </span>\n            </div>\n          `}{const o=e.condition?`<span class="cond-inline"> - ${e.condition}</span>`:"";return`\n            <div class="legend-row hoverable-row ${n}" data-name="${e.name}">\n              <span class="dot" style="background:${e.color}"></span>\n              <span class="name" title="${t}${e.condition?" / "+e.condition:""}">\n                <span class="l1">${t}</span>${o}\n              </span>\n            </div>\n          `}}return`\n          <div class="legend-row hoverable-row ${n}" data-name="${e.name}">\n            <span class="dot" style="background:${e.color}"></span>\n            <span class="name has-l2" title="${t}${e.condition?" / "+e.condition:""}">\n              <span class="l1">${t}</span>\n              ${e.condition?`<span class="l2">${e.condition}</span>`:""}\n            </span>\n          </div>\n        `}).join(""),void v.querySelectorAll(".legend-row").forEach(e=>{const t=e.getAttribute("data-name")||"";e.addEventListener("click",()=>{if(!t||!n)return;Mt();const o=tt(),i=!o||!1!==o[t],r=i?"legendUnSelect":"legendSelect";e.classList.toggle("is-off",i);try{n.dispatchAction({type:r,name:t})}catch(e){}if(u&&d)try{d.dispatchAction({type:r,name:t})}catch(e){}Z&&Et()}),e.addEventListener("mouseenter",()=>{if(t&&n)try{n.dispatchAction({type:"highlight",seriesName:t})}catch(e){}}),e.addEventListener("mouseleave",()=>{if(t&&n)try{n.dispatchAction({type:"downplay",seriesName:t})}catch(e){}})})}const r=`\n    <div class="integrated-fit-head is-active">\n      <div class="title">\n        ${Q} 拟合当前位置\n        <input id="fitXInputLegend" type="number" step="1" />\n        <span id="fitXUnitLegend" class="unit"></span>\n      </div>\n      <button id="fitCloseBtnLegend" class="btn-close-top integrated" type="button" aria-label="关闭"></button>\n    </div>\n  `;v.innerHTML=`\n    <div class="legend-integrated-wrapper fit-on">\n      ${r}\n      <div class="legend-fit-grid is-fit-on"></div>\n    </div>\n  `;const a=v.querySelector("#fitCloseBtnLegend");a&&a.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Mt(),Z=!1;const t=ie("fitButtons"),o=t?t.querySelector("#btnFit"):null;o&&o.classList.remove("active"),De(!1),dt(),Oe(),Et(),W();try{n&&n.resize()}catch(e){}})}function V(){if(!v)return;const e=tt();v.querySelectorAll(".legend-row").forEach(t=>{const n=t.getAttribute("data-name"),o=!e||!1!==e[n];t.classList.toggle("is-off",!o)})}function U(){j(),X(),W();const e=ie("fitButtons");if(e&&x&&e.parentElement!==x)try{x.appendChild(e)}catch(e){}}function G(){try{const e=getComputedStyle(document.documentElement).getPropertyValue("--transition-speed").trim();if(!e)return 250;if(e.endsWith("ms"))return Math.max(0,parseFloat(e));if(e.endsWith("s"))return Math.max(0,1e3*parseFloat(e));const t=parseFloat(e);return Number.isFinite(t)?t:250}catch(e){return 250}}let K={left:0,top:0,width:0,height:0},J=null,Y=0;const Q="PCHIP";let Z=!0,ee=!1;const te={rpm:null,noise_db:null},ne={rpm:new Map,noise_db:new Map};function oe(e){oe._s||(oe._s=new Set),oe._s.has(e)||(oe._s.add(e),console.warn(e))}function ie(e){if(!e)return null;let n=null;if(t&&"function"==typeof t.querySelector)try{n=t.querySelector("#"+e)}catch(e){}return n||document.getElementById(e)}function re(e){t?t.appendChild(e):document.body.appendChild(e)}function ae(){if(!t||!t.getBoundingClientRect)return{left:0,top:0,width:0,height:0};const e=t.getBoundingClientRect();return{left:Math.round(e.left),top:Math.round(e.top),width:Math.round(e.width),height:Math.round(e.height)}}function se(){K=ae()}function ce(e=800){const t=performance.now()+Math.max(0,0|e);if(Y=Math.max(Y,t),!J){const e=()=>{J=null;const t=performance.now(),n=ae();if(n.left!==K.left||n.top!==K.top||n.width!==K.width||n.height!==K.height){K=n;try{He(),Oe(),D()}catch(e){}}t<Y?J=requestAnimationFrame(e):Y=0};J=requestAnimationFrame(e)}}function le(){!n&&t&&(window.echarts?(echartsReady=!0,n=echarts.init(t,null,{renderer:"canvas",devicePixelRatio:window.devicePixelRatio||1}),!me&&t&&"undefined"!=typeof ResizeObserver&&(me=new ResizeObserver(e=>{for(const t of e){const e=t.contentRect||{};if(n&&e.width>0&&e.height>0){ht.run("spectrum",500),se(),ce(900);const e=he();if(null===a&&(a=e),e!==a){a=e;try{i?be(i):n.resize()}catch(e){}ft.mark("spectrum","legend","railPark","dock");continue}try{n.resize()}catch(e){}try{u&&d&&d.resize()}catch(e){}try{if(r){const{x:e,y:t,visible:n}=Se(r);Ie(e,t,n&&!r.__empty)}}catch(e){}ft.mark("fitUI","pointer","axisSwitch","spectrum","legend","dock")}}}),me.observe(t)),function(){window.addEventListener("resize",ue,{passive:!0});let e=null;window.addEventListener("scroll",()=>{e||(e=requestAnimationFrame(()=>{e=null;try{He(),D()}catch(e){}}))},{passive:!0,capture:!0}),function(){const e=()=>{(()=>{try{He(),Oe(),D()}catch(e){}})(),ce(900)},t=document.getElementById("sidebar");if(t){["transitionrun","transitionstart","transitionend"].forEach(n=>{t.addEventListener(n,e,{passive:!0})});try{new MutationObserver(e).observe(t,{attributes:!0,attributeFilter:["class","style"]})}catch(e){}}const n=document.getElementById("main-panels");if(n){["transitionrun","transitionstart","transitionend"].forEach(t=>{n.addEventListener(t,e,{passive:!0})});try{new MutationObserver(e).observe(n,{attributes:!0,attributeFilter:["class","style"]})}catch(e){}}}(),document.addEventListener("fullscreenchange",async()=>{Mt(),s=!!document.fullscreenElement;const e=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||document.documentElement;if(de(),Re=!1,window.visualViewport){try{window.visualViewport.removeEventListener("resize",ue)}catch(e){}if(s)try{window.visualViewport.addEventListener("resize",ue,{passive:!0})}catch(e){}}try{n&&n.dispatchAction({type:"hideTip"})}catch(e){}try{d&&d.dispatchAction({type:"hideTip"})}catch(e){}if(!s){c&&(c.style.marginTop="0px");try{e.removeAttribute("data-chart-mode")}catch(e){}if(t)try{t.style.minHeight=""}catch(e){}try{c&&(c.style.removeProperty("max-height"),c.style.removeProperty("flex"),c.style.removeProperty("--fs-spec-h"))}catch(e){}if(screen.orientation&&screen.orientation.unlock)try{screen.orientation.unlock()}catch(e){}}we(),i?be(i):n&&n.resize(),requestAnimationFrame(()=>{try{At.onFullscreenChange(s),He(),Oe(),Qe(),W(),U(),dt(),B(),D(),n&&n.resize(),d&&d.resize()}catch(e){}})},{passive:!0})}(),n.on("legendmouseover",e=>{if(u&&d&&e&&e.name)try{d.dispatchAction({type:"highlight",seriesName:e.name})}catch(e){}}),n.on("legendmouseout",e=>{if(u&&d&&e&&e.name)try{d.dispatchAction({type:"downplay",seriesName:e.name})}catch(e){}}),n.on("highlight",e=>{if(u&&d&&e&&e.seriesName)try{d.dispatchAction({type:"highlight",seriesName:e.seriesName})}catch(e){}}),n.on("downplay",e=>{if(u&&d&&e&&e.seriesName)try{d.dispatchAction({type:"downplay",seriesName:e.seriesName})}catch(e){}}),n.on("dataZoom",()=>{Je(),ft.mark("pointer"),Z&&ft.mark("fitUI"),b||ht.active("spectrum")||At.onXQueryChange(te[Ae(i)])}),se(),ee||(qe(),ee=!0,De(Z),He(),requestAnimationFrame(Oe))):echartsReady=!1)}function de(){const e=document.getElementById("fitBubble");if(!e)return;const t=document.fullscreenElement||null||document.body;if(e.parentElement!==t)try{t.appendChild(e)}catch(e){}e.style.position="fixed"}function ue(){if(!n)return;ht.run("spectrum",500),we();const e=he();if(null===a&&(a=e),ce(900),e!==a)a=e,i?be(i):n.resize();else{n.resize();try{u&&Ct()}catch(e){}try{u&&d&&d.resize()}catch(e){}if(r){const{x:e,y:t,visible:n}=Se(r);Ie(e,t,n&&!r.__empty)}ft.mark("fitUI","pointer")}ft.mark("spectrum","legend","railPark","dock","axisSwitch"),function(){if(!(s&&u&&c))return;const e=at();e>0&&(c.style.setProperty("max-height",e+"px"),c.style.setProperty("--fs-spec-h",e+"px"))}()}document.createElement("canvas").getContext("2d");let me=null;function fe(){return/Mobi|Android|iPhone|iPad|iPod/i.test(navigator.userAgent)||window.matchMedia&&window.matchMedia("(pointer:coarse)").matches}function he(){const e=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||document.documentElement,n=e&&e.getBoundingClientRect&&Math.floor(e.getBoundingClientRect().width)||window.innerWidth||0,o=Math.max(0,Math.floor(M/2));let i;return i=!0===a?n<E+o:!1===a?n<E-o:n<E,s&&fe()&&(i=!1),i}function pe(){if(!l)return null;const e=l.querySelector(".spectrum-res-switch");if(e&&!e.classList.contains("is-slider-type"))try{e.remove()}catch(e){}let t=l.querySelector(".spec-switch-container");if(!t){const e=document.createElement("div");e.className="spectrum-res-switch is-slider-type",e.style.display="flex",e.style.alignItems="center",e.style.gap="8px",e.style.position="absolute",e.style.zIndex="200",t=document.createElement("div"),t.className="spec-switch-container",t.innerHTML='\n      <div class="spec-switch-track">\n        <div class="spec-switch-strip" id="specResSlider">\n          <div class="spec-item">1/48</div>\n          <div class="spec-item">1/12</div>\n          <div class="spec-item">1/3</div>\n        </div>\n      </div>\n    ',e.appendChild(t),l.insertBefore(e,l.firstChild),function(e){const t=e.querySelector("#specResSlider");if(!t)return;const n=["1_48","1_12","1_3"];let o=36,i=72,r=0,a=!1,s=!1,c=0,m=0,f=null;function h(){const e=N(),t=n.indexOf(e);return t>=0?t:0}function p(){i=e.offsetWidth||72;const n=t.querySelector(".spec-item");n&&(o=n.offsetWidth||36),r=(i-o)/2}function y(e){const n=t.querySelectorAll(".spec-item");if(!n.length)return;const r=i/2-e;n.forEach((e,t)=>{const n=t*o+o/2,i=Math.abs(n-r);let a=.6,s=.4;if(i<1.2*o){const e=i/(1.2*o);a=1-.4*e,s=1-.6*e}e.style.transform=`scale(${a.toFixed(3)})`,e.style.opacity=s.toFixed(2)})}function w(e=!0){const n=h(),i=r-n*o;t.style.transition=e?"transform .25s cubic-bezier(0.25, 0.1, 0.25, 1)":"none",t.style.transform=`translateX(${i}px)`,m=i,y(i)}function b(e){const t=Math.max(0,Math.min(n.length-1,e));!function(e){const t=String(e||"").trim();if(["1_3","1_12","1_48"].includes(t)&&t!==g){if(g=t,l){const e=l.querySelector(".spec-switch-container");e&&ye(e)}try{u&&d&&ot(!0)}catch(e){}}}(n[t]),p(),w(!0),setTimeout(Ct,0)}function _(e){if(a){a=!1;try{null!=f&&t.releasePointerCapture(f)}catch(e){}if(f=null,s){const e=window.getComputedStyle(t),n=new DOMMatrix(e.transform).m41;b(Math.round((r-n)/o))}else{let e=h();e=(e+1)%n.length,b(e)}}}e.addEventListener("pointerdown",function(e){if(void 0!==e.button&&0!==e.button)return;p(),a=!0,s=!1,c=e.clientX,f=e.pointerId??null,t.style.transition="none";const n=window.getComputedStyle(t);m=new DOMMatrix(n.transform).m41,y(m);try{null!=f&&t.setPointerCapture(f)}catch(e){}e.preventDefault?.()}),window.addEventListener("pointermove",function(e){if(!a)return;const i=e.clientX-c;!s&&Math.abs(i)>2&&(s=!0);let l=m+i;const d=r-(n.length-1)*o-24,u=r+24;l>u&&(l=u+.3*(l-u)),l<d&&(l=d+.3*(l-d)),t.style.transform=`translateX(${l}px)`,y(l)},{passive:!0}),window.addEventListener("pointerup",_,{passive:!0}),window.addEventListener("pointercancel",_),requestAnimationFrame(()=>{p(),w(!1)}),e.__updatePos=()=>{p(),w(!0)}}(t),requestAnimationFrame(Ct)}return ye(t),t}function ye(e){e&&e.__updatePos&&e.__updatePos()}function ge(){if(c&&c.isConnected){let e=c.querySelector(".spectrum-inner");e||(e=document.createElement("div"),e.className="spectrum-inner",c.appendChild(e));try{e.style.position="relative",e.style.width="100%",e.style.overflow="visible"}catch(e){}return l=e,c}let e=document.getElementById("spectrumHost");e||(e=document.createElement("div"),e.id="spectrumHost");const n=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||document.body;let o=n&&n.querySelector(".chart-stack");!o&&t&&t.parentElement&&(o=document.createElement("div"),o.className="chart-stack",t.parentElement.insertBefore(o,t),o.appendChild(t),n&&o.parentElement!==n&&n.insertBefore(o,n.firstChild)),o&&e.parentElement!==o?o.appendChild(e):!o&&t&&e.parentElement!==t.parentElement&&t.parentElement?.insertBefore(e,t.nextSibling);let i=e.querySelector(".spectrum-inner");i||(i=document.createElement("div"),i.className="spectrum-inner",e.appendChild(i));try{i.style.position="relative",i.style.width="100%",i.style.overflow="visible"}catch(e){}c=e,l=i;try{pe()}catch(e){}return e}function we(){const e=document.fullscreenElement;s=!!e,requestAnimationFrame(()=>{try{n&&n.resize()}catch(e){}try{u&&d&&d.resize()}catch(e){}})}function be(e){if(Mt(),i=e||i,!t)return void oe("[ChartRenderer] 请先调用 mount(rootEl)");if(!window.echarts)return void requestAnimationFrame(()=>be(i));if(le(),!n)return;bt++;try{_t=Array.isArray(i?.chartData?.series)?i.chartData.series:[],vt=bt}catch(e){_t=[]}!function(e){const t=he();bt===St.epoch&&t===St.isNarrow||(St.epoch=bt,St.isNarrow=t,St.rpm=Pe(e,"rpm"),St.noise_db=Pe(e,"noise_db"))}(_t);const o=Ae(i),l=!(!r||!r.__empty);!function(e){const t=String(e||"light").toLowerCase();document.documentElement.setAttribute("data-theme",t)}(i&&i.theme||"light"),!ee&&Z&&(qe(),ee=!0);const m=function(e){const{theme:o}=e||{},r=_e(o||"light"),a=xt(),l=Ae(e),m=he(),f=e&&e.chartBg||lt(),h=s?f:"transparent",p=G();if(!a.length)return Mt(),De(!1),{__empty:!0,backgroundColor:h,title:{text:"请 先 添 加 数 据",left:"center",top:"middle",textStyle:{color:r.axisLabel,fontFamily:r.fontFamily,fontSize:20,fontWeight:600}},toolbox:{show:!1},tooltip:{show:!1,triggerOn:"none"}};const y=St["noise"===(S=l)?"noise_db":S]||Pe(a,l),g="rpm"===l?"转速(RPM)":"噪音(dB)",w="rpm"===l?"转速":"噪音",b=`${w}${xe}风量曲线`,_=ve(b,20,600,r.fontFamily),v=Math.max(54,10+Math.ceil(_.height)+12),x={show:!1,data:a.map(e=>e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`)};var S;try{const e=n?.getOption?.().legend?.[0]?.selected;e&&(x.selected=e)}catch(e){}const A=[];if(y.series.forEach(e=>A.push(e)),Z){Xe(a,l);const e=function(e){const t=Math.round(e/20);return Math.max(20,Math.min(50,t))}(Math.max(300,n.getWidth?n.getWidth():800)),t=m?.75:1.5;a.forEach(n=>{const o=n.name||`${n.brand||""} ${n.model||""} - ${n.condition||""}`,i=ne[l].get(o);if(!i||null==i.x0||null==i.x1)return;const r=Math.min(i.x0,i.x1),a=Math.max(i.x0,i.x1),s=Math.max(y.xMin,r),c=Math.min(y.xMax,a);if(!(c>s))return;const d=function(e,t,n,o){const i=Math.max(2,0|o),r=[],a=Math.min(e.x0,e.x1),s=Math.max(e.x0,e.x1),c=Math.max(t,a),l=Math.min(n,s);if(!(l>c))return r;for(let t=0;t<i;t++){const n=c+(l-c)*(1===i?0:t/(i-1)),o=Ue(e,n);r.push({x:n,y:Number.isFinite(o)?o:NaN})}return r}(i,s,c,e);A.push({id:`fit-line:${l}:${o}`,name:o,type:"line",smooth:!1,showSymbol:!1,connectNulls:!1,data:d.map(e=>[e.x,e.y]),lineStyle:{width:t,type:"dashed",color:n.color,opacity:.75},itemStyle:{color:n.color},legendHoverLink:!0,emphasis:{focus:"series",blurScope:"coordinateSystem",lineStyle:{width:t*Ce,opacity:.9},itemStyle:{opacity:1}},blur:{lineStyle:{opacity:.15},itemStyle:{opacity:.15}},silent:!1,tooltip:{show:!1},z:3})})}const L=Math.max(Ee,y.xMin),E=1.2*y.xMax;let M=Math.floor(L),C=Math.ceil(E);C>M||(C=M+1);const k={show:!0,title:"导出为图片",icon:"path://M12 2v10m0 0 4-4m-4 4-4-4M4 20h16v2H4z",onclick:()=>{try{!async function(){if(!n)return;try{n.dispatchAction({type:"hideTip"})}catch(e){}try{d&&d.dispatchAction({type:"hideTip"})}catch(e){}try{n.resize()}catch(e){}try{u&&d&&d.resize()}catch(e){}await new Promise(e=>requestAnimationFrame(()=>setTimeout(e,0)));const e=lt(),t=window.devicePixelRatio||1,o=_e(i&&i.theme||document.documentElement.getAttribute("data-theme")||"light"),r=n.getDataURL({pixelRatio:t,backgroundColor:e,excludeComponents:[]});let a=null;if(u&&d)try{a=d.getDataURL({pixelRatio:t,backgroundColor:e,excludeComponents:[]})}catch(e){}const s=e=>new Promise((t,n)=>{if(!e)return t(null);const o=new Image;o.onload=()=>t(o),o.onerror=n,o.crossOrigin="anonymous",o.src=e}),c=await s(r),l=await s(a);if(!c)return;const m=c.width/t,f=c.height/t,h=l?l.width/t:0,p=l?l.height/t:0,y=Math.max(m,h),g=16,w=f+(l?24+p:0),b=function(){const e=xt(),t=tt();return e.map(e=>{const n=e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`,o=e.brand||"",i=e.model||"",r=o||i?`${o} ${i}`.trim():n,a=e.condition||"",s=!t||!1!==t[n];return{id:n,color:e.color||"#888",line1:r,line2:a,selected:s}})}(),_=function(e,t){const n=`600 13px ${t.fontFamily}`,o=`500 11px ${t.fontFamily}`;let i=0,r=0;return e.forEach(e=>{const n=ve(e.line1||"",13,600,t.fontFamily).width;let o=0;e.line2&&(o=ve(e.line2,11,500,t.fontFamily).width),i=Math.max(i,n,o);const a=e.line2?38:22;r+=a+8}),e.length>0&&(r-=8),{colW:Math.min(360,Math.max(160,Math.ceil(30+i+10))),totalH:r,line1H:22,line2H:16,itemGap:8,dotW:12,gapDotText:8,padX:10,line1Font:n,line2Font:o}}(b,o),v=_.colW,x=_.totalH,S=g+y+24+v+g,A=g+Math.max(w,x)+16,L=document.createElement("canvas");L.width=Math.max(1,Math.round(S*t)),L.height=Math.max(1,Math.round(A*t));const E=L.getContext("2d");E.scale(t,t),E.fillStyle=e,E.fillRect(0,0,S,A);let M=g;E.drawImage(c,16,M,m,f),M+=f,l&&(M+=24,E.drawImage(l,16,M,h,p));let C=g+y+24,k=g;E.textBaseline="alphabetic",b.forEach(e=>{const t=e.selected?e.color||"#888":"rgba(128,128,128,.35)";E.fillStyle=t;const n=_.dotW/2;E.beginPath(),E.arc(C+n+_.padX,k+n+2,n,0,2*Math.PI),E.fill();const i=C+_.padX+_.dotW+_.gapDotText,r=k+_.line1H-6;E.font=_.line1Font,E.fillStyle=e.selected?o.tooltipText:"rgba(0,0,0,.55)",E.fillText(e.line1||"",i,r);let a=_.line1H;if(e.line2){E.font=_.line2Font;const t=k+_.line1H+_.line2H-6,n=getComputedStyle(document.documentElement).getPropertyValue("--text-muted").trim();E.fillStyle=n||"#6b7280",E.fillText(e.line2,i,t),a=_.line1H+_.line2H}k+=a+_.itemGap});const P=document.createElement("a");P.download="charts-all.png",P.href=L.toDataURL("image/png"),P.click()}()}catch(e){console.warn("导出失败",e)}}},P={show:!0,title:Z?"关闭拟合":"实时拟合",icon:"path://M2 18 L8 12 L12 16 L22 6 L22 9 L12 19 L8 15 L2 21 Z",onclick:()=>{try{n&&n.dispatchAction({type:"hideTip"})}catch(e){}Mt(),Z=!Z,De(Z),He(),Oe(),Et(),W(),dt();const e=ie("fitButtons"),t=e?e.querySelector("#btnFit"):null;t&&t.classList.toggle("active",!!Z);try{n&&n.resize()}catch(e){}}},$={show:!0,title:s?"退出全屏":"全屏查看",icon:s?"path://M6 6h2v2H8v2H6V6Zm10 0h2v4h-2V8h-2V6h2Zm2 10v2h-4v-2h2v-2h2v2ZM6 16h2v2h4v2H6v-4z":"path://M4 4h6v2H6v4H4V4Zm10 0h6v6h-2V6h-4V4Zm6 10v6h-6v-2h4v-4h2ZM4 14h2v4h4v2H4v-6z",onclick:()=>{document.fullscreenElement?async function(){try{document.fullscreenElement&&await document.exitFullscreen()}catch(e){console.warn("exitFullscreen 失败：",e)}finally{if(s=!1,de(),Re=!1,t)try{t.style.minHeight=""}catch(e){}try{c&&(c.style.removeProperty("max-height"),c.style.removeProperty("flex"),c.style.removeProperty("--fs-spec-h"))}catch(e){}we(),Qe(),i?be(i):n&&n.resize(),requestAnimationFrame(()=>{try{He(),Oe()}catch(e){}})}}():async function(){const e=document.getElementById("chart-settings")||t&&t.parentElement||t||document.documentElement;try{if(e.requestFullscreen?await e.requestFullscreen():await document.documentElement.requestFullscreen(),s=!0,fe()&&screen.orientation&&screen.orientation.lock)try{await screen.orientation.lock("landscape")}catch(e){}}catch(e){console.warn("requestFullscreen 失败：",e)}finally{de(),Re=!1,we(),i?be(i):n&&n.resize(),requestAnimationFrame(()=>{try{He(),Oe(),Qe(),W(),U()}catch(e){}})}}(),Mt()}},F=m?{restore:{},myFitToggle:P,myExportAll:k,myFullscreen:$}:{dataZoom:{yAxisIndex:"none"},restore:{},myFitToggle:P,myExportAll:k,myFullscreen:$};return{__empty:!1,__titlePrefix:w,backgroundColor:h,color:a.map(e=>e.color),textStyle:{fontFamily:r.fontFamily},stateAnimation:{duration:p,easing:"cubicOut"},animationDurationUpdate:p,animationEasingUpdate:"cubicOut",grid:{left:40,right:30,top:v,bottom:60},title:{text:b,left:"center",top:10,textStyle:{color:r.axisLabel,fontSize:18,fontWeight:600,fontFamily:r.fontFamily}},legend:x,xAxis:{type:"value",name:g,nameLocation:"middle",nameGap:25,nameMoveOverlap:!0,nameTextStyle:{color:r.axisName,fontWeight:600,fontFamily:r.fontFamily,textShadowColor:"rgba(0,0,0,0.28)",textShadowBlur:4,textShadowOffsetY:1},axisLabel:{color:r.axisLabel,fontSize:12,fontFamily:r.fontFamily,margin:10},axisLine:{lineStyle:{color:r.axisLine}},splitLine:{show:!0,lineStyle:{color:r.gridLine}},min:M,max:C},yAxis:{type:"value",name:"风量(CFM)",min:0,max:1.3*y.yMax,nameTextStyle:{color:r.axisName,fontWeight:600,textShadowColor:"rgba(0,0,0,0.28)",textShadowBlur:4,textShadowOffsetY:1},axisLabel:{color:r.axisLabel},axisLine:{lineStyle:{color:r.axisLine}},splitLine:{show:!0,lineStyle:{color:r.gridLine}}},tooltip:$e(r),toolbox:{top:0,right:10,feature:F},dataZoom:[{type:"inside",xAxisIndex:0,throttle:50,zoomOnMouseWheel:!0,moveOnMouseWheel:!0,moveOnMouseMove:!0,filterMode:"none",startValue:M,endValue:.85*C},{type:"inside",yAxisIndex:0,throttle:50,zoomOnMouseWheel:"alt",moveOnMouseWheel:"alt",moveOnMouseMove:!0,filterMode:"none",endValue:y.yMax}],series:A}}(i),f=Ae(i),h=!!m.__empty;if(o!==f||l!==h)try{n.clear()}catch(e){}if(n.setOption(m,!0),n.resize(),r=m,function(e){try{if(!u||!d)return;const t=r&&r.backgroundColor||(s?lt():"transparent"),n=null!=e?e:t;d.setOption({backgroundColor:n})}catch(e){}}(m.backgroundColor),requestAnimationFrame(()=>Te({force:!0,animate:!1})),m.__empty)try{n.dispatchAction({type:"updateAxisPointer",currTrigger:"leave"})}catch(e){}const{x:p,y,visible:g}=Se(m);if(Ie(p,y,g&&!m.__empty),a=he(),De(Z),He(),dt(),R(),B(),D(),U(),se(),ce(600),u&&!b)try{et(!0)}catch(e){}setTimeout(()=>{b=!1},450);try{const e=()=>{try{n.off("finished",e)}catch(e){}if(Oe(),Qe(),u)try{et(!1)}catch(e){}try{V()}catch(e){}};n.on("finished",e)}catch(e){}requestAnimationFrame(Oe),Z&&Et()}function _e(e){const t="dark"===String(e||"").toLowerCase();return{fontFamily:'system-ui,-apple-system,"Segoe UI","Helvetica Neue","Microsoft YaHei",Arial,sans-serif',axisLabel:t?"#d1d5db":"#4b5563",axisName:t?"#9ca3af":"#6b7280",axisLine:t?"#374151":"#e5e7eb",gridLine:t?"rgba(255,255,255,0.10)":"rgba(0,0,0,0.08)",tooltipBg:"var(--tooltip-bg, var(--bg-bubble))",tooltipBorder:t?"#374151":"#e5e7eb",tooltipText:t?"#f3f4f6":"#1f2937",tooltipShadow:"var(--shadow-lg)",pagerIcon:t?"#93c5fd":"#2563eb"}}function ve(e,t,n,o){const i=`${String(n||400)} ${Number(t||14)}px ${o||"sans-serif"}`;return mt.measure(i,e||"")}const xe="  -  ";function Se(e){if(!n||!e||!e.title)return{x:0,y:0,visible:!1};if(e.__empty)return{x:0,y:0,visible:!1};const t=e.title,o=t.textStyle||{},i=Number(o.fontSize||e.__titleFontSize||14),r=o.fontWeight||e.__titleFontWeight||600,a=o.fontFamily||e.__titleFamily,s=String(e.__titlePrefix||""),c=ve(`${s}${xe}风量曲线`,i,r,a),l=ve(s,i,r,a),d=n.getWidth()/2-c.width/2+l.width/2,u=("number"==typeof t.top?t.top:0)+c.height/2;return{x:Math.round(d),y:Math.round(u),visible:!0}}function Ae(e){return Fe||("noise_db"===e?.chartData?.x_axis_type||"noise"===e?.chartData?.x_axis_type?"noise_db":"rpm")}const Le=-1,Ee=0,Me=1.33,Ce=1.6;function ke(e){return""===e||null==e?NaN:Number(e)}function Pe(e,t){let n=0,o=1/0,i=-1/0;const r=he(),a=r?2:3,s=r?4:8,c=(e||[]).map(e=>{const r=Array.isArray(e?.data?.rpm)?e.data.rpm:[],c=Array.isArray(e?.data?.noise_db)?e.data.noise_db:[],l=Array.isArray(e?.data?.airflow)?e.data.airflow:[],d="noise_db"===t?c:r,u="noise_db"===t?r:c,m=Math.min(d.length,l.length),f=[];for(let e=0;e<m;e++){const t=ke(d[e]),r=Number(l[e]);if(Number.isFinite(r))if(Number.isFinite(t)&&t!==Le){o=Math.min(o,t),i=Math.max(i,t),n=Math.max(n,r);const a=u[e],s=Number.isFinite(Number(a))?Number(a):void 0;f.push({value:[t,r],tip:s})}else f.push({value:[Le,r],tip:void 0,__missingX:!0})}return{name:e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`,type:"line",smooth:!0,connectNulls:!1,showSymbol:!0,symbol:"circle",symbolSize:s,lineStyle:{width:a,color:e.color},itemStyle:{color:e.color},label:{show:!0,position:"top",color:"gray"},labelLayout:{hideOverlap:!0},legendHoverLink:!0,emphasis:{focus:"series",blurScope:"coordinateSystem",lineStyle:{width:a*Me},itemStyle:{borderWidth:1.2,shadowColor:"rgba(0,0,0,0.25)",shadowBlur:8},label:{show:!0}},blur:{lineStyle:{opacity:.18},itemStyle:{opacity:.18},label:{show:!1}},data:f}});o===1/0&&(o=0,i=100),n<=0&&(n=100);const l=Math.max(1,i-o),d=Math.floor(.2*l);return{series:c,xMin:Math.max(o-d,0),xMax:i+d,yMax:Math.ceil(1.4*n)}}function $e(e){return{...yt(e,{appendToBody:!s}),confine:!1,trigger:"item",triggerOn:"mousemove|click|touchstart|touchmove",axisPointer:{type:"cross",label:{color:e.tooltipText}},borderRadius:12,position:function(e,t,n){const o=Array.isArray(e)?e[0]:0,i=Array.isArray(e)?e[1]:0,r=window.innerWidth||document.documentElement.clientWidth||0,a=window.innerHeight||document.documentElement.clientHeight||0,s=n?.offsetWidth||0,c=n?.offsetHeight||0;let l=o+12,d=i+12;return l+s>r-8&&(l=Math.max(8,o-12-s)),d+c>a-8&&(d=Math.max(8,i-12-c)),l<8&&(l=8),d<8&&(d=8),[Math.round(l),Math.round(d)]},formatter:function(e){const t=Ae(i),n="rpm"===t?"RPM, ":"dB, ",o="rpm"===t?"dB":"RPM",r=e.value?.[0],a=e.value?.[1],s=e.data?.tip??"";return`<span style="display:inline-block;width:12px;height:12px;border-radius:50%;background:${e.color};margin-right:4px;"></span>${e.seriesName}<br/>&nbsp;&nbsp;&nbsp;&nbsp;${a}CFM @${r}${n}${s}${o}`}}}let Fe=null;function Ne(){let e=ie("chartXAxisOverlay");return e||(e=document.createElement("div"),e.id="chartXAxisOverlay",e.className="chart-xaxis-overlay",e.setAttribute("aria-label","X轴切换"),e.innerHTML='\n        <div class="switch-container" id="xAxisSwitchContainer">\n          <div class="switch-track" id="xAxisSwitchTrack">\n            <div class="switch-slider" id="xAxisSwitchSlider">\n              <span class="switch-label switch-label-right">转速</span>\n              <span class="switch-label switch-label-left">噪音</span>\n            </div>\n          </div>\n        </div>',re(e),e.style.position="absolute",function(){const e=ie("xAxisSwitchTrack"),t=ie("xAxisSwitchSlider");if(!e||!t)return;let n=0,r=0,a=0,s=!1,c=!1,l=0,m=0,f=null;try{e.setAttribute("role","switch"),e.setAttribute("aria-checked",String("rpm"!==Ae(i)))}catch(e){}function h(){n=t.offsetWidth||0,r=e.offsetWidth||0,a=Math.max(0,r-n)}function p(n,o=!0){const i="noise_db"===n||"noise"===n,r=i?a:0;t.style.transition=o?"transform .25s ease":t.style.transition||"",t.style.transform=`translateX(${r}px)`,e.setAttribute("aria-checked",String(i))}function y(e){const t="noise"===e?"noise_db":e;if(("rpm"===t||"noise_db"===t)&&Fe!==t){Mt(),Fe=t;try{localStorage.setItem("x_axis_type",t)}catch(e){}if(p(t,!0),b=!0,i&&be(i),u&&d)try{ot(!0),Ct()}catch(e){}if("function"==typeof o)try{o(t)}catch(e){}}}function g(){if(s){s=!1;try{null!=f&&t.releasePointerCapture(f)}catch(e){}f=null,p(Ae(i),!0)}}e.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),c)return void(c=!1);const t="rpm"===Ae(i)?"noise_db":"rpm";p(t,!0),y(t)}),e.addEventListener("pointerdown",function(e){if(void 0!==e.button&&0!==e.button)return;h(),s=!0,c=!1,f=e.pointerId??null,l=e.clientX;const n=new DOMMatrix(getComputedStyle(t).transform);m=n.m41||0,t.style.transition="none";try{null!=f&&t.setPointerCapture(f)}catch(e){}e.preventDefault?.()}),window.addEventListener("pointermove",function(e){if(!s)return;const n=e.clientX-l;!c&&Math.abs(n)>2&&(c=!0);let o=m+n;o=Math.max(0,Math.min(o,a)),t.style.transform=`translateX(${o}px)`},{passive:!0}),window.addEventListener("pointerup",function(){if(!s)return;s=!1;try{null!=f&&t.releasePointerCapture(f)}catch(e){}f=null;const e=(new DOMMatrix(getComputedStyle(t).transform).m41||0)>a/2?"noise_db":"rpm";p(e,!0),y(e)},{passive:!0}),window.addEventListener("pointercancel",g),window.addEventListener("blur",g),h(),p(Ae(i),!1),window.addEventListener("resize",()=>{const e=Ae(i);h(),p(e,!1)},{passive:!0})}(),requestAnimationFrame(()=>Te({force:!0,animate:!1}))),e}function Te(e={}){const{animate:t=!1}=e,n=ie("xAxisSwitchTrack"),o=ie("xAxisSwitchSlider");if(!n||!o)return;const r=o.offsetWidth||0,a=n.offsetWidth||0,s=Math.max(0,a-r),c="noise_db"===Ae(i);t&&(o.style.transition="transform .25s ease"),o.style.transform=`translateX(${c?s:0}px)`,n.setAttribute("aria-checked",String(c))}function Ie(e,t,n){const o=Ne(),i=window.__FS_TOGGLE_OFFSET||{x:0,y:0};o.style.left=e+(Number(i.x)||0)+"px",o.style.top=t+(Number(i.y)||0)+"px",o.style.visibility=n?"visible":"hidden",requestAnimationFrame(()=>Te({force:!0,animate:!1}))}function qe(){let e=ie("fitButtons");if(!e){e=document.createElement("div"),e.id="fitButtons",e.className="fit-buttons",e.innerHTML='\n      <button class="btn" id="btnFit" type="button">实时拟合</button>\n    ',re(e);const c=e.querySelector("#btnFit");function o(){c.classList.toggle("active",Z)}c.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Mt(),Z=!Z,Re=!1,Be.left=null,Be.top=null,o(),De(Z),He(),Oe(),Et(),W(),dt();try{n&&n.resize()}catch(e){}}),o()}let a=ie("fitPointer");a||(a=document.createElement("div"),a.id="fitPointer",a.className="fit-pointer",a.innerHTML='<div class="line"></div><div class="handle" id="fitPointerHandle"></div>',re(a),function(){const e=ie("fitPointerHandle");if(!e)return;let o=0;pt(e,{axis:"x",threshold:2,onStart:t=>{const n=ie("fitPointer");o=parseFloat(n?.style.left||"0"),e.style.cursor="grabbing"},onMove:({dx:e})=>{const a=function(){if(!r)return{left:40,right:n?n.getWidth()-260:800,top:60,height:300};const e=r.grid||{left:40,right:260,top:60,bottom:40},o=n?n.getWidth():t?t.clientWidth:800,i=n?n.getHeight():t?t.clientHeight:600,a="number"==typeof e.left?e.left:40,s="number"==typeof e.right?e.right:260,c="number"==typeof e.top?e.top:60;return{left:a,right:o-s,top:c,height:i-c-("number"==typeof e.bottom?e.bottom:40)}}();let s=o+e;s=Math.max(a.left,Math.min(s,a.right)),ie("fitPointer").style.left=s+"px";const c=function(e){try{return n.convertFromPixel({xAxisIndex:0},e)}catch(e){return NaN}}(s),l=Ae(i);Number.isFinite(c)&&(Mt(),te[l]=Ge(c),ze(),Z&&Et(),At.onXQueryChange(te[l]))},onEnd:()=>{e.style.cursor="grab"}})}());let s=ie("fitBubble");if(!s){s=document.createElement("div"),s.id="fitBubble",s.className="fit-bubble",s.innerHTML='\n     <div class="head">\n       <div class="title">\n         PCHIP 拟合当前位置\n         <input id="fitXInput" type="number" step="1" />\n         <span id="fitXUnit"></span>\n       </div>\n       <button id="fitCloseBtn" class="btn-close-top" type="button" aria-label="关闭">×</button>\n     </div>\n     <div id="fitBubbleRows"></div>\n     <div class="foot">\n       <div class="hint">按系列可见性（Legend）过滤，按风量从大到小排序</div>\n     </div>\n   ',document.body.appendChild(s),s.style.position="fixed",de(),function(e){if(!e)return;pt(e,{axis:"both",threshold:4,onStart:n=>{if(n.target&&n.target.closest("input, textarea, select, button, [contenteditable]"))return!1;const o=e.getBoundingClientRect();e.__baseLeftFixed=o.left,e.__baseTopFixed=o.top,e.__rootRectStart=t?t.getBoundingClientRect():{left:0,top:0},e.classList.add("dragging")},onMove:({dx:n,dy:o})=>{const i=window.innerWidth,r=window.innerHeight,a=e.offsetWidth||0,s=e.offsetHeight||0;let c=e.__baseLeftFixed+n,l=e.__baseTopFixed+o;c=Math.min(Math.max(6-a,c),Math.max(6,i-6)),l=Math.min(Math.max(6-s,l),Math.max(6,r-6)),e.style.left=Math.round(c)+"px",e.style.top=Math.round(l)+"px",e.style.right="auto",e.style.bottom="auto";const d=e.__rootRectStart||(t?t.getBoundingClientRect():{left:0,top:0});Be.left=c-d.left,Be.top=l-d.top,Re=!0},onEnd:()=>{e.classList.remove("dragging")}})}(s);const l=s.querySelector("#fitXInput");l.addEventListener("input",je),l.addEventListener("change",We),l.addEventListener("keydown",e=>{"Enter"===e.key&&We()});const d=ie("fitButtons"),u=d?d.querySelector("#btnFit"):null,m=s.querySelector("#fitCloseBtn");m&&m.addEventListener("click",e=>{e.preventDefault(),e.stopPropagation(),Mt(),Z=!1,u&&u.classList.remove("active"),De(!1),dt(),Oe(),Et(),W();try{n&&n.resize()}catch(e){}})}}let Re=!1;const Be={left:null,top:null};function De(e){const t=ie("fitButtons"),n=ie("fitPointer"),o=!r||r.__empty,i=ut(),a=t?t.querySelector("#btnFit"):null;if(a&&(e?(a.classList.add("active"),a.style.backgroundColor="",a.style.color=""):(a.classList.remove("active"),a.style.backgroundColor="var(--fit-btn-bg)",a.style.color="var(--fit-btn-fg)"),a.style.width="100%"),t&&(t.style.visibility=o?"hidden":"visible"),i)Lt(!1,{immediate:!0}),n&&(n.style.visibility=e&&!o?"visible":"hidden"),X();else{const t=e&&!o;Lt(t),n&&(n.style.visibility=t?"visible":"hidden")}dt()}function He(){const e=ie("fitButtons"),n=ie("fitBubble");if(!r)return;const o=ut();if(e&&x)e.style.position="static",e.style.right="",e.style.bottom="",e.style.visibility=r.__empty?"hidden":"visible";else if(e&&!o){const t=he();e.style.flexDirection=t?"column":"row",s?(e.style.position="fixed",e.style.right="12px",e.style.bottom="12px"):(e.style.position="absolute",e.style.right="10px",e.style.bottom="10px"),e.style.visibility=r.__empty?"hidden":"visible"}const a="rpm"===Ae(i)?"RPM":"dB";if(!o&&n){const e=t?t.getBoundingClientRect():{left:0,top:0},o=r.grid||{left:40,top:60},i="number"==typeof o.left?o.left:40,s="number"==typeof o.top?o.top:60;let c,l;Re&&null!=Be.left&&null!=Be.top?(c=Be.left,l=Be.top):(c=i,l=s,Be.left=c,Be.top=l);const d=e.left+c,u=e.top+l;n.style.position="fixed",n.style.left=Math.round(d)+"px",n.style.top=Math.round(u)+"px",n.style.right="auto",n.style.bottom="auto",Z&&!r.__empty?(n.classList.add("is-visible"),n.style.visibility="visible"):Lt(!1);const m=n.querySelector("#fitXUnit");m&&(m.textContent=a)}if(o){const e=ie("fitXUnitLegend");e&&(e.textContent=a)}}function Oe(){const e=ie("fitPointer");if(!e||!r)return;if(!Z||r.__empty)return void(e.style.visibility="hidden");const o=r.grid||{left:40,right:260,top:60,bottom:40},a=(n?n.getWidth():t&&t.clientWidth,n?n.getHeight():t?t.clientHeight:600),s=("number"==typeof o.left&&o.left,"number"==typeof o.right&&o.right,"number"==typeof o.top?o.top:60),c=a-s-("number"==typeof o.bottom?o.bottom:40),l=Ae(i);if(null==te[l]){const[e,t]=Ke();te[l]=(e+t)/2}Je();const d=function(e){try{return n.convertToPixel({xAxisIndex:0},e)}catch(e){return NaN}}(te[l]);Number.isFinite(d)?(e.style.position="absolute",e.style.left=d+"px",e.style.top=s+"px",e.style.height=c+"px",e.style.visibility="visible",ze(),Z&&Et()):e.style.visibility="hidden"}function ze(){const e=ie("fitXInput");if(!e)return;const t=Ae(i),n=Number(te[t]),o="noise_db"===t?Number(n.toFixed(1)):Math.round(n);e.value=String(o);const[r,a]=Ke();e.setAttribute("min",String(Math.floor(r))),e.setAttribute("max",String(Math.ceil(a))),e.setAttribute("step","noise_db"===t?"0.1":"1")}function je(){const e=ie("fitXInput");if(!e)return;const t=Ae(i),n=Number(e.value);Number.isFinite(n)&&(te[t]=n)}function We(){const e=ie("fitXInput");if(!e)return;const t=Ae(i),n=Number(e.value);Number.isFinite(n)&&(te[t]=Ge(n),Je());const o=Number(te[t]);if(Number.isFinite(o)){const n="noise_db"===t?Number(o.toFixed(1)):Math.round(o);e.value=String(n)}Mt(),Oe(),Et(),At.onXQueryChange(te[t])}function Xe(e,t){const n=ne[t];e.forEach(e=>{const o=e&&e.pchip?"noise_db"===t?e.pchip.noise_to_airflow:e.pchip.rpm_to_airflow:null,i=e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`;o&&Array.isArray(o.x)&&Array.isArray(o.y)&&Array.isArray(o.m)&&null!=o.x0&&null!=o.x1?n.set(i,o):n.delete(i)})}const Ve=new WeakMap;function Ue(e,t){if(!(e&&Array.isArray(e.x)&&Array.isArray(e.y)&&Array.isArray(e.m)))return NaN;const n=Math.round(1e3*t)/1e3,o=function(e){let t=Ve.get(e);return t||(t=new Map,Ve.set(e,t)),t}(e);if(o.has(n))return o.get(n);const i=e.x,r=e.y,a=e.m,s=i.length;if(0===s)return NaN;if(1===s){const e=r[0];return o.set(n,e),e}let c=n;c<=i[0]&&(c=i[0]),c>=i[s-1]&&(c=i[s-1]);let l=0,d=s-2,u=0;for(;l<=d;){const e=l+d>>1;if(i[e]<=c&&c<=i[e+1]){u=e;break}c<i[e]?d=e-1:l=e+1}l>d&&(u=Math.max(0,Math.min(s-2,l)));const m=i[u],f=i[u+1]-m||1,h=(c-m)/f,p=r[u],y=r[u+1],g=(2*h*h*h-3*h*h+1)*p+(h*h*h-2*h*h+h)*(a[u]*f)+(-2*h*h*h+3*h*h)*y+(h*h*h-h*h)*(a[u+1]*f);if(o.size>=256){const e=o.keys().next();e&&!e.done&&o.delete(e.value)}return o.set(n,g),g}function Ge(e){if(!r)return e;const t=r.xAxis||{},n=Number(t.min),o=Number(t.max);return Number.isFinite(n)&&Number.isFinite(o)?Math.max(n,Math.min(e,o)):e}function Ke(){if(!r)return[0,1];const e=r.xAxis||{},t=Number(e.min),o=Number(e.max);let i=t,a=o;const s=((n.getOption()||{}).dataZoom||[]).find(e=>0===e.xAxisIndex||0===(e.xAxisIndex||0))||null;if(s&&"number"==typeof s.start&&"number"==typeof s.end){const e=o-t;i=t+e*(s.start/100),a=t+e*(s.end/100)}return[i,a]}function Je(){const e=Ae(i);if(null==te[e])return;const[t,n]=Ke();te[e]<t&&(te[e]=t),te[e]>n&&(te[e]=n)}function Ye(){ge(),!d&&window.echarts&&l&&(d=echarts.init(l,null,{renderer:"canvas",devicePixelRatio:window.devicePixelRatio||1}))}function Qe(){if(c&&l&&(s&&(c.style.height="",l.style.height=""),d)){try{d.resize()}catch(e){}Ct()}}function Ze(e){let t=te[e];if(null==t){const[e,n]=Ke();t=(e+n)/2}return t}async function et(e=!1){ge(),Ye(),Qe();const t=xt();if(!Array.isArray(t)||!t.length)return At.__setPendingKeys([]),At.__setMissingKeys([]),S=!1,st(!1),void ot(e);const n=new Set,o=[],i=new Set;t.forEach(e=>{const t=null!=e.modelId?e.modelId:e.model_id,r=null!=e.conditionId?e.conditionId:e.condition_id,a=Number(t),s=Number(r);if(!Number.isInteger(a)||!Number.isInteger(s))return;const c=`${a}_${s}`;i.has(c)||(i.add(c),n.add(c),o.push({model_id:a,condition_id:s}))});const r=Array.from(n);if(!r.length)return At.__setPendingKeys([]),At.__setMissingKeys([]),S=!1,st(!1),void ot(e);const a=new Set(At.getPendingKeys?At.getPendingKeys():[]),s=r.slice().sort().join("|"),c=r.every(e=>f.has(e));if("string"==typeof et.__lastWantedHash&&et.__lastWantedHash===s&&c)return S=!1,st(!1),At.__setPendingKeys([]),void ot(e);if(et.__lastWantedHash=s,c)return S=!1,At.__setPendingKeys([]),At.__setMissingKeys([]),st(!1),void ot(e);if(A){try{ot(!0)}catch(e){}L=!0}else{A=!0;try{let t;t=a.size>0?Array.from(a).map(e=>{const[t,n]=e.split("_");return{model_id:Number(t),condition_id:Number(n)}}).filter(e=>Number.isInteger(e.model_id)&&Number.isInteger(e.condition_id)):o;const n=await async function(e){if(!Array.isArray(e)||!e.length)return{modelsLoaded:0,missingKeys:new Set,rebuildingKeys:new Set};const t=await fetch("/api/spectrum-models",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairs:e})}),n=await t.json();if(!n||"object"!=typeof n||!0!==n.success)throw new Error(n&&n.error_message||"频谱模型接口失败");const o=n.data||{},i=Array.isArray(o.models)?o.models:[];let r=0;i.forEach(e=>{const t=`${Number(e.model_id)}_${Number(e.condition_id)}`,n=e&&e.model||null;n&&Array.isArray(n.centers_hz)&&Array.isArray(n.band_models_pchip)&&(f.set(t,n),r++)});const a=e=>{const t=new Set;return(Array.isArray(e)?e:[]).forEach(e=>{const n=Number(e&&e.model_id),o=Number(e&&e.condition_id);Number.isInteger(n)&&Number.isInteger(o)&&t.add(`${n}_${o}`)}),t};return{modelsLoaded:r,missingKeys:a(o.missing),rebuildingKeys:a(o.rebuilding)}}(t),i=r.filter(e=>!f.has(e)&&!n.missingKeys.has(e));S=i.length>0,At.__setPendingKeys(i),At.__setMissingKeys(Array.from(n.missingKeys||[])),ot(e),S?(st(!0,`${i.length}条频谱渲染中，可能需要数分钟，你可以先浏览其他数据...`),z(()=>{u&&et(!1)},1e4)):st(!1)}finally{if(A=!1,L&&u){L=!1;try{ot(!0)}catch(e){}}}}}function tt(){try{const e=n.getOption()||{};return e.legend&&e.legend[0]&&e.legend[0].selected||{}}catch(e){return{}}}function nt(e,t){const n=Number(t&&t.rpm_max);if(Number.isFinite(n)&&n>0)return n;const o=Array.isArray(e?.data?.rpm)?e.data.rpm.filter(e=>Number.isFinite(Number(e))):[];return o.length?Math.max.apply(null,o.map(Number)):0}function ot(e=!1,t){if(!d)return;try{pe()}catch(e){}const n=t||i&&i.theme||document.documentElement.getAttribute("data-theme")||"light",o=xt(),a=_e(n),s=r&&r.grid||{left:40,right:260,top:60,bottom:40},c="number"==typeof s.left?s.left:40,l="number"==typeof s.right?s.right:260,u=tt(),g=o.map(e=>e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`),w=o.map(e=>{const t=e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`;return{...e,__name:t}}).filter(e=>!u||!1!==u[e.__name]),b=w.map(e=>{const t=null!=e.modelId?e.modelId:e.model_id,n=null!=e.conditionId?e.conditionId:e.condition_id;return`${Number(t)}_${Number(n)}`}).sort().join("|");let _=0;if(w.forEach(e=>{const t=null!=e.modelId?e.modelId:e.model_id,n=null!=e.conditionId?e.conditionId:e.condition_id,o=`${Number(t)}_${Number(n)}`;f.has(o)&&_++}),e||!m||m.__visibleHash!==b||!Number.isFinite(m.__yMaxFixed)||m.__modelReadyCount!==_){const e=function(){const e=xt(),t=tt(),n=N(),o="1_3"===n||"1_12"===n;let i=0;e.forEach(e=>{const r=e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`;if(t&&!1===t[r])return;const a=null!=e.modelId?e.modelId:e.model_id,s=null!=e.conditionId?e.conditionId:e.condition_id,c=Number(a),l=Number(s);if(!Number.isInteger(c)||!Number.isInteger(l))return;const d=f.get(`${c}_${l}`);if(!d)return;const u=Array.isArray(d.centers_hz)?d.centers_hz:d.freq_hz||d.freq||[],m=Array.isArray(d.band_models_pchip)?d.band_models_pchip:[];if(!u.length||!m.length)return;const h=nt(e,d);if(!Number.isFinite(h)||h<=0)return;const p=[],y=[];for(let e=0;e<u.length;e++){const t=Number(u[e]);if(!Number.isFinite(t))continue;const n=m[e];if(!(n&&Array.isArray(n.x)&&Array.isArray(n.y)&&Array.isArray(n.m)))continue;const o=Number(Ue(n,h)),i=Number.isFinite(o)?o:NaN;Number.isFinite(i)&&(p.push(t),y.push(i))}if(!p.length)return;const g=d.calibration||{},w=Number(null!=g.n_per_oct?g.n_per_oct:null!=d.n_per_oct?d.n_per_oct:48);let b=y;if(o){const e=T(p,y,w,"1_3"===n?3:12);b=Array.isArray(e.valuesDb)?e.valuesDb:[],b.length||(b=y)}for(let e=0;e<b.length;e++){const t=Number(b[e]);Number.isFinite(t)&&t>i&&(i=t)}});const r=1.1*(i||60);return Math.max(10,Math.ceil(r))}();m={__yMax:e,__yMaxFixed:e,__visibleHash:b,__modelReadyCount:_}}const v=[];let x=!1;const A=new Set(g.filter(e=>!u||!1!==u[e]));o.forEach(e=>{const t=e.name||`${e.brand||""} ${e.model||""} - ${e.condition||""}`,n=null!=e.modelId?e.modelId:e.model_id,o=null!=e.conditionId?e.conditionId:e.condition_id,r=Number(n),a=Number(o);if(!Number.isInteger(r)||!Number.isInteger(a))return;const s=f.get(`${r}_${a}`);if(!s)return;const c=Array.isArray(s.centers_hz)?s.centers_hz:s.freq_hz||s.freq||[],l=Array.isArray(s.band_models_pchip)?s.band_models_pchip:[];if(!c.length||!l.length)return;const d=function(e,t){if("rpm"===Ae(i)){const e=Number(Ze("rpm"));return Number.isFinite(e)&&e>0?e:0}{const n=Number(Ze("noise_db")),o=e?.pchip?.noise_to_rpm;if(o&&Array.isArray(o.x)&&Array.isArray(o.y)&&Array.isArray(o.m)){const e=Number(Ue(o,n));return Number.isFinite(e)&&e>0?e:0}return nt(e,t)}}(e,s);let u=[];if(Number.isFinite(d)&&d>0){const e=[],t=[];for(let n=0;n<c.length;n++){const o=Number(c[n]);if(!Number.isFinite(o))continue;const i=l[n];if(!(i&&Array.isArray(i.x)&&Array.isArray(i.y)&&Array.isArray(i.m)))continue;const r=Number(Ue(i,d)),a=Number.isFinite(r)?r:NaN;Number.isFinite(a)&&(e.push(o),t.push(a))}if(e.length){const n=N(),o=s.calibration||{},i=Number(null!=o.n_per_oct?o.n_per_oct:null!=s.n_per_oct?s.n_per_oct:48);let r=e,a=t;if("1_3"===n||"1_12"===n){const o=T(e,t,i,"1_3"===n?3:12);r=o.centers,a=o.valuesDb}u=r.map((e,t)=>[e,a[t]])}}u.length&&A.has(t)&&(x=!0),u.length&&v.push({id:`spec:${r}_${a}`,name:t,color:e.color,data:u})});const L=r&&r.backgroundColor||lt(),E=!!S||"function"==typeof At?.getPendingKeys&&At.getPendingKeys().length>0,M=x?{backgroundColor:L,textStyle:{fontFamily:a.fontFamily},title:{text:rt(),left:"center",top:6,textStyle:{color:a.axisLabel,fontWeight:600,fontSize:16,fontFamily:a.fontFamily}},grid:{left:c,right:l,top:38,bottom:60},xAxis:{type:"log",logBase:10,min:h,max:p,name:"频率",nameGap:25,nameLocation:"middle",nameTextStyle:{color:a.axisName,fontWeight:600},axisLabel:{color:a.axisLabel,formatter:e=>{const t=Number(e);return Number.isFinite(t)?t>=1e3?(t/1e3).toFixed(1)+" kHz":t.toFixed(1)+" Hz":String(e)}},axisLine:{lineStyle:{color:a.axisLine}},splitLine:{show:!0,lineStyle:{color:a.gridLine}},minorTick:{show:!0,splitNumber:9},minorSplitLine:{show:!0,lineStyle:{color:a.gridLine,opacity:.4}}},yAxis:{type:"value",show:!0,min:y,max:Math.max(0,Number(m?.__yMaxFixed)||60),name:"声级(dB)",nameTextStyle:{color:a.axisName,fontWeight:600},axisLabel:{color:a.axisLabel},axisLine:{lineStyle:{color:a.axisLine}},splitLine:{show:!0,lineStyle:{color:a.gridLine}}},tooltip:it(a),legend:{show:!1,selected:u,data:g},series:v.map(e=>({id:e.id,name:e.name,type:"line",showSymbol:!1,symbol:"circle",symbolSize:4,smooth:!1,connectNulls:!1,data:e.data,lineStyle:{width:1.5,color:e.color},itemStyle:{color:e.color},silent:!1,z:1,clip:!0,animation:!0,animationDuration:1500,animationEasing:"cubicOut",animationDelay:e=>14*e,animationDurationUpdate:500,animationEasingUpdate:"cubicOut",universalTransition:!0,emphasis:{focus:"series",blurScope:"coordinateSystem"}}))}:E?{backgroundColor:L,grid:{left:c,right:l,top:36,bottom:18},xAxis:{show:!1,min:h,max:p},yAxis:{show:!1,min:y,max:Math.max(0,Number(m?.__yMaxFixed)||60)},legend:{show:!1,selected:u,data:g},series:[]}:{backgroundColor:L,title:{text:"当前无可渲染频谱",left:"center",top:"middle",textStyle:{color:a.axisLabel,fontWeight:600,fontSize:14,fontFamily:a.fontFamily}},grid:{left:c,right:l,top:36,bottom:18},xAxis:{show:!1,min:h,max:p},yAxis:{show:!1,min:y,max:Math.max(0,Number(m?.__yMaxFixed)||60)},legend:{show:!1,selected:u,data:g},series:[]};d.setOption(M,!!e),d.resize(),requestAnimationFrame(Ct)}function it(e){const t=e=>{const t=Number(e);return Number.isFinite(t)?t>=1e3?(t/1e3).toFixed(1)+" kHz":t.toFixed(1)+" Hz":String(e)};return{...yt(e,{appendToBody:!s}),confine:!1,trigger:"axis",triggerOn:"mousemove|click|touchstart|touchmove",borderRadius:10,axisPointer:{type:"line",snap:!0,label:{formatter:e=>t(e?.value)}},position:function(e){const t=Array.isArray(e)?e[0]:0,n=Array.isArray(e)?e[1]:0;return[Math.round(t+12),Math.round(n+12)]},formatter:function(e){if(!Array.isArray(e)||!e.length)return"";const n=e[0]?.axisValue;return`<div style="font-weight:800;margin-bottom:4px;">${t(n)}</div>`+e.map(e=>{const t=Array.isArray(e.data)?e.data[1]:Number(e.value)||NaN,n=Number.isFinite(t)?t.toFixed(1)+" dB":"-";return`<div style="display:flex;align-items:center;gap:6px;">\n                  <span style="display:inline-block;width:10px;height:10px;border-radius:50%;background:${e.color};"></span>\n                  <span>${e.seriesName}</span>\n                  <span style="margin-left:auto;color:var(--text-muted);font-variant-numeric:tabular-nums;">${n}</span>\n                </div>`}).join("")}}}function rt(){const e=Ae(i),t=Number(Ze(e)),n=N();let o="　　　　1/48";"1_12"===n&&(o="　　　　1/12"),"1_3"===n&&(o="　　　　1/3 ");const r=`${o} OCT  `;return"rpm"===e?`${r}A计权声级频谱 @ ${Number.isFinite(t)?Math.round(t):"-"} RPM`:`${r}A计权声级频谱 @ ${Number.isFinite(t)?t.toFixed(1):"-"} dB`}function at(){const e=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container");if(!e)return 0;const n=e.querySelector(".chart-stack");if(!n)return 0;const o=getComputedStyle(n),i=parseFloat(o.rowGap||o.gap||"0")||0,r=Math.max(0,Math.round(n.getBoundingClientRect().height)),a=Math.max(0,r-i),s=getComputedStyle(document.documentElement),c=parseFloat(s.getPropertyValue("--fs-main-flex"))||3,l=parseFloat(s.getPropertyValue("--fs-spec-flex"))||2,d=Math.max(1e-4,c+l),u=Math.round(a*(l/d));return Math.max(1,u)}function st(e,t){const n=function(){if(!c)return null;let e=c.querySelector(".spectrum-loading");return e||(e=document.createElement("div"),e.className="spectrum-loading",e.innerHTML='\n      <div class="spinner" aria-hidden="true"></div>\n      <div class="text" id="spectrumLoadingText">加载中...</div>\n    ',c.appendChild(e)),spectrumLoadingEl=e,e}();if(!n)return;const o=n.querySelector("#spectrumLoadingText");o&&("string"==typeof t&&t.length&&(o.textContent=t),o.style.fontSize="15px"),n.classList.toggle("is-active",!!e)}function ct({animate:e=!1}={}){ge();const o=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||document.documentElement;if(c){if(u){try{o.setAttribute("data-chart-mode","spectrum")}catch(e){}if(s){const t=at();if(c.style.removeProperty("height"),c.style.setProperty("flex","0 0 auto","important"),c.style.setProperty("--fs-spec-h",t+"px"),e){c.style.transition="max-height var(--transition-speed, .25s) ease";const e=Math.max(0,Math.round(c.getBoundingClientRect().height||0));c.style.setProperty("max-height",e+"px"),c.offsetHeight,c.style.setProperty("max-height",t+"px")}else c.style.transition="none",c.style.setProperty("max-height",t+"px"),c.offsetHeight,c.style.transition=""}else e&&(c.classList.add("anim-scale"),requestAnimationFrame(()=>{try{c.classList.remove("anim-scale")}catch(e){}})),c.style.removeProperty("max-height"),c.style.removeProperty("flex")}else{try{o.removeAttribute("data-chart-mode")}catch(e){}s?(c.style.removeProperty("height"),c.style.transition=e?"max-height var(--transition-speed, .25s) ease":"none",c.style.setProperty("max-height","0px"),e||(c.style.transition="")):(c.style.removeProperty("max-height"),c.style.removeProperty("flex"),e&&(c.classList.add("anim-scale"),requestAnimationFrame(()=>{try{c.classList.remove("anim-scale")}catch(e){}})))}try{u&&d&&ot()}catch(e){}try{n&&n.resize()}catch(e){}try{u&&d&&d.resize()}catch(e){}}}function lt(){const e=getComputedStyle(document.body).backgroundColor;return e&&"rgba(0, 0, 0, 0)"!==e?e:"#ffffff"}function dt(){const e=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||null;if(!e)return;const n=ut(),o=he(),i=!r||r.__empty,a=!n&&!(!Z||i||o);e.classList.toggle("rail-parked",a);try{W()}catch(e){}}function ut(){return!!he()||!(!s||!fe())}const mt=(()=>{const e=document.createElement("canvas").getContext("2d"),t=new Map;return{measure:function(n,o){const i=n+"||"+(o||"");if(t.has(i))return t.get(i);e.font=n;const r=e.measureText(o||""),a=/(\d+(?:\.\d+)?)px/.exec(n),s=a?parseFloat(a[1]):14,c="number"==typeof r.actualBoundingBoxAscent?r.actualBoundingBoxAscent:.8*s,l="number"==typeof r.actualBoundingBoxDescent?r.actualBoundingBoxDescent:.2*s,d={width:r.width||0,height:c+l};return t.set(i,d),d}}})(),ft=(()=>{let e=null;const t=new Set;function n(){e=null;try{t.has("legend")&&(W(),X()),t.has("fitUI")&&He(),t.has("pointer")&&Oe(),t.has("spectrum")&&(Qe(),Ct()),t.has("axisSwitch")&&Te({force:!0,animate:!1}),t.has("dock")&&D(),t.has("railPark")&&dt()}catch(e){}t.clear()}return{mark:function(...o){o.forEach(e=>t.add(e)),e||(e=requestAnimationFrame(n))},flush:n}})(),ht=(()=>{const e=new Map;return{run:function(t,n){e.set(t,performance.now()+Math.max(0,0|n))},active:function(t){return performance.now()<(e.get(t)||0)},clear:function(t){e.delete(t)}}})();function pt(e,t){const{axis:n="both",threshold:o=4,onStart:i,onMove:r,onEnd:a}=t||{};if(!e)return;let s=null,c=0,l=0,d=!1;function u(){if(null!=s){try{e.releasePointerCapture(s)}catch(e){}s=null,d=!1,"function"==typeof a&&a()}}e.addEventListener("pointerdown",function(t){if((void 0===t.button||0===t.button)&&null==s)if(c=t.clientX,l=t.clientY,s=t.pointerId??null,d=!1,!1!==("function"!=typeof i||i(t))){try{null!=s&&e.setPointerCapture(s)}catch(e){}t.preventDefault?.()}else s=null}),window.addEventListener("pointermove",function(e){if(null!=s&&(e.pointerId??null)!==s)return;if(null==s)return;let t=e.clientX-c,i=e.clientY-l;!d&&Math.hypot(t,i)>=o&&(d=!0),d&&("x"===n&&(i=0),"y"===n&&(t=0),"function"==typeof r&&r({dx:t,dy:i,e}))},{passive:!0}),window.addEventListener("pointerup",u,{passive:!0}),window.addEventListener("pointercancel",u),window.addEventListener("blur",u)}function yt(e,{appendToBody:t}){return{appendToBody:!!t,backgroundColor:e.tooltipBg,borderColor:e.tooltipBorder,borderWidth:1,textStyle:{color:e.tooltipText},extraCssText:`\n      position: ${t?"fixed":"absolute"};\n      backdrop-filter: blur(4px) saturate(120%);\n      -webkit-backdrop-filter: blur(4px) saturate(120%);\n      box-shadow: ${e.tooltipShadow};\n      z-index: 1000000;\n    `}}const gt=(()=>{let e=null,t=null,n=null,o=null,i=0,r=[],a=null;const s=new Map;function c(){return e||(e=new(window.AudioContext||window.webkitAudioContext)),e}function l(){const e=c();t||(t=e.createGain(),t.gain.value=5),n||(n=e.createDynamicsCompressor(),n.threshold.value=-12,n.knee.value=6,n.ratio.value=6,n.attack.value=.003,n.release.value=.12);try{t.disconnect()}catch(e){}try{n.disconnect()}catch(e){}t.connect(n),n.connect(e.destination)}function d(){o&&(clearInterval(o),o=null)}function u(e,n){if(!e)return;const o=c();l();const i=o.createBufferSource();i.buffer=e;const a=o.createGain();a.gain.cancelScheduledValues(0),a.gain.setValueAtTime(0,n),i.connect(a),a.connect(t);const s=e.duration,d=Math.min(.05,.49*s),u=Math.max(32,Math.floor(d*o.sampleRate)),{fi:m,fo:f}=function(e){const t=new Float32Array(e),n=new Float32Array(e);for(let o=0;o<e;o++){const i=o/Math.max(1,e-1)*(Math.PI/2);t[o]=Math.sin(i),n[o]=Math.cos(i)}return{fi:t,fo:n}}(u),h=n+d,p=n+s-d;a.gain.setValueCurveAtTime(m,n,d),a.gain.setValueAtTime(1,h),a.gain.setValueAtTime(1,p),a.gain.setValueCurveAtTime(f,p,d),i.start(n);const y={source:i,gain:a};r.push(y),i.onended=()=>{const e=r.indexOf(y);e>=0&&r.splice(e,1);try{i.disconnect()}catch(e){}try{a.disconnect()}catch(e){}}}function m(e){if(!a||!e)return;const t=c().currentTime,n=e.duration,o=Math.min(.05,.49*n),r=Math.max(.001,n-o);for(;i<t+.4;)u(e,i),i+=r}function f(){a=null,d(),function(){if(!e)return;const t=e.currentTime,n=r.slice();r=[],n.forEach(e=>{try{e.gain.gain.cancelScheduledValues(t),e.gain.gain.setValueAtTime(e.gain.gain.value,t),e.gain.gain.linearRampToValueAtTime(0,t+.03)}catch(e){}try{e.source.stop(t+.03+.01)}catch(e){}})}(),e&&setTimeout(()=>{if(!a)try{e.suspend()}catch(e){}},50)}return{play:async function({name:e,modelId:t,conditionId:n,rpm:r}){if(!Number.isFinite(r)||r<=0)throw new Error("RPM 无效");if(a&&a.name===e)return f(),{state:"stopped"};f();const{buffer:u,key:h}=await async function(e,t,n){const o=`${e}_${t}_${Math.round(n)}`;if(s.has(o))return{buffer:s.get(o),key:o};const i=await fetch("/api/sweep-audio",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:e,condition_id:t,target_rpm:n})});if(!i.ok){let e=`HTTP ${i.status}`,t=null;try{const n=await i.json();n.error_message&&(e=n.error_message),n.error_code&&(t=n.error_code)}catch(e){}const n=new Error(e);throw n.errorCode=t,n}const r=await i.arrayBuffer(),a=await c().decodeAudioData(r);return s.set(o,a),{buffer:a,key:o}}(t,n,r),p=c();return l(),await p.resume().catch(()=>{}),a={name:e,key:h,rpm:r},i=p.currentTime+.1,m(u),d(),o=setInterval(()=>m(u),25),{state:"playing",key:h}},stop:f,isPlaying:function(e){return!!a&&a.name===e}}})();function wt(e){return e&&null!=e.x0&&null!=e.x1?{min:Math.min(e.x0,e.x1),max:Math.max(e.x0,e.x1)}:null}let bt=0,_t=[],vt=-1;function xt(){return Array.isArray(_t)?_t:[]}let St={epoch:-1,isNarrow:null,rpm:null,noise_db:null};const At=(()=>{let e=new Set,o=new Set;return{setEnabled:function(e,o={}){const i=!!e;if(i===u){try{ct({animate:!!o.animate})}catch(e){}try{i&&et(!0)}catch(e){}try{B(),D()}catch(e){}return u}u=i;try{B(),D()}catch(e){}try{!async function(e){if(ge(),u=!!e,!c)return;H++,O.forEach(e=>{try{clearTimeout(e)}catch(e){}}),O.clear();const o=document.getElementById("chart-settings")||t&&t.closest(".fc-chart-container")||document.documentElement;try{d&&d.dispatchAction({type:"hideTip"})}catch(e){}const i=G(),r=Math.max(240,i+120),a=H;if(e)if(Ye(),s){try{o.setAttribute("data-chart-mode","spectrum")}catch(e){}c.style.setProperty("flex","0 0 auto","important"),c.style.setProperty("max-height","0px");const e=at();c.style.setProperty("--fs-spec-h",e+"px"),c.offsetHeight,et().catch(()=>{}).then(()=>{if(a===H)try{d&&d.resize()}catch(e){}}),requestAnimationFrame(()=>{if(a!==H)return;const t=e=>{if(!(a!==H||e&&e.propertyName&&"max-height"!==e.propertyName)){try{c.removeEventListener("transitionend",t)}catch(e){}try{n&&n.resize()}catch(e){}try{d&&d.resize()}catch(e){}}};try{c.addEventListener("transitionend",t,{once:!0})}catch(e){}c.style.setProperty("max-height",e+"px")})}else{const e=function(){const e=window.visualViewport&&Math.round(window.visualViewport.height)||0,t=e>0?e:window.innerHeight||document.documentElement.clientHeight||800,n=he(),o=n?.3:.45;let i=Math.round(t*o);return i=Math.min(600,i),n||(i=Math.max(300,i)),Math.max(1,i)}();if(l){l.style.height=e+"px";try{Ye(),d&&d.resize()}catch(e){}l.style.transition="transform var(--transition-speed, .25s) ease",l.style.opacity="1"}c.classList.add("anim-scale","reveal-from-0");try{o.setAttribute("data-chart-mode","spectrum")}catch(e){}et().catch(()=>{}).then(()=>{if(a===H)try{d&&d.resize()}catch(e){}}),requestAnimationFrame(()=>{if(a!==H)return;let e=!1;const t=Math.min(400,(G()||250)+50),n=setTimeout(()=>{if(a===H&&!e){e=!0;try{const e=c.getBoundingClientRect(),t=window.innerHeight||document.documentElement.clientHeight||0;e.bottom>t-8&&c.scrollIntoView({behavior:"smooth",block:"start"})}catch(e){}}},t),o=t=>{if(a===H&&(!t||"height"===t.propertyName)){try{c.removeEventListener("transitionend",o)}catch(e){}c.classList.remove("anim-scale","reveal-from-0","revealed"),l&&(l.style.transition="",l.style.opacity="",l.style.height="");try{d&&d.resize()}catch(e){}if(!e){try{const e=c.getBoundingClientRect(),t=window.innerHeight||document.documentElement.clientHeight||0;e.bottom>t-8&&c.scrollIntoView({behavior:"smooth",block:"start"})}catch(e){}e=!0}try{clearTimeout(n)}catch(e){}}};try{c.addEventListener("transitionend",o)}catch(e){}c.classList.add("revealed"),z(()=>{a===H&&(c.classList.remove("anim-scale","reveal-from-0","revealed"),l&&(l.style.transition="",l.style.opacity="",l.style.height=""))},r)})}else{const e=()=>{if(a===H){try{o.removeAttribute("data-chart-mode")}catch(e){}if(t)try{t.style.minHeight=""}catch(e){}c.classList.remove("anim-scale","revealed","reveal-from-0","collapse-to-0"),l&&(l.style.transition="",l.style.opacity="",l.style.height="");try{c.style.removeProperty("max-height"),c.style.removeProperty("flex")}catch(e){}}};if(s){const t=Math.max(1,Math.round(c.getBoundingClientRect().height||1));c.style.setProperty("flex","0 0 auto","important"),c.style.setProperty("--fs-spec-h",t+"px"),c.style.setProperty("max-height",t+"px"),requestAnimationFrame(()=>{if(a!==H)return;const t=o=>{if(!(a!==H||o&&o.propertyName&&"max-height"!==o.propertyName)){try{c.removeEventListener("transitionend",t)}catch(e){}e();try{c.style.removeProperty("max-height"),c.style.removeProperty("flex"),c.style.removeProperty("--fs-spec-h")}catch(e){}we();try{n&&n.resize()}catch(e){}}};try{c.addEventListener("transitionend",t,{once:!0})}catch(e){}c.style.setProperty("max-height","0px")}),z(()=>{try{e(),we()}catch(e){}},Math.max(900,(G()||350)+300))}else{const t=Math.max(1,Math.round(c.getBoundingClientRect().height||1));l&&(l.style.height=t+"px",l.style.transition="transform var(--transition-speed, .25s) ease",l.style.opacity="1"),c.classList.add("anim-scale","collapse-to-0"),requestAnimationFrame(()=>{if(a!==H)return;const t=n=>{if(a===H&&(!n||"height"===n.propertyName)){try{c.removeEventListener("transitionend",t)}catch(e){}e(),c.classList.remove("anim-scale","collapse-to-0")}};try{c.addEventListener("transitionend",t,{once:!0})}catch(e){}try{o.removeAttribute("data-chart-mode")}catch(e){}})}}try{B()}catch(e){}try{D()}catch(e){}}(u)}catch(e){}return u},onFullscreenChange:function(e){try{ct({animate:!1})}catch(e){}try{u&&ot(!0)}catch(e){}try{B(),D()}catch(e){}},onXQueryChange:function(e){try{u&&d&&u&&d&&(w||(w=requestAnimationFrame(()=>{w=null,ot()})))}catch(e){}},getPendingKeys:function(){return Array.from(e)},isEnabled:function(){return!!u},__setPendingKeys:function(t){e=new Set(Array.isArray(t)?t:t?Array.from(t):[])},__setMissingKeys:function(e){o=new Set(Array.isArray(e)?e:e?Array.from(e):[])}}})();function Lt(e,{immediate:t=!1}={}){const n=ie("fitBubble");if(!n)return;if(e)return n.style.visibility="visible",void n.classList.add("is-visible");if(t)return n.classList.remove("is-visible"),void(n.style.visibility="hidden");n.classList.remove("is-visible");const o=e=>{if(!e||!e.propertyName||"opacity"===e.propertyName){try{n.removeEventListener("transitionend",o)}catch(e){}n.style.visibility="hidden"}};try{n.addEventListener("transitionend",o)}catch(e){n.style.visibility="hidden"}}function Et(){const e=ut(),t=xt();if(!Z||!i||!n||r&&r.__empty){if(e){const e=v?.querySelector(".legend-fit-grid");e&&(e.classList.remove("is-fit-on"),e.querySelectorAll(".col-val,.col-pct,.col-cross").forEach(e=>{e.textContent="—"}))}else Lt(!1);return}const o=Ae(i),a=te[o];if(null==a)return;const c=n.getOption()||{},l=function(e,t,n,o){const i=[];return Xe(n,e),n.forEach(n=>{const r=n.name||`${n.brand||""} ${n.model||""} - ${n.condition||""}`,a=!o||!1!==o[r],s=ne[e].get(r),c=n&&n.pchip?"rpm"===e?n.pchip?.rpm_to_noise_db:n.pchip?.noise_to_rpm:null;let l=NaN,d=NaN,u=!1;if(s&&null!=s.x0&&null!=s.x1){const e=Math.min(s.x0,s.x1),n=Math.max(s.x0,s.x1);u=t<e||t>n,l=Ue(s,Math.max(e,Math.min(t,n)))}if(c&&null!=c.x0&&null!=c.x1){const e=Math.min(c.x0,c.x1),n=Math.max(c.x0,c.x1);d=Ue(c,Math.max(e,Math.min(t,n)))}const m=n.modelId??n.model_id,h=n.conditionId??n.condition_id,p=Number.isInteger(m)&&Number.isInteger(h)?`${m}_${h}`:null,y=p?f.get(p):null,g=!!n.supports_audio,w=!(!y||!y.supports_audio),b=g||w;i.push({name:r,color:n.color,brand:n.brand||"",model:n.model||"",condition:n.condition||"",selected:a,y:l,cross:d,outOfDomain:u,modelId:m,conditionId:h,supports_audio:b,__series:n,__spectrumModel:y})}),i}(o,a,t,c.legend&&c.legend[0]&&c.legend[0].selected||{});!function({mode:e,rows:t,xValue:o,unit:r,onToggleSeries:a}){const c={};function l(e){e&&(e.querySelectorAll(".play-audio-btn[data-name]").forEach(t=>{const n=t.getAttribute("data-name")||"";t.onclick=async o=>{o.stopPropagation();const r=c[n];if(!r)return;const a=function(e,t){const n=e.__series||{},o=e.__spectrumModel;let i;if("rpm"===t){const e=Number(Ze("rpm")),t=n?.pchip?.rpm_to_airflow,o=wt(t);i=o?e<o.min?o.min:e>o.max?o.max:e:e}else if(Number.isFinite(e.cross)&&e.cross>0)i=Number(e.cross);else{const e=Number(Ze("noise_db")),t=n?.pchip?.noise_to_rpm,r=wt(t);i=r?e<r.min?Ue(t,r.min):e>r.max?Ue(t,r.max):nt(n,o):nt(n,o)}const r=function(e,t){const n=Number(t&&t.rpm_min);if(Number.isFinite(n)&&n>0)return n;const o=Array.isArray(e?.data?.rpm)?e.data.rpm.filter(e=>Number.isFinite(Number(e))):[];return o.length?Math.min.apply(null,o.map(Number)):0}(n,o),a=nt(n,o);return Number.isFinite(r)&&r>0&&i<r&&(i=r),Number.isFinite(a)&&a>0&&i>a&&(i=a),i}(r,Ae(i));if(!Number.isFinite(a)||a<=0)return;const s=!gt.isPlaying(n);t.disabled=!0;try{if(await gt.play({name:n,modelId:r.modelId,conditionId:r.conditionId,rpm:a}),s&&window.Analytics&&window.Analytics.logPlayAudio)try{const e=Ae(i),t=te[e],n="noise_db"===e?t:Number.isFinite(r.cross)?r.cross:null;window.Analytics.logPlayAudio(r.modelId,r.conditionId,"noise_db"===e?"db":"rpm",t,a,n)}catch(e){}e.querySelectorAll(".play-audio-btn").forEach(e=>{const t=e.getAttribute("data-name");e.textContent=gt.isPlaying(t)?"■":"▶"})}catch(t){console.warn("播放失败",t);const n=t&&t.errorCode?t.errorCode:null,o=t&&t.message?t.message:String(t);"AUDIO_GENERATION_FAILED"===n&&(o.includes("无法匹配到有效的音频数据")||o.includes("Cannot match valid audio data"))?"function"==typeof window.showError&&window.showError("暂时无法匹配到有效的音频片段，请尝试其他转速或噪音值。 Unable to match valid audio segment. Please try different RPM or noise values."):"function"==typeof window.showError&&window.showError("音频播放失败 / Audio playback failed"),gt.stop(),e.querySelectorAll(".play-audio-btn").forEach(e=>e.textContent="▶")}finally{t.disabled=!1}}}),e.querySelectorAll(".play-audio-btn").forEach(e=>{const t=e.getAttribute("data-name");e.textContent=gt.isPlaying(t)?"■":"▶"}))}if(t.forEach(e=>{c[e.name]=e}),"integrated"===e){if(!v)return;v.style.setProperty("--fit-col-val-ch","7"),v.style.setProperty("--fit-col-pct-ch","7"),v.style.setProperty("--fit-col-cross-ch","9"),v.style.setProperty("--fit-col-play-w","32px");const e=t.filter(e=>e.selected).filter(e=>Number.isFinite(e.y)).sort((e,t)=>t.y-e.y),c=e.length&&e[0].y>0?e[0].y:0,m=e=>Number.isFinite(e)&&c>0?Math.round(e/c*100):null,f=v.querySelector(".legend-fit-grid");if(!f)return;const h=[...t.filter(e=>Number.isFinite(e.y)).sort((e,t)=>t.y-e.y),...t.filter(e=>!Number.isFinite(e.y))];f.innerHTML=h.map(e=>{const t=e.brand||e.model?`${e.brand} ${e.model}`.trim():e.name,n=Number.isFinite(e.y),o=n?`${Math.round(e.y)} CFM`:"—",i=n?m(e.y):null,a=null==i?"—":`(${i}%)`;let c="—";Number.isFinite(e.cross)&&(c="dB"===r?`<span style="font-variant-numeric:tabular-nums;">${Math.round(e.cross)}</span> RPM`:`<span style="font-variant-numeric:tabular-nums;">${Number(e.cross).toFixed(1)}</span> dB`);const l=(window.innerWidth||document.documentElement.clientWidth||0)<500;let d="name",u="";s&&Z&&e.condition?(d="name has-l2",u=e.condition?`<span class="l2">${e.condition}</span>`:""):!s&&l&&e.condition?(d="name has-l2",u=`<span class="l2" style="color: var(--text-secondary);">${e.condition}</span>`):!s&&e.condition&&(d="name",u=`<span class="cond-inline" style="color: var(--text-secondary);"> - ${e.condition}</span>`);const f=q();return`\n        <div class="legend-row hoverable-row ${e.selected?"":"is-off"}${e.outOfDomain?" is-out-of-domain":""}" data-name="${e.name}">\n          <span class="dot" style="background:${e.color}"></span>\n          <span class="${d}" title="${t}${e.condition?" / "+e.condition:""}">\n            <span class="l1">${t}</span>${u}\n          </span>\n          <span class="col-val">${o}</span>\n          <span class="col-pct">${a}</span>\n          <span class="col-sep">│</span>\n          <span class="col-cross">${c}</span>\n          ${f?`<button class="play-audio-btn col-play ${e.supports_audio?"":"disabled"}" data-name="${e.name}" aria-label="播放/停止" ${e.supports_audio?'data-tooltip="播放当前转速录音"':""} ${e.supports_audio?"":"disabled"}></button>`:""}\n        </div>\n      `}).join(""),f.querySelectorAll(".legend-row[data-name]").forEach(e=>{const t=e.getAttribute("data-name")||"";e.addEventListener("click",()=>{if(!t||!n)return;const o=tt(),i=!o||!1!==o[t];e.classList.toggle("is-off",i),a(t,!i),Et()}),e.addEventListener("mouseenter",()=>{if(t){try{n.dispatchAction({type:"highlight",seriesName:t})}catch(e){}if(u&&d)try{d.dispatchAction({type:"highlight",seriesName:t})}catch(e){}}},{passive:!0}),e.addEventListener("mouseleave",()=>{if(t){try{n.dispatchAction({type:"downplay",seriesName:t})}catch(e){}if(u&&d)try{d.dispatchAction({type:"downplay",seriesName:t})}catch(e){}}},{passive:!0})}),l(f);const p=ie("fitXUnitLegend");p&&(p.textContent=r);const y=ie("fitXInputLegend");if(y){const e=Ae(i),t=Number(te[e]??o),n="noise_db"===e?Number(t.toFixed(1)):Math.round(t);y.value=String(n);const[r,a]=Ke();y.setAttribute("min",String(Math.floor(r))),y.setAttribute("max",String(Math.ceil(a))),y.setAttribute("step","noise_db"===e?"0.1":"1"),y.oninput=()=>{const t=Number(y.value);Number.isFinite(t)&&(te[e]=t)},y.onchange=()=>{const t=Number(y.value);Number.isFinite(t)&&(te[e]=Ge(t),Je());const n=Number(te[e]);if(Number.isFinite(n)){const t="noise_db"===e?Number(n.toFixed(1)):Math.round(n);y.value=String(t)}Oe(),Et(),At.onXQueryChange(te[e])}}const g=v.querySelector(".legend-fit-grid");return void(g&&g.classList.add("is-fit-on"))}const m=ie("fitBubble");if(!m)return;const f=m.querySelector("#fitBubbleRows");m.style.setProperty("--fit-col-val-ch","7"),m.style.setProperty("--fit-col-pct-ch","7"),m.style.setProperty("--fit-col-cross-ch","9"),m.style.setProperty("--fit-col-play-w","32px");const h=Array.isArray(t)?t:[],p=h.filter(e=>e.selected).filter(e=>Number.isFinite(e.y)).sort((e,t)=>t.y-e.y),y=p.length&&p[0].y>0?p[0].y:0,g=[...h.filter(e=>Number.isFinite(e.y)).sort((e,t)=>t.y-e.y),...h.filter(e=>!Number.isFinite(e.y))];f.innerHTML=g.map(e=>{const t=Number.isFinite(e.y),n=t?`${Math.round(e.y)} CFM`:"—",o=t?(a=e.y,Number.isFinite(a)&&y>0?Math.round(a/y*100):null):null,i=null==o?"—":`(${o}%)`;var a;let s="—";Number.isFinite(e.cross)&&(s="dB"===r?`<span style="font-variant-numeric:tabular-nums;">${Math.round(e.cross)}</span> RPM`:`<span style="font-variant-numeric:tabular-nums;">${Number(e.cross).toFixed(1)}</span> dB`);const c=e.brand||e.model?`${e.brand} ${e.model}`.trim():e.name,l=e.condition?`<span class="sep"> - </span><span class="cond-inline" style="color:var(--text-secondary);white-space:nowrap;">${e.condition}</span>`:"",d=q();return`\n      <div class="row ${e.selected?"":"is-off"}${e.outOfDomain?" is-out-of-domain":""}" data-name="${e.name}">\n        <span class="dot" style="background:${e.color}"></span>\n        <span></span>\n        <span class="col-name">${c}${l}</span>\n        <span class="col-val">${n}</span>\n        <span class="col-pct">${i}</span>\n        <span class="col-sep">│</span>\n        <span class="col-cross">${s}</span>\n        ${d?`<button class="play-audio-btn col-play ${e.supports_audio?"":"disabled"}" data-name="${e.name}" aria-label="播放/停止" ${e.supports_audio?'data-tooltip="播放当前转速录音"':""} ${e.supports_audio?"":"disabled"}></button>`:""}\n      </div>\n    `}).join(""),f.querySelectorAll(".row[data-name]").forEach(e=>{const t=e.getAttribute("data-name")||"";e.addEventListener("pointerdown",e=>{e.stopPropagation()},{passive:!0}),e.addEventListener("mouseenter",()=>{if(t){try{n.dispatchAction({type:"highlight",seriesName:t})}catch(e){}if(u&&d)try{d.dispatchAction({type:"highlight",seriesName:t})}catch(e){}}},{passive:!0}),e.addEventListener("mouseleave",()=>{if(t){try{n.dispatchAction({type:"downplay",seriesName:t})}catch(e){}if(u&&d)try{d.dispatchAction({type:"downplay",seriesName:t})}catch(e){}}},{passive:!0}),e.addEventListener("click",e=>{if(e.preventDefault(),e.stopPropagation(),!t)return;const n=tt(),o=!n||!1!==n[t];a(t,!o),Et()})});const w=m.querySelector("#fitXUnit");w&&(w.textContent=r);const b=m.querySelector("#fitXInput");if(b){const e=Ae(i),t=Number(te[e]??o),n="noise_db"===e?Number(t.toFixed(1)):Math.round(t);b.value=String(n);const[r,a]=Ke();b.setAttribute("min",String(Math.floor(r))),b.setAttribute("max",String(Math.ceil(a))),b.setAttribute("step","noise_db"===e?"0.1":"1")}l(f)}({mode:e?"integrated":"floating",rows:l,xValue:a,unit:"rpm"===o?"RPM":"dB",onToggleSeries:(e,t)=>{const o=t?"legendSelect":"legendUnSelect";try{n.dispatchAction({type:o,name:e})}catch(e){}if(u&&d)try{d.dispatchAction({type:o,name:e})}catch(e){}try{V()}catch(e){}}})}function Mt(){try{gt.stop()}catch(e){}}function Ct(){const e=l?l.querySelector(".spectrum-res-switch"):null;if(!e)return;if(!u||!d)return void(e.style.visibility="hidden");let t=null;try{t=d.getOption()}catch(e){}if(!(t&&Array.isArray(t.series)&&t.series.length>0))return void(e.style.visibility="hidden");const n=d.getWidth();if(!n||n<50)return void requestAnimationFrame(Ct);const o=t&&t.title&&t.title[0]&&t.title[0].text||m&&m.title&&m.title.text||rt()||"",r=o.indexOf("1/");if(r<0)return void(e.style.visibility="hidden");const a=_e(i?.theme),s=n/2-ve(o,16,700,a.fontFamily).width/2+ve(o.slice(0,r),16,700,a.fontFamily).width+ve("1/",16,700,a.fontFamily).width/2-4;e.style.left=Math.round(s)+"px",e.style.top=Math.round(16)+"px",e.style.transform="translate(-50%, -50%)",e.style.visibility="visible"}function Ct(){const e=l?l.querySelector(".spectrum-res-switch"):null;if(!e)return;if(!u||!d)return void(e.style.visibility="hidden");let t=null;try{t=d.getOption()}catch(e){}if(!(t&&Array.isArray(t.series)&&t.series.length>0))return void(e.style.visibility="hidden");const n=d.getWidth();if(!n||n<50)return void requestAnimationFrame(Ct);const o=t&&t.title&&t.title[0]&&t.title[0].text||m&&m.title&&m.title.text||rt(),r=o.indexOf("1/");if(r<0)return void(e.style.visibility="hidden");const a=_e(i?.theme),s=n/2-ve(o,16,700,a.fontFamily).width/2+ve(o.slice(0,r),16,700,a.fontFamily).width+ve("1/",16,700,a.fontFamily).width/2-4;e.style.left=Math.round(s)+"px",e.style.top=Math.round(16)+"px",e.style.transform="translate(-50%, -50%)",e.style.visibility="visible"}try{window.SpectrumController=At}catch(e){}window.ChartRenderer=e}()},839(){const e=function(){const e="colorIndexMap_v1";let t={};const n=["#3e6bff","#FFF958","#1aed03","#FF4848","#DB68FF","#3fe9ff","#F59916","#ff91ce","#8b5cf6","#22ffb5"],o=.66;function i(){try{localStorage.setItem(e,JSON.stringify(t))}catch(e){console.error("Failed to save color map to localStorage",e)}}function r(e){return e<=.04045?e/12.92:Math.pow((e+.055)/1.055,2.4)}function a(e){return e<=.0031308?12.92*e:1.055*Math.pow(e,1/2.4)-.055}function s(e){const t=e.replace("#","");let n=parseInt(t.slice(0,2),16)/255,i=parseInt(t.slice(2,4),16)/255,s=parseInt(t.slice(4,6),16)/255;n=r(n)*o,i=r(i)*o,s=r(s)*o,n=Math.round(255*a(n)),i=Math.round(255*a(i)),s=Math.round(255*a(s));const c=e=>e.toString(16).padStart(2,"0");return"#"+c(n)+c(i)+c(s)}return t=function(){try{return JSON.parse(localStorage.getItem(e)||"{}")}catch(e){return console.error("Failed to load color map from localStorage",e),{}}}(),{getColor:function(e){const o=t[e]??0,i="dark"==("dark"===document.documentElement.getAttribute("data-theme")?"dark":"light")?n:n.map(s);return i[o%i.length]},getIndex:function(e){return t[e]??0},assignUniqueIndices:function(e){if(!Array.isArray(e))return;const n=[...new Set(e.filter(Boolean))],o={},r=new Set,a={};n.forEach(e=>{if(Object.prototype.hasOwnProperty.call(t,e)){const n=t[e];a[n]=(a[n]||0)+1}}),n.forEach(e=>{if(Object.prototype.hasOwnProperty.call(t,e)){const n=t[e];1!==a[n]||r.has(n)||(o[e]=n,r.add(n))}}),n.forEach(e=>{if(!Object.prototype.hasOwnProperty.call(o,e)){const t=function(e){let t=0;for(;e.has(t);)t++;return t}(r);o[e]=t,r.add(t)}}),t=o,i()},releaseIndex:function(e){e&&Object.prototype.hasOwnProperty.call(t,e)&&(delete t[e],i())},patchIndicesFromServer:function(e){if(e&&"object"==typeof e.color_indices)try{Object.entries(e.color_indices).forEach(([e,n])=>{Number.isFinite(n)&&(t[e]=0|n)}),i()}catch(e){console.error("Failed to patch color indices from server meta",e)}}}}();"undefined"!=typeof window&&(window.ColorManager=e)},905(){!function(){window.__APP=window.__APP||{},window.__APP.features=window.__APP.features||{};const e=e=>"function"==typeof window.escapeHtml?window.escapeHtml(e):String(e??"");function t(t){const n=document.getElementById("recentlyRemovedList");if(!n)return;if(n.innerHTML="",!Array.isArray(t)||0===t.length)return n.innerHTML='<p class="text-gray-500 text-center py-6 empty-removed">暂无最近移除的风扇</p>',void requestAnimationFrame(()=>{try{"function"==typeof window.prepareSidebarMarquee&&window.prepareSidebarMarquee()}catch(e){}});const o=function(){const e=new Set;try{(window.LocalState&&window.LocalState.getSelected&&window.LocalState.getSelected()||[]).forEach(t=>{t&&t.key&&e.add(t.key)})}catch(e){}return e}();t.forEach(t=>{if(!t||o.has(t.key))return;const i=window.DisplayCache&&window.DisplayCache.get(t.model_id,t.condition_id)||null,r=i?.brand||"",a=i?.model||"",s=i?.condition||"加载中...",c="function"==typeof window.formatScenario?window.formatScenario(i?.rt,i?.rl):"",l=c?`${s} - ${c}`:s,d=document.createElement("div");d.className="fan-item flex items-center justify-between p-3 border border-gray-200 rounded-md",d.dataset.fanKey=t.key,d.innerHTML=`\n      <div class="truncate">\n        <span class="font-medium">${e(r)} ${e(a)}</span> - \n        <span class="text-gray-600 text-sm">${e(l)}</span>\n      </div>\n      <button class="fc-icon-restore text-lg js-restore-fan" data-fan-key="${e(t.key)}" title="恢复至图表">\n        <i class="fa-solid fa-rotate-left"></i>\n      </button>`,n.appendChild(d)}),requestAnimationFrame(()=>{try{"function"==typeof window.syncTopTabsViewportHeight&&window.syncTopTabsViewportHeight()}catch(e){}try{"function"==typeof window.prepareSidebarMarquee&&window.prepareSidebarMarquee()}catch(e){}})}function n(e){const n="function"==typeof window.safeClosest?window.safeClosest(e.target,".js-restore-fan"):e.target.closest?.(".js-restore-fan")||null;if(!n)return;const o=n.getAttribute("data-fan-key")||"";o?async function(e){if(e)try{if("function"==typeof window.ensureCanAdd&&!window.ensureCanAdd(1))return;const o=window.LocalState&&window.LocalState.getRecentlyRemoved&&window.LocalState.getRecentlyRemoved()||[],i=Array.isArray(o)?o.find(t=>t&&t.key===e):null;async function n(){try{window.LocalState?.removeFromRecentlyRemoved?.(e)}catch(e){}t(window.LocalState&&window.LocalState.getRecentlyRemoved&&window.LocalState.getRecentlyRemoved()||[]),"function"==typeof window.showInfo&&window.showInfo("该数据已不可用，已从“最近移除”列表剔除")}if(i&&Number.isInteger(i.model_id)&&Number.isInteger(i.condition_id))try{const a=await fetch("/api/curves",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairs:[{model_id:i.model_id,condition_id:i.condition_id}]})}),s=await a.json(),c="function"==typeof window.normalizeApiResponse?window.normalizeApiResponse(s):{ok:!0,data:s};if(c.ok){const l=c.data||{};if((Array.isArray(l.missing)?l.missing:[]).some(e=>String(e.model_id)===String(i.model_id)&&String(e.condition_id)===String(i.condition_id)))return void await n()}}catch(d){}const r=window.LocalState?.restoreKey?.(e);if(r&&r.ok){try{await(window.logNewPairs?.([r.item],"recover")||Promise.resolve())}catch(u){}"function"==typeof window.showSuccess&&window.showSuccess("已恢复"),"function"==typeof window.rebuildSelectedFans&&window.rebuildSelectedFans(window.LocalState?.getSelected?.()),"function"==typeof window.ensureLikeStatusBatch&&window.ensureLikeStatusBatch([{model_id:r.item.model_id,condition_id:r.item.condition_id}]),t(window.LocalState?.getRecentlyRemoved?.());try{window.syncQuickActionButtons?.()}catch(m){}try{window.applySidebarColors?.()}catch(f){}try{window.refreshChartFromLocal?.(!1)}catch(h){}}else r&&"already_selected"===r.reason?("function"==typeof window.showInfo&&window.showInfo("已在图表中，已从最近移除列表剔除"),t(window.LocalState?.getRecentlyRemoved?.())):await n()}catch(p){"function"==typeof window.showError&&window.showError("恢复失败: "+p.message)}}(o):"function"==typeof window.showError&&window.showError("缺少 fan_key")}let o=!1;function i(){o||(o=!0,document.addEventListener("click",n,!0))}i(),window.__APP.features.recentlyRemoved={mount:i,rebuild:t}}()},911(){!function(e,t){"use strict";const n="function"==typeof e.showLoading&&"function"==typeof e.hideLoading&&"function"==typeof e.showError&&"function"==typeof e.showSuccess&&"function"==typeof e.showInfo,o="function"==typeof e.normalizeApiResponse,i=!(!e.__APP||!e.__APP.cache),r="function"==typeof e.escapeHtml,a="function"==typeof e.formatScenario,s=(e,n)=>(n||t).querySelector(e);function c(t){return r?e.escapeHtml(t):String(t??"").replace(/[&<>"']/g,e=>({"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"}[e]))}function l(t,n){if(a)return e.formatScenario(t,n);const o=c(t||""),i=n??"";return""===String(i).trim()||"无"===String(i).trim()?o:`${o}(${c(i)})`}async function d(t,n){const i=await fetch(t,n),r=await i.json();if(o){const t=e.normalizeApiResponse(r);return t.ok?{ok:!0,data:t.data}:{ok:!1,error:t.error_message||"请求失败"}}return r&&!0===r.success?{ok:!0,data:r.data}:{ok:!1,error:r&&(r.error_message||r.message)||"请求失败"}}const u=(t,n)=>i?e.__APP.cache.get(t,n):null,m=(t,n,o,r)=>i?e.__APP.cache.set(t,n,o,r):o;function f(n,o,{root:i=n,margin:r=6,preferredMaxH:a=320,minMaxH:s=120,getWidth:c}={}){o.classList.contains("fc-portal")||o.classList.add("fc-portal"),o.parentNode!==t.body&&t.body.appendChild(o);let l=!1;function d(){const t=n.getBoundingClientRect();o.style.visibility="hidden",o.classList.remove("hidden");const i=e.innerHeight-t.bottom-r,l=t.top-r,d=i<160&&l>i,u=Math.max(s,Math.min(a,d?l:i)),m=Math.round("function"==typeof c?c(t):t.width);o.style.minWidth=m+"px",o.style.width=m+"px",o.style.maxHeight=Math.round(u)+"px",o.style.left=Math.round(t.left)+"px",o.style.top=d?Math.round(t.top-o.offsetHeight-r)+"px":Math.round(t.bottom+r)+"px";const f=o.getBoundingClientRect(),h=f.right-e.innerWidth;h>0&&(o.style.left=Math.round(t.left-h-4)+"px"),f.left<0&&(o.style.left="4px"),o.style.visibility=""}function u(){o.classList.add("hidden"),n.setAttribute("aria-expanded","false"),l&&(l=!1,e.removeEventListener("scroll",d,!0),e.removeEventListener("resize",d),t.removeEventListener("click",m,!0))}function m(e){const t=e.target;t&&(o.contains(t)||i&&i.contains&&i.contains(t)||u())}return{place:d,open:function(){t.querySelectorAll(".fc-custom-options").forEach(e=>{e!==o&&e.classList.add("hidden")}),d(),n.setAttribute("aria-expanded","true"),l||(l=!0,e.addEventListener("scroll",d,!0),e.addEventListener("resize",d,{passive:!0}),t.addEventListener("click",m,!0))},close:u,destroy:function(){u()}}}function h(e,{placeholder:n="-- 请选择 --",filter:o=e=>""!==e.value,renderLabel:i=e=>c(e?.text||""),renderOption:r=e=>i(e)}={}){if(!e||e._customBuilt)return{refresh:()=>{},setDisabled:()=>{},setValue:()=>{},getValue:()=>e?.value};e._customBuilt=!0,e.style.display="none";const a=t.createElement("div");a.className="fc-custom-select";const s=t.createElement("button");s.type="button",s.className="fc-custom-button fc-field border-gray-300",s.setAttribute("aria-expanded","false"),s.innerHTML=`<span class="truncate fc-custom-label">${c(n)}</span><i class="fa-solid fa-chevron-down ml-2 text-gray-500"></i>`;const l=t.createElement("div");l.className="fc-custom-options hidden fc-portal",a.appendChild(s),e.parentNode.insertBefore(a,e.nextSibling),t.body.appendChild(l);let d=n;function u(t){const n=Array.from(e.options).find(e=>String(e.value)===String(t));s.querySelector(".fc-custom-label").innerHTML=n?i(n):c(d)}function m(){const t=Array.from(e.options).filter(o).map(e=>`<div class="fc-option" data-value="${c(e.value)}">${r(e)}</div>`).join("");l.innerHTML=t||'<div class="px-3 py-2 text-gray-500">无可选项</div>',u(e.value)}!function(){try{const t=getComputedStyle(e),n=t.borderRadius||".375rem",o=t.fontSize||"14px";s.style.borderRadius=n,s.style.fontSize=o,l.style.borderRadius=n,l.style.fontSize=o}catch(e){}}(),e.addEventListener("change",()=>u(e.value)),m();const h=f(s,l,{root:a,getWidth:e=>e.width});return s.addEventListener("click",()=>{l.classList.contains("hidden")?h.open():h.close()}),l.addEventListener("click",t=>{const n=t.target.closest(".fc-option");if(!n)return;const o=n.dataset.value||"";e.value=o,e.dispatchEvent(new Event("change",{bubbles:!0})),u(o),h.close()}),{refresh(){m()},setDisabled(t,n={}){s.disabled=!!t,s.setAttribute("aria-disabled",t?"true":"false"),n.placeholder&&(d=String(n.placeholder),u(e.value)),t&&h.close()},setPlaceholder(t){d=String(t||n),u(e.value)},setValue(t){e.value=t,e.dispatchEvent(new Event("change",{bubbles:!0})),u(t),h.close()},getValue:()=>e.value}}const p={items:[],selected:new Set,get allChecked(){return this.items.length>0&&this.selected.size===this.items.length},clear(){this.items=[],this.selected.clear()}};function y(e){const t=s("#condPlaceholder"),n=s("#condList"),o=s("#conditionMulti");t&&o&&(t.textContent=e||"",t.classList.remove("hidden"),n&&n.classList.add("hidden"))}function g(){const e=function(){const e=s("#conditionMulti");if(!e)return null;const t=e.closest(".fc-form-row");return t&&t.querySelector("label")||null}();if(!e)return;if(!e.dataset.baseLabel){const t=(e.textContent||"").replace(/\s*\(\d+\)\s*$/,"");e.dataset.baseLabel=t}const t=e.dataset.baseLabel||"测试工况",n=p.selected.size;e.textContent=n>0?`${t} (${n})`:t}async function w(){const e=await d("/api/brands");return e.ok&&(e.data?.items||e.data)||[]}function b(){const o=s("#fanForm"),i=s("#brandSelect"),r=s("#modelSelect"),a=s("#conditionLoading");if(!o||!i||!r)return;const u=()=>{a&&(a.classList.add("hidden"),a.setAttribute("aria-hidden","true"))};u();const m=h(i,{placeholder:"-- 选择品牌 --"}),f=h(r,{placeholder:"-- 选择型号 --"});!async function(){try{const e=await w();i.innerHTML='<option value="">-- 选择品牌 --</option>'+e.map(e=>`<option value="${c(e.brand_id)}">${c(e.brand_name_zh)}</option>`).join(""),i.disabled=!1,m.refresh(),m.setDisabled(!1)}catch(e){}r.innerHTML='<option value="">-- 请先选择品牌 --</option>',r.value="",r.disabled=!0,f.refresh(),f.setDisabled(!0,{placeholder:"-- 请先选择品牌 --"}),y(" -- 请先选择品牌 --"),u()}(),i.addEventListener("change",async()=>{const e=i.value;if(u(),!e)return r.innerHTML='<option value="">-- 请先选择品牌 --</option>',r.value="",r.disabled=!0,f.refresh(),f.setDisabled(!0,{placeholder:"-- 请先选择品牌 --"}),p.clear(),void y("-- 请先选择品牌 --");r.innerHTML='<option value="">-- 选择型号 --</option>',r.value="",r.disabled=!0,f.refresh(),f.setDisabled(!0,{placeholder:"-- 选择型号 --"}),p.clear(),y("-- 请先选择型号 --"),u();try{(await async function(e){const t=await d(`/api/models_by_brand?brand_id=${encodeURIComponent(e)}`);return t.ok&&(t.data?.items||t.data)||[]}(e)).forEach(e=>{const n=t.createElement("option");n.value=e.model_id,n.textContent=e.model_name,r.appendChild(n)}),r.disabled=!1,f.refresh(),f.setDisabled(!1)}catch(e){}}),r.addEventListener("change",async()=>{const e=r.value;if(p.clear(),g(),!e)return y("-- 请先选择型号 --"),void u();y("加载中..."),a&&(a.classList.remove("hidden"),a.removeAttribute("aria-hidden"));try{const n=await async function(e){const t=await d(`/api/conditions_by_model?model_id=${encodeURIComponent(e)}`);return t.ok&&(t.data?.items||t.data)||[]}(e);Array.isArray(n)&&n.length?function(e){p.items=Array.isArray(e)?e.slice():[],p.selected.clear();const n=s("#condList");if(!n)return;const o=p.items.map(e=>{const t=c(e.condition_name_zh||""),n=l(e.resistance_type_zh,e.resistance_location_zh),o=n?`<span class="fc-cond-extra"> - ${n}</span>`:"";return{id:String(e.condition_id),html:`<span class="fc-cond-name">${t}</span>${o}`}});n.innerHTML=`\n      <div class="space-y-1">\n        <label class="flex items-center gap-2">\n          <input type="checkbox" id="cond_all" class="fc-checkbox">\n          <span>-- 全部 --</span>\n        </label>\n        ${o.map(e=>`\n          <label class="flex items-center gap-2">\n            <input type="checkbox" class="cond-item fc-checkbox" data-cond-id="${e.id}">\n            <span>${e.html}</span>\n          </label>\n        `).join("")}\n      </div>`;const i=s("#cond_all"),r=(a=n,Array.from((a||t).querySelectorAll(".cond-item")));var a;function d(){i&&(i.checked=p.allChecked,i.indeterminate=p.selected.size>0&&!p.allChecked),g()}function u(e){p.selected.clear(),e&&p.items.forEach(e=>p.selected.add(String(e.condition_id))),r.forEach(t=>t.checked=!!e),d()}i?.addEventListener("change",()=>u(i.checked)),r.forEach(e=>{e.addEventListener("change",()=>{const t=e.dataset.condId||"";e.checked?p.selected.add(t):p.selected.delete(t),d()})}),u(!1),function(){const e=s("#condPlaceholder"),t=s("#condList");e&&e.classList.add("hidden"),t&&t.classList.remove("hidden")}(),g()}(n):y("该型号暂无工况")}catch(e){y("加载失败，请重试")}finally{u()}}),function(){const o=s("#modelSearchInput"),i=s("#searchSuggestions");if(!o||!i)return;let a=null;o.addEventListener("input",()=>{clearTimeout(a);const s=o.value.trim();s.length<2?i.classList.add("hidden"):a=setTimeout(async()=>{try{const a=await fetch(`/search_models/${encodeURIComponent(s)}?raw=1`),c=await a.json(),l=Array.isArray(c)?c:[];if(i.innerHTML="",!l.length)return void i.classList.add("hidden");l.forEach(a=>{const s=t.createElement("div");s.className="cursor-pointer",s.textContent=a,s.addEventListener("click",async()=>{const t=a.split(" "),s=t[0],c=t.slice(1).join(" ");try{const e=(await w()||[]).find(e=>String(e.brand_name_zh)===String(s));if(!e)throw new Error("未找到品牌ID");m.setValue(e.brand_id),await new Promise((e,t)=>{const n=Date.now()+2e3;!function o(){const i=Array.from(r.options||[]).find(e=>e.textContent===c);i?e(i.value):Date.now()>n?t(new Error("未找到型号ID")):setTimeout(o,60)}()}).then(e=>{f.setValue(e)}),o.value="",i.classList.add("hidden")}catch(t){n&&e.showError("无法定位到该型号（ID 级联）")}}),i.appendChild(s)}),i.classList.remove("hidden")}catch(e){i.classList.add("hidden")}},280)}),t.addEventListener("click",e=>{o.contains(e.target)||i.contains(e.target)||i.classList.add("hidden")})}(),o.addEventListener("submit",async t=>{t.preventDefault();const o=r.value;if(!o)return void(n&&e.showError("请先选择型号"));const i=p.allChecked,a=Array.from(p.selected);if(i||0!==a.length){n&&e.showLoading("op","解析中...");try{let t=[];const r=await async function(e){const t={mode:"expand",model_id:e},n=await d("/api/search_fans",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(t)});if(!n.ok)throw new Error(n.error||"expand 请求失败");return(n.data&&n.data.items||[]).map(e=>({model_id:e.model_id,condition_id:e.condition_id}))}(Number(o));if(i)t=r;else{const e=new Set(a.map(String));t=r.filter(t=>e.has(String(t.condition_id)))}if(!t.length)return n&&e.hideLoading("op"),void(n&&e.showInfo("没有匹配数据"));let s=t;if("function"==typeof e.computeNewPairsAfterDedup){const o=e.computeNewPairsAfterDedup(t);if(0===o.length)return n&&e.hideLoading("op"),void(n&&e.showInfo("全部已存在，无新增"));s=o}if("function"==typeof e.ensureCanAdd&&!e.ensureCanAdd(s&&s.length||1))return void(n&&e.hideLoading("op"));const c=e.LocalState.addPairs(s);if(n&&e.hideLoading("op"),c.added>0){const t=(c.addedDetails||[]).map(e=>`${e.model_id}_${e.condition_id}`);"function"==typeof e.scheduleConditionalSuccessToast?e.scheduleConditionalSuccessToast(t,`新增 ${c.added} 组`):n&&e.showSuccess(`新增 ${c.added} 组`),"function"==typeof e.rebuildSelectedFans&&e.rebuildSelectedFans(e.LocalState.getSelected()),"function"==typeof e.ensureLikeStatusBatch&&e.ensureLikeStatusBatch(c.addedDetails.map(e=>({model_id:e.model_id,condition_id:e.condition_id}))),e.__APP?.features?.recentlyRemoved?.rebuild?.(e.LocalState.getRecentlyRemoved()),"function"==typeof e.syncQuickActionButtons&&e.syncQuickActionButtons(),"function"==typeof e.applySidebarColors&&e.applySidebarColors(),"function"==typeof e.refreshActiveChartFromLocalDebounced?e.refreshActiveChartFromLocalDebounced(!1):"function"==typeof e.refreshActiveChartFromLocal?e.refreshActiveChartFromLocal(!1):"function"==typeof e.refreshChartFromLocal&&e.refreshChartFromLocal(!1),e.__APP?.sidebar?.maybeAutoOpenSidebarOnAdd&&e.__APP.sidebar.maybeAutoOpenSidebarOnAdd()}else n&&e.showInfo("全部已存在，无新增");"function"==typeof e.logNewPairs&&Promise.resolve(e.logNewPairs(c.addedDetails,"direct")).catch(()=>{})}catch(t){n&&e.hideLoading("op"),n&&e.showError("添加失败: "+(t&&t.message?t.message:t))}}else n&&e.showError("请选择测试工况")})}function _(){(function(){const i=s("#searchForm"),r=s("#conditionFilterSelect");if(!i||!r)return;!async function(){r.disabled=!0,r.innerHTML='<option value="">-- 选择测试工况 --</option>';let e=null;try{const n=await fetch("/get_conditions?raw=1"),o=await n.json(),i=Array.isArray(o)?o:[];i.forEach(e=>{const n=t.createElement("option");n.value=String(e.condition_id);const o=l(e.resistance_type_zh,e.resistance_location_zh),i=e.condition_name_zh||"";n.textContent=o?`${i} - ${o}`:i,r.appendChild(n)}),e=function(e,n){if(!e||e._customBuilt)return{setDisabled:()=>{}};e._customBuilt=!0,e.style.display="none";const o=t.createElement("div");o.className="fc-custom-select";const i=t.createElement("button");i.type="button",i.className="fc-custom-button fc-field border-gray-300",i.setAttribute("aria-expanded","false"),i.innerHTML='\n    <span class="truncate fc-custom-label">-- 选择测试工况 --</span>\n    <i class="fa-solid fa-chevron-down ml-2 text-gray-500"></i>\n  ';const r=t.createElement("div");function a(e){const t=(n||[]).find(t=>String(t.condition_id)===String(e)),o=i.querySelector(".fc-custom-label");if(!t)return void(o.innerHTML="-- 选择测试工况 --");const r=c(t.condition_name_zh||""),a=l(t.resistance_type_zh,t.resistance_location_zh);o.innerHTML=`${r}${a?`<span class="fc-cond-extra"> - ${a}</span>`:""}`}r.className="fc-custom-options hidden fc-portal",r.innerHTML=(n||[]).map(e=>{const t=String(e.condition_id),n=c(e.condition_name_zh||""),o=l(e.resistance_type_zh,e.resistance_location_zh);return`<div class="fc-option" data-value="${t}">\n              <span class="fc-cond-name">${n}</span>${o?`<span class="fc-cond-extra"> - ${o}</span>`:""}\n            </div>`}).join("")||'<div class="px-3 py-2 text-gray-500">无可选项</div>',e.parentNode.insertBefore(o,e.nextSibling),o.appendChild(i),t.body.appendChild(r),function(){try{const t=getComputedStyle(e),n=t.borderRadius||".375rem",o=t.fontSize||"14px";i.style.borderRadius=n,i.style.fontSize=o,r.style.borderRadius=n,r.style.fontSize=o}catch(e){}}(),e.addEventListener("change",()=>a(e.value)),a(e.value||"");const s=f(i,r,{root:o,getWidth:e=>e.width});return i.addEventListener("click",()=>{r.classList.contains("hidden")?s.open():s.close()}),r.addEventListener("click",t=>{const n=t.target.closest(".fc-option");if(!n)return;const o=n.dataset.value||"";e.value=o,e.dispatchEvent(new Event("change",{bubbles:!0})),a(o),s.close()}),{setDisabled(e){i.disabled=!!e,i.setAttribute("aria-disabled",e?"true":"false"),e&&s.close()}}}(r,i)}catch(e){}finally{r.disabled=!1,e&&e.setDisabled(!1)}}();const a=i.querySelector('select[name="size_filter"]');a&&h(a,{placeholder:"尺寸(mm)"});const p=i.querySelector("#sortBySelect");p&&h(p,{placeholder:"限制条件"});const y=i.querySelector('select[name="rgb_light"]');y&&async function(){try{const e=await d("/api/rgb_options");(e.ok&&e.data?.items||[]).forEach(e=>{const n=t.createElement("option");n.value=e,n.textContent=e,y.appendChild(n)})}catch(e){console.warn("[RGB] Failed to load rgb_options:",e)}h(y,{placeholder:"不限"})}(),i.addEventListener("submit",async a=>{a.preventDefault();const s=r&&r.value?String(r.value).trim():"";if(!s)return void(n&&e.showError("请选择测试工况"));if(!/^\d+$/.test(s))return void(n&&e.showError("工况选项未正确初始化，请刷新页面"));const c=new FormData(i),l={};c.forEach((e,t)=>l[t]=e),l.condition_id=Number(s),delete l.condition,delete l.condition_name,l.rgb_light&&"不限"!==l.rgb_light||delete l.rgb_light;const d="search",f=async()=>{const t=await fetch("/api/search_fans",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(l)}),n=await t.json();if(o){const t=e.normalizeApiResponse(n);if(!t.ok)return{success:!1,error_message:t.error_message};const o=t.data||{};return{success:!0,search_results:o.search_results,condition_label:o.condition_label}}{if(!n||!0!==n.success)return{success:!1,error_message:n&&n.error_message||"搜索失败"};const e=n.data||{};return{success:!0,search_results:e.search_results,condition_label:e.condition_label}}},h=u(d,l);if(h)e.__APP?.modules?.search?.render?e.__APP.modules.search.render(h.search_results,h.condition_label):"function"==typeof e.renderSearchResults&&e.renderSearchResults(h.search_results,h.condition_label),t.querySelector('.fc-tabs[data-tab-group="right-panel"] .fc-tabs__item[data-tab="search-results"]')?.click(),n&&e.showInfo("已使用缓存结果..."),(async t=>{try{const o=await f();o.success&&(m(d,l,o),t&&JSON.stringify(t.search_results)===JSON.stringify(o.search_results)||(e.__APP?.modules?.search?.render?e.__APP.modules.search.render(o.search_results,o.condition_label):"function"==typeof e.renderSearchResults&&e.renderSearchResults(o.search_results,o.condition_label),n&&e.showInfo("已刷新最新结果")))}catch(e){}})(h);else{n&&e.showLoading("op","搜索中...");try{const o=await f();if(!o.success)return n&&e.hideLoading("op"),void(n&&e.showError(o.error_message||"搜索失败"));m(d,l,o),e.__APP?.modules?.search?.render?e.__APP.modules.search.render(o.search_results,o.condition_label):"function"==typeof e.renderSearchResults&&e.renderSearchResults(o.search_results,o.condition_label),n&&e.hideLoading("op"),n&&e.showSuccess("搜索完成"),t.querySelector('.fc-tabs[data-tab-group="right-panel"] .fc-tabs__item[data-tab="search-results"]')?.click()}catch(t){n&&e.hideLoading("op"),n&&e.showError("搜索异常: "+t.message)}}})})(),b()}"loading"===t.readyState?t.addEventListener("DOMContentLoaded",_,{once:!0}):_(),e.FancoolSearch={init:_,_debug:{CondState:p}}}(window,document)},946(){window.APP_CONFIG=window.APP_CONFIG||{clickCooldownMs:500,maxItems:0,spectrumDockEnabled:!1,playAudioEnabled:!1},window.__APP=window.__APP||{};const e=window.APP_CONFIG&&window.APP_CONFIG.maxItems||8,t=3e5;function n(){try{const e=window.__APP&&window.__APP.features&&window.__APP.features.recentlyRemoved;if(!e||!e.rebuild)return!1;if(e.__ID_PATCHED__)return!0;const t=e.rebuild;return e.rebuild=function(e){const n=(e||[]).map(e=>{const t=window.DisplayCache&&window.DisplayCache.get(e.model_id,e.condition_id);return{...e,brand:t?.brand||"",model:t?.model||"",condition:t?.condition||"加载中..."}});return t(n)},e.__ID_PATCHED__=!0,!0}catch(e){return!1}}function o(e){const{containerId:t,group:n,persistKey:o,vertical:i=!1,onActiveChange:r,clickScrollBehavior:a="smooth",defaultTab:s}=e||{},c=document.getElementById(t),l=document.querySelector(`.fc-tabs[data-tab-group="${n}"]`);if(!c||!l)return;const d=Array.from(l.querySelectorAll(".fc-tabs__item"));if(!d.length)return;function u(e,t=!0,n=!1){e=Math.max(0,Math.min(e,d.length-1)),d.forEach((t,n)=>t.classList.toggle("active",n===e));const s=d[e]?.dataset.tab;if(n||function(e,t=!0){const n=i?c.clientHeight:c.clientWidth;c.scrollTo({[i?"top":"left"]:n*e,behavior:t?a:"auto"})}(e,t),o&&s)try{localStorage.setItem(o,s)}catch(e){}"function"==typeof r&&s&&r(s)}l.addEventListener("click",e=>{const t=e.target.closest(".fc-tabs__item");if(!t)return;const n=d.indexOf(t);n<0||u(n,!0,!1)}),c.addEventListener("scroll",()=>{clearTimeout(c._snapTimer),c._snapTimer=setTimeout(()=>{const e=i?c.clientHeight||1:c.clientWidth||1;u(Math.round((i?c.scrollTop:c.scrollLeft)/e),!1,!0)},80)},{passive:!0});let m=0;if(o)try{const e=localStorage.getItem(o);if(e){const t=d.findIndex(t=>t.dataset.tab===e);t>=0&&(m=t)}}catch(e){}if(0===m&&s){const e=d.findIndex(e=>e.dataset.tab===s);e>=0&&(m=e)}if(0===m){const e=d.findIndex(e=>e.classList.contains("active"));e>=0&&(m=e)}requestAnimationFrame(()=>u(m,!1,!1))}!function(){function t(){const t=document.getElementById("maxItemsLabel");t&&!t.dataset._inited&&(t.textContent=e,t.dataset._inited="1")}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",t,{once:!0}):t()}(),async function(){try{const e=await fetch("/api/config"),t=v(await e.json());if(t.ok){const e=t.data||{};if(window.APP_CONFIG.clickCooldownMs=e.click_cooldown_ms??window.APP_CONFIG.clickCooldownMs,window.APP_CONFIG.recentLikesLimit=e.recent_likes_limit??50,window.APP_CONFIG.spectrumDockEnabled=!!e.spectrum_dock_enabled,window.APP_CONFIG.playAudioEnabled=!!e.play_audio_enabled,window.ChartRenderer&&"function"==typeof window.ChartRenderer.__ensureDock){const e=window.__forceSpectrumDockFromUrl?.();(window.APP_CONFIG.spectrumDockEnabled||e)&&window.ChartRenderer.__ensureDock()}}}catch(e){}}(),window.DisplayCache=function(){const e=new Map;function t(e,t){return`${Number(e)}_${Number(t)}`}return{setFromSeries(n){(n||[]).forEach(n=>{const o=n.model_id,i=n.condition_id;null!=o&&null!=i&&e.set(t(o,i),{brand:n.brand||n.brand_name_zh||"",model:n.model||n.model_name||"",condition:n.condition||n.condition_name_zh||"",rt:n.resistance_type||n.resistance_type_zh||n.res_type||n.rt||"",rl:n.resistance_location||n.resistance_location_zh||n.res_loc||n.rl||""})})},setFromMeta(n){(n||[]).forEach(n=>{const o=n.model_id,i=n.condition_id;null!=o&&null!=i&&e.set(t(o,i),{brand:n.brand_name_zh||"",model:n.model_name||"",condition:n.condition_name_zh||"",rt:n.resistance_type_zh||"",rl:n.resistance_location_zh||""})})},get:(n,o)=>e.get(t(n,o))||null,clear(){e.clear()}}}(),n(),function(){const e=Object.create(null);window.__APP.dom={one:function(t,n){if(!t)return null;if(!n&&e[t])return e[t];const o=(n||document).querySelector(t);return n||(e[t]=o),o},all:function(e,t){return Array.from((t||document).querySelectorAll(e))},clear:function(t){t?delete e[t]:Object.keys(e).forEach(t=>delete e[t])}}}(),window.__APP.scheduler=function(){const e=[];let t=!1;function n(){t=!1;for(let t=0;t<e.length;t++)try{e[t]()}catch(e){console.error("[scheduler write error]",e)}e.length=0}return{write:function(o){e.push(o),t||(t=!0,requestAnimationFrame(n))}}}(),window.__APP.cache=function(){const e=new Map;function t(e,t){return e+"::"+JSON.stringify(t||{})}return{get:function(n,o){const i=t(n,o),r=e.get(i);return r?Date.now()>r.expire?(e.delete(i),null):r.value:null},set:function(n,o,i,r=18e4){const a=t(n,o);return e.set(a,{value:i,expire:Date.now()+r}),i},clear:function(t){if(t)for(const n of e.keys())n.startsWith(t+"::")&&e.delete(n);else e.clear()}}}();const i=e=>window.__APP.dom.one(e);"undefined"!=typeof Element&&(Element.prototype.matches||(Element.prototype.matches=Element.prototype.msMatchesSelector||Element.prototype.webkitMatchesSelector||function(e){const t=(this.document||this.ownerDocument).querySelectorAll(e);let n=0;for(;t[n]&&t[n]!==this;)n++;return!!t[n]}),Element.prototype.closest||(Element.prototype.closest=function(e){let t=this;for(;t&&1===t.nodeType;){if(t.matches(e))return t;t=t.parentElement}return null})),window.safeClosest=function(e,t){if(!e)return null;let n=e;if(n.nodeType&&1!==n.nodeType&&(n=n.parentElement),!n)return null;if(n.closest)try{return n.closest(t)}catch(e){}for(;n&&1===n.nodeType;){if(n.matches&&n.matches(t))return n;n=n.parentElement}return null},setInterval(function(){try{if(!LocalState.likes.needRefresh(t))return;fetch("/api/like_status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairs:[]})}).then(e=>e.json()).then(e=>{const t=v(e);if(!t.ok)return;const n=t.data||{};n.fp&&(LocalState.likes.updateServerFP(n.fp),LocalState.likes.logCompare())}).catch(()=>{})}catch(e){}},18e4);const r="toastContainer";let a=0;const s=new Set;function c(e,t="info",n={}){var o;t=["success","error","loading","info"].includes(o=t)?o:"info";const i=function(){let e=document.getElementById(r);return e||(e=document.createElement("div"),e.id=r,document.body.appendChild(e)),e}(),{autoClose:s="loading"!==t&&2600,id:c="t_"+ ++a}=n;for(;document.getElementById(c);)document.getElementById(c).remove();const d={success:'<i class="icon fa-solid fa-circle-check" style="color:var(--toast-success)"></i>',error:'<i class="icon fa-solid fa-circle-xmark" style="color:var(--toast-error)"></i>',loading:'<i class="icon fa-solid fa-spinner fa-spin" style="color:var(--toast-loading)"></i>',info:'<i class="icon fa-solid fa-circle-info" style="color:#3B82F6"></i>'},u=document.createElement("div");return u.className="fc-toast fc-toast--"+t,u.id=c,u.innerHTML=`${d[t]||d.info}<div class="msg">${e}</div><span class="fc-toast__close" data-close="1">&times;</span>`,i.appendChild(u),s&&setTimeout(()=>l(c),s),c}function l(e){const t=document.getElementById(e);t&&(t.style.animation="toast-out .25s forwards",setTimeout(()=>t.remove(),240))}document.addEventListener("click",e=>{if(e.target.closest&&e.target.closest("[data-close]")){const t=e.target.closest(".fc-toast");t&&l(t.id)}});const d=new Map;function u(e,t="加载中..."){if(s.has(e)){const n=document.getElementById("loading_"+e);if(n){const e=n.querySelector(".msg");e&&(e.textContent=t)}return}s.add(e),c(t,"loading",{id:"loading_"+e});const n=setTimeout(()=>{s.has(e)&&m(e)},12e3);d.set(e,n)}function m(e){s.delete(e);const t="loading_"+e,n=document.getElementById(t);n&&n.remove();const o=d.get(e);o&&(clearTimeout(o),d.delete(e))}const f=e=>c(e,"success"),h=e=>c(e,"error"),p=e=>c(e,"info",{autoClose:1800});window.showLoading=u,window.hideLoading=m,window.showSuccess=f,window.showError=h,window.showInfo=p;let y=0;const g=new Set(["add","remove","restore","xaxis"]),w={"&":"&amp;","<":"&lt;",">":"&gt;",'"':"&quot;","'":"&#39;"};function b(e){return String(e??"").replace(/[&<>"']/g,e=>w[e])}function _(e){const t={"&amp;":"&","&lt;":"<","&gt;":">","&quot;":'"',"&#39;":"'"};return String(e??"").replace(/&(amp|lt|gt|quot|#39);/g,e=>t[e])}function v(e){return e&&"object"==typeof e?!0===e.success?{ok:!0,data:e.data,raw:e}:!1===e.success?{ok:!1,error_code:e.error_code||"ERR",error_message:e.error_message||"操作失败",raw:e}:{ok:!1,error_code:"LEGACY_FORMAT",error_message:"不支持的旧响应格式",raw:e}:{ok:!1,error_code:"INVALID",error_message:"响应格式错误",raw:e}}function x(e){return e&&"object"==typeof e&&(e.like_keys||e.liked_keys)||[]}window.escapeHtml=b,window.unescapeHtml=_,window.normalizeApiResponse=v;let S=null,A="rpm";function L(){const e=document.getElementById("chart-settings")||document.body;let t="";try{t=getComputedStyle(e).backgroundColor}catch(e){}if(!t||"rgba(0, 0, 0, 0)"===t||"transparent"===t)try{t=getComputedStyle(document.body).backgroundColor}catch(e){}return t&&"rgba(0, 0, 0, 0)"!==t?t:"#ffffff"}function E(e){S=e;const t=function(e){if(te&&!ne&&e&&e.x_axis_type){A="noise"===e.x_axis_type?"noise_db":e.x_axis_type;try{localStorage.setItem("x_axis_type",A)}catch(e){}ne=!0}const t=(e.series||[]).map(e=>({...e,color:ColorManager.getColor(e.key),color_index:ColorManager.getIndex(e.key)}));return{...e,x_axis_type:A,series:t}}(e),n={chartData:t,theme:"dark"===document.documentElement.getAttribute("data-theme")?"dark":"light",chartBg:L()};ee&&(n.shareMeta=ee,ee=null),window.ChartRenderer&&"function"==typeof ChartRenderer.render&&ChartRenderer.render(n)}function M(){window.ChartRenderer&&"function"==typeof ChartRenderer.resize&&ChartRenderer.resize()}!function(){try{const e=localStorage.getItem("x_axis_type");"rpm"!==e&&"noise_db"!==e&&"noise"!==e||(A="noise"===e?"noise_db":e)}catch(e){}}(),window.applySidebarColors=function(){const e=window.__APP.dom.all("#selectedFansList .fan-item");window.__APP.scheduler.write(()=>{e.forEach(e=>{const t=e.getAttribute("data-fan-key"),n=e.querySelector(".js-color-dot");t&&n&&(n.style.backgroundColor=ColorManager.getColor(t))})})};let C=!1,k=0;const P=i("#recentLikesList");function $(){const e=LocalState.likes.getServerFP&&LocalState.likes.getServerFP();return!(!e||e.c>=20||LocalState.likes.isSynced()&&LocalState.likes.shouldSkipStatus(t))}function F(){F._pending||(F._pending=!0,fetch("/api/like_keys").then(e=>e.json()).then(e=>{const t=v(e);if(!t.ok)return;const n=t.data||{},o=x(n);Array.isArray(o)&&(LocalState.likes.setAll(o),o.forEach(e=>{const[t,n]=e.split("_");t&&n&&ce(t,n,!0)})),n.fp&&LocalState.likes.updateServerFP(n.fp),LocalState.likes.logCompare()}).catch(()=>{}).finally(()=>{F._pending=!1}))}async function N(e){if(!Array.isArray(e)||!e.length)return;if($())return void F();const n=window.APP_CONFIG.recentLikesLimit||50,o=[],i=new Set;for(const t of e){if(!t)continue;const e=Number(t.model_id),n=Number(t.condition_id);if(!Number.isInteger(e)||!Number.isInteger(n))continue;const r=`${e}_${n}`;LocalState.likes.has(r)||i.has(r)||(i.add(r),o.push({model_id:e,condition_id:n}))}if(o.length&&!(C&&k<n||LocalState.likes.shouldSkipStatus(t)))if($())F();else try{const e=await fetch("/api/like_status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairs:o})});if(!e.ok)return;const t=v(await e.json());if(!t.ok)return;const n=t.data||{};n.fp&&(LocalState.likes.updateServerFP(n.fp),LocalState.likes.logCompare());const i=x(n);if(!i.length)return;i.forEach(e=>{if(!LocalState.likes.has(e)){LocalState.likes.add(e);const[t,n]=e.split("_");t&&n&&ce(t,n,!0)}})}catch(e){}}function T(){u("recent-likes","加载最近点赞..."),fetch("/api/recent_likes").then(e=>e.json()).then(e=>{const t=v(e);if(!t.ok)return void h(t.error_message||"获取最近点赞失败");const n=t.data||{};n.fp&&(LocalState.likes.updateServerFP(n.fp),LocalState.likes.logCompare());const o=n.items||n.data||[];C=!0,k=o.length;let i=!1;o.forEach(e=>{if(null!=e.model_id&&null!=e.condition_id){const t=`${e.model_id}_${e.condition_id}`;LocalState.likes.has(t)||(LocalState.likes.add(t),i=!0)}}),i&&o.forEach(e=>{null!=e.model_id&&null!=e.condition_id&&ce(e.model_id,e.condition_id,!0)}),function(e){const t=P;if(!t)return;if(t.innerHTML="",!Array.isArray(e)||0===e.length)return t.innerHTML='<p class="text-gray-500 text-center py-6">暂无最近点赞</p>',void requestAnimationFrame(pe);const n=new Map;e.forEach(e=>{const t=e.brand_name_zh||e.brand||"",o=e.model_name||e.model||"",i=`${t}||${o}`;n.has(i)||n.set(i,{brand:t,model:o,maxSpeed:e.max_speed||e.max_rpm||e.rpm_max||"",size:e.size||e.frame_size||e.diameter||"",thickness:e.thickness||e.frame_thickness||"",scenarios:[]}),n.get(i).scenarios.push({mid:e.model_id,cid:e.condition_id,condition:e.condition_name_zh||e.condition||"",rt:e.resistance_type_zh||e.rt||"",rl:e.resistance_location_zh||e.rl||""})});const o=document.createDocumentFragment();n.forEach(e=>{const t=[];e.maxSpeed&&t.push(`${b(e.maxSpeed)} RPM`),e.size&&e.thickness&&t.push(`${b(e.size)}x${b(e.thickness)}`);const n=t.join(" · "),i=e.scenarios.map(t=>{const n=ve(t.rt,t.rl);return`\n        <div class="flex items-center justify-between scenario-row">\n          <div class="scenario-text text-sm text-gray-700">${b(n?`${t.condition} - ${n}`:t.condition)}</div>\n          <div class="actions">\n            <button type="button" class="like-button recent-like-button"\n                    data-tooltip="取消点赞"\n                    data-model-id="${b(t.mid||"")}"\n                    data-condition-id="${b(t.cid||"")}">\n              <i class="fa-solid fa-thumbs-up text-red-500"></i>\n            </button>\n            ${U("likes",e.brand,e.model,t.mid,t.cid,t.condition,"liked")}\n          </div>\n        </div>`}).join(""),r=document.createElement("div");r.className="recent-like-group p-3 border border-gray-200 rounded-md",r.innerHTML=`\n      <div class="fc-group-header">\n        <div class="fc-title-wrap flex items-center min-w-0">\n          <div class="truncate font-medium">${b(e.brand)} ${b(e.model)}</div>\n        </div>\n        <div class="fc-meta-right text-sm text-gray-600">${n}</div>\n      </div>\n      <div class="group-scenarios mt-2 space-y-1">${i}</div>`,o.appendChild(r)}),t.appendChild(o),G(),requestAnimationFrame(()=>{be(),pe()})}(o)}).catch(e=>h("获取最近点赞异常: "+e.message)).finally(()=>m("recent-likes"))}function I(e,t,n=!1){if("sidebar-top"===e||"left-panel"===e||"right-panel"===e&&window.__RIGHT_PANEL_SNAP_ON)return;const o=document.querySelector(`.fc-tabs[data-tab-group="${e}"]`),i=document.getElementById(`${e}-wrapper`);if(!o||!i)return;const r=[...o.querySelectorAll(".fc-tabs__item")];"right-panel"!==e||n||(t=r[0]?.dataset.tab||t);let a=r.findIndex(e=>e.dataset.tab===t);a<0&&(a=0,t=r[0]?.dataset.tab||""),r.forEach((e,t)=>e.classList.toggle("active",t===a));const s=50*a;n||(i.style.transition="none"),i.style.transform=`translateX(-${s}%)`,n||setTimeout(()=>i.style.transition="",50),"right-panel"!==e&&localStorage.setItem("activeTab_"+e,t),"right-panel"===e&&(window.RightPanel?.updateSubseg?.(t),"recent-updates"===t&&window.RightPanel?.recentUpdates?.loadIfNeeded?.())}function q(){const e=document.querySelector("#top-panel .fc-tab-container");if(!e)return;const t=function(){const e=document.querySelector("#top-panel .fc-sidebar-panel__content"),t=e?e.querySelector("nav.fc-tabs"):null;if(!e||!t)return 0;const n=getComputedStyle(e),o=parseFloat(n.paddingBottom)||0,i=getComputedStyle(t),r=parseFloat(i.marginBottom)||0,a=Math.ceil(t.getBoundingClientRect().height),s=e.clientHeight-a-r-o;return Math.max(0,Math.floor(s))}();e.style.height=(t>0?t:0)+"px"}document.addEventListener("click",e=>{const t=safeClosest(e.target,".fc-tabs .fc-tabs__item");if(!t)return;const n=t.closest(".fc-tabs"),o=n?.dataset?.tabGroup;o&&"right-panel"!==o&&I(o,t.dataset.tab,!0)}),function(){["left-panel","right-panel"].forEach(e=>{if("right-panel"===e)return;const t=localStorage.getItem("activeTab_"+e),n=document.querySelector(`.fc-tabs[data-tab-group="${e}"] .fc-tabs__item`)?.dataset.tab||"";I(e,t||n,!1)});const e=document.querySelector('.fc-tabs[data-tab-group="sidebar-top"] .fc-tabs__item.active')?.dataset.tab;e&&I("sidebar-top",e,!1)}(),function(){const e=document.querySelector("#top-panel .fc-sidebar-panel__content");e&&"ResizeObserver"in window&&new ResizeObserver(()=>requestAnimationFrame(q)).observe(e),q(),window.addEventListener("resize",()=>requestAnimationFrame(q)),document.addEventListener("mouseup",()=>requestAnimationFrame(q))}();try{window.__APP?.sidebar?.refreshToggleUI?.()}catch(e){}const R=i("#themeToggle"),B=i("#themeIcon");let D=window.ThemePref&&"function"==typeof window.ThemePref.resolve?window.ThemePref.resolve():document.documentElement.getAttribute("data-theme")||"light",H=0;function O(e){const t=document.documentElement,n=(t.getAttribute("data-theme"),++H);if("dark"===e)t.style.removeProperty("--bg-primary"),function(){const e=Math.floor(360*Math.random()),t=(e+(30+Math.floor(60*Math.random())))%360,n=35+25*Math.random(),o=35+25*Math.random(),i=10+8*Math.random(),r=14+12*Math.random(),a=Math.floor(360*Math.random()),s=`hsl(${e} ${n.toFixed(1)}% ${i.toFixed(1)}%)`,c=`hsl(${t} ${o.toFixed(1)}% ${r.toFixed(1)}%)`,l=`linear-gradient(${a}deg, ${s} 0%, ${c} 100%)`,d=document.documentElement;d.style.setProperty("--dark-rand-gradient",l);const u=i<=r;d.style.setProperty("--dark-rand-base",u?s:c)}(),t.style.setProperty("--grad-opacity","1"),requestAnimationFrame(()=>{t.setAttribute("data-theme","dark"),setTimeout(()=>{n===H&&t.style.removeProperty("--grad-opacity")},0)});else{t.style.setProperty("--bg-primary","#f9fafb"),t.style.setProperty("--grad-opacity","1");const e=(getComputedStyle(t).getPropertyValue("--dark-rand-gradient")||"").trim();e&&"none"!==e&&t.style.setProperty("--dark-rand-gradient",e),requestAnimationFrame(()=>{t.setAttribute("data-theme","light"),requestAnimationFrame(()=>{t.style.setProperty("--grad-opacity","0"),setTimeout(()=>{n===H&&(t.style.removeProperty("--grad-opacity"),t.style.removeProperty("--bg-primary"),t.style.removeProperty("--dark-rand-gradient"))},520)})})}B&&(B.className="dark"===e?"fa-solid fa-sun":"fa-solid fa-moon"),window.ThemePref&&"function"==typeof window.ThemePref.save&&window.ThemePref.save(e,{notifyServer:!1}),requestAnimationFrame(()=>{requestAnimationFrame(()=>{S?E(S):M(),q()})})}O(D),window.__APP_THEME_BOUND__||(window.__APP_THEME_BOUND__=!0,R?.addEventListener("click",()=>{D="light"===D?"dark":"light",O(D),window.applySidebarColors(),S?E(S):M(),requestAnimationFrame(q)}));let z=new Set,j=new Set,W=new Set;function X(){W.clear();try{(LocalState.getSelectionPairs()||[]).forEach(e=>{e&&null!=e.model_id&&null!=e.condition_id&&W.add(`${e.model_id}_${e.condition_id}`)})}catch(e){}}function V(){z.clear(),j.clear(),window.__APP.dom.all("#selectedFansList .fan-item").forEach(e=>{const t=e.getAttribute("data-fan-key");t&&j.add(t);const n=e.getAttribute("data-map");n&&z.add(n)})}function U(e,t,n,o,i,r,a){const s=`${b(t)}||${b(n)}||${b(r||"")}`,c=null!=o&&null!=i&&""!==String(o)&&""!==String(i)?W.has(`${String(o)}_${String(i)}`):z.has(s);let l;return l=c?"js-list-remove":"search"===e?"js-search-add":"rating"===e?"js-rating-add":"ranking"===e?"js-ranking-add":"js-likes-add",`\n    <button type="button" class="fc-btn-icon-add ${l} fc-tooltip-target"\n            data-tooltip="${c?"从图表移除":"添加到图表"}"\n            data-mode="${c?"remove":"add"}"\n            data-add-type="${e}"\n            data-log-source="${b(a||{likes:"liked",rating:"top_rating",ranking:"top_query",search:"search"}[e]||"unknown")}"\n            data-brand="${b(t)}"\n            data-model="${b(n)}"\n            data-condition="${b(r||"")}"\n            ${o?`data-model-id="${b(o)}"`:""}\n            ${i?`data-condition-id="${b(i)}"`:""}>\n      <i class="fa-solid fa-plus"></i>\n    </button>`}function G(){window.__APP.dom.all(".fc-btn-icon-add.fc-tooltip-target").forEach(e=>{e.dataset.addType||(e.classList.contains("js-rating-add")?e.dataset.addType="rating":e.classList.contains("js-ranking-add")?e.dataset.addType="ranking":e.classList.contains("js-search-add")?e.dataset.addType="search":e.classList.contains("js-likes-add")&&(e.dataset.addType="likes"));const t=e.dataset;let n=!1;if(t.modelId&&t.conditionId)n=W.has(`${t.modelId}_${t.conditionId}`);else{const e=function(e){return`${_(e.brand||"")}||${_(e.model||"")}||${_(e.condition||"")}`}(t);n=z.has(e)}n?function(e){e.dataset.mode="remove",e.classList.remove("js-ranking-add","js-rating-add","js-search-add","js-likes-add"),e.classList.add("js-list-remove"),e.setAttribute("data-tooltip","从图表移除"),e.removeAttribute("title"),e.querySelector("i")?e.querySelector("i").className="fa-solid fa-plus":e.innerHTML='<i class="fa-solid fa-plus"></i>'}(e):function(e){const t=e.dataset.addType||(e.classList.contains("js-rating-add")?"rating":e.classList.contains("js-ranking-add")?"ranking":e.classList.contains("js-search-add")?"search":"likes");e.dataset.mode="add",e.classList.remove("js-list-remove","js-ranking-add","js-rating-add","js-search-add","js-likes-add"),e.classList.add("rating"===t?"js-rating-add":"ranking"===t?"js-ranking-add":"search"===t?"js-search-add":"js-likes-add"),e.setAttribute("data-tooltip","添加到图表"),e.removeAttribute("title"),e.querySelector("i")?e.querySelector("i").className="fa-solid fa-plus":e.innerHTML='<i class="fa-solid fa-plus"></i>'}(e)})}V(),X(),window.buildQuickBtnHTML=U;const K=i("#selectedFansList"),J=(i("#recentlyRemovedList"),i("#selectedCount")),Y=i("#clearAllContainer"),Q=i("#clearAllBtn");function Z(e){if(Array.isArray(e)||(e=LocalState.getSelected()),K.innerHTML="",ColorManager.assignUniqueIndices((e||[]).map(e=>e.key)),!e||0===e.length)return J.textContent="0",Y?.classList.add("hidden"),V(),X(),requestAnimationFrame(me),ge(),void(G&&G());e.forEach(e=>{const t=`${e.model_id}_${e.condition_id}`,n=DisplayCache.get(e.model_id,e.condition_id),o=n?.brand||"",i=n?.model||"",r=n?.condition||"加载中...",a=ve(n?.rt,n?.rl),s=a?`${r} - ${a}`:r,c=LocalState.likes.has(t),l=document.createElement("div");l.className="fan-item flex items-center justify-between p-3 border border-gray-200 rounded-md",l.dataset.fanKey=e.key,l.dataset.map=`${o}||${i}||${s}`,l.innerHTML=`\n      <div class="flex items-center min-w-0">\n        <div class="w-3 h-3 rounded-full mr-2 flex-shrink-0 js-color-dot"></div>\n        <div class="truncate">\n          <span class="font-medium">${b(o)} ${b(i)}</span> - \n          <span class="text-gray-600 text-sm">${b(s)}</span>\n        </div>\n      </div>\n      <div class="flex items-center flex-shrink-0">\n        <button type="button" class="like-button mr-3" data-fan-key="${e.key}" data-model-id="${e.model_id}" data-condition-id="${e.condition_id}">\n          <i class="fa-solid fa-thumbs-up ${c?"text-red-500":"text-gray-400"}"></i>\n        </button>\n        <button type="button" class="fc-icon-remove text-lg js-remove-fan" data-fan-key="${e.key}" data-tooltip="移除">\n          <i class="fa-solid fa-xmark"></i>\n        </button>\n      </div>`,K.appendChild(l);const d=l.querySelector(".js-color-dot");d&&(d.style.backgroundColor=ColorManager.getColor(e.key))}),J.textContent=e.length.toString(),Y?.classList.remove("hidden"),V(),X(),requestAnimationFrame(me),ge(),G&&G()}let ee=null,te=function(){try{return"1"===new URLSearchParams(window.location.search).get("share_loaded")}catch(e){return!1}}(),ne=!1;const oe=i("#searchAirflowTbody"),ie=i("#searchLikesTbody");let re=[];function ae(e,t){if(!e)return;if(Array.from(e.querySelectorAll(".fc-marquee-cell")).forEach(e=>{e.classList.remove("fc-marquee-cell","nowrap");const t=e.querySelector(".fc-marquee-inner");t&&(e.innerHTML=t.innerHTML)}),!t.length)return void(e.innerHTML='<tr><td colspan="10" class="text-center text-gray-500 py-6">没有符合条件的结果</td></tr>');const n="searchAirflowTbody"===e.id?"search_airflow":"searchLikesTbody"===e.id?"search_rating":"search";e.innerHTML=t.map(e=>{const t=e.brand_name_zh,o=e.model_name,i=b(e.condition_name_zh||""),r=e.reference_price>0?b(String(e.reference_price)):"-",a="noise"===e.effective_axis?"noise_db":e.effective_axis||"rpm",s="noise_db"===a?"dB":"RPM",c=Number(e.effective_x),l=`${"noise_db"===a?c.toFixed(1):Math.round(c).toString()} ${s} (${"fit"===e.effective_source?"拟合":"原始"})`,d=Number(e.effective_airflow??e.max_airflow??0).toFixed(1);return`\n      <tr class="hover:bg-gray-50">\n        <td class="nowrap">${b(t)}</td>\n        <td class="nowrap">${b(o)}</td>\n        <td class="nowrap">${b(e.size)}x${b(e.thickness)}</td>\n        <td class="nowrap">${b(e.rgb_light||"—")}</td>\n        <td class="nowrap">${r}</td>\n        <td class="nowrap">${i}</td>\n        <td class="nowrap">${l}</td>\n        <td class="text-blue-600 font-medium text-sm">${d}</td>\n        <td class="text-blue-600 font-medium">${e.like_count??0}</td>\n        <td>${U("search",t,o,e.model_id,e.condition_id,e.condition_name_zh,n)}</td>\n      </tr>`}).join("")}function se(e,t){re=e.slice();const n=re,o=re.slice().sort((e,t)=>(t.like_count||0)-(e.like_count||0));let i="转速";if(e&&e.length){const t=e[0]?.effective_axis;i="noise"===t||"noise_db"===t?"噪音":"转速"}const r=document.getElementById("searchXHeaderAir"),a=document.getElementById("searchXHeaderLikes");r&&(r.textContent=i),a&&(a.textContent=i);const s=document.getElementById("searchConditionLabel");s&&(s.textContent=t),ae(oe,n),ae(ie,o),G()}function ce(e,t,n){window.__APP.dom.all(`.like-button[data-model-id="${e}"][data-condition-id="${t}"]`).forEach(e=>{const t=e.querySelector("i");t&&(t.classList.toggle("text-red-500",n),t.classList.toggle("text-gray-400",!n))})}const le=function(){const e=function(e){let t=null;return function(){clearTimeout(t),t=setTimeout(e,650)}}(()=>{C&&T()});return function(){e()}}();function de(t=1){return!e||!(LocalState.getSelected().length+t>e&&(p(`将超出最大上限（${e}），请先移除部分曲线`),1))}function ue(e){const t=new Set(LocalState.getSelectionPairs().map(e=>`${e.model_id}_${e.condition_id}`)),n=[],o=new Set;return e.forEach(e=>{const i=`${e.model_id}_${e.condition_id}`;o.has(i)||(o.add(i),t.has(i)||n.push(e))}),n}function me(){window.__APP.dom.all("#sidebar .fan-item .truncate").forEach(e=>{if(e.querySelector(".fc-sidebar-marquee-inner"))return;const t=document.createElement("span");t.className="fc-sidebar-marquee-inner",t.innerHTML=e.innerHTML,e.innerHTML="",e.appendChild(t)})}function fe(e,t,n,o){const i=e.querySelector(t),r=e.querySelector(n);if(!i||!r)return;const a=r.scrollWidth-i.clientWidth;if(a>6){const e=(a/o).toFixed(2);r.style.transition=`transform ${e}s linear`,r.style.transform=`translateX(-${a}px)`}}function he(e,t){const n=e.querySelector(t);n&&(n.style.transition="transform .35s ease",n.style.transform="translateX(0)")}function pe(){document.querySelectorAll("#recentLikesList .scenario-row .scenario-text").forEach(e=>{if(e.querySelector(".fc-recent-marquee-inner"))return;const t=document.createElement("span");t.className="fc-recent-marquee-inner",t.textContent=e.textContent,e.textContent="",e.appendChild(t)})}document.addEventListener("click",async e=>{const t=safeClosest(e.target,".like-button");if(t){if(!g.has("like")&&!function(){const e=Number(window.APP_CONFIG.clickCooldownMs||2e3),t=Date.now();return t-y<e?(p("操作过于频繁，请稍后"),!1):(y=t,!0)}())return;const e=t.dataset.modelId,n=t.dataset.conditionId;if(!e||!n)return void h("缺少点赞标识");const o=t.querySelector("i").classList.contains("text-red-500"),i=!o,r=o?"/api/unlike":"/api/like",a=`${e}_${n}`;return ce(e,n,i),i?LocalState.likes.add(a):LocalState.likes.remove(a),void fetch(r,{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({model_id:e,condition_id:n})}).then(e=>e.json()).then(t=>{const i=v(t);if(!i.ok)return ce(e,n,o),o?LocalState.likes.add(a):LocalState.likes.remove(a),void h(i.error_message||"操作失败");const r=i.data||{};r.fp&&(LocalState.likes.updateServerFP(r.fp),LocalState.likes.logCompare());const s=LocalState.likes.has(a);ce(e,n,s),r.fp&&(!LocalState.likes.isSynced()||!LocalState.likes.shouldSkipStatus())&&r.fp.c<20&&F(),le(),f(o?"已取消点赞":"已点赞")}).catch(t=>{ce(e,n,o),o?LocalState.likes.add(a):LocalState.likes.remove(a),h("网络错误："+t.message)})}const n=safeClosest(e.target,".js-list-remove");if(n){const e=n.dataset.modelId,t=n.dataset.conditionId,o=LocalState.getSelected();let i=null;return e&&t&&(i=o.find(n=>String(n.model_id)===String(e)&&String(n.condition_id)===String(t))),i?void(LocalState.removeKey(i.key)?(f("已移除"),Z(LocalState.getSelected()),window.__APP.features.recentlyRemoved.rebuild(LocalState.getRecentlyRemoved()),G(),xe(!1)):h("移除失败（未找到）")):(p("该数据已不在图表中"),void G())}{const t=[".js-ranking-add",".js-search-add",".js-rating-add",".js-likes-add"];for(const n of t){const t=safeClosest(e.target,n);if(!t)continue;const o=t.dataset.modelId,i=t.dataset.conditionId;if(!o||!i)return void h("缺少标识：按钮未包含 model_id / condition_id");u("op","添加中...");try{const e=[{model_id:Number(o),condition_id:Number(i),brand:t.dataset.brand?_(t.dataset.brand):"",model:t.dataset.model?_(t.dataset.model):"",condition:t.dataset.condition?_(t.dataset.condition):""}],n=ue(e);if(0===n.length)return m("op"),void p("已存在");if(!de(n.length))return void m("op");const r=LocalState.addPairs(e);Z(LocalState.getSelected()),N(r.addedDetails.map(e=>({model_id:e.model_id,condition_id:e.condition_id}))),window.__APP.features.recentlyRemoved.rebuild(LocalState.getRecentlyRemoved()),G(),applySidebarColors(),xe(!1),m("op"),f(`新增 ${r.added} 组`),window.__APP.sidebar.maybeAutoOpenSidebarOnAdd&&window.__APP.sidebar.maybeAutoOpenSidebarOnAdd();const a=t.dataset.addType||"",s={likes:"liked",rating:"top_rating",ranking:"top_query",search:"search"},c=t.dataset.logSource||s[a]||"unknown";Promise.resolve(Se(r.addedDetails,c)).catch(()=>{})}catch(e){m("op"),h("添加失败: "+e.message)}return}}const o=safeClosest(e.target,".js-remove-fan");if(o){const e=o.dataset.fanKey;return e?void(LocalState.removeKey(e)?(f("已移除"),Z(LocalState.getSelected()),window.__APP.features.recentlyRemoved.rebuild(LocalState.getRecentlyRemoved()),G(),xe(!1)):p("条目不存在")):void h("缺少 fan_key")}if("clearAllBtn"!==e.target.id){if("cancelClearAll"===e.target.id)return Q.setAttribute("data-state","normal"),Q.textContent="移除所有",void ge();if("confirmClearAll"!==e.target.id);else{u("op","清空中...");try{LocalState.clearAll(),m("op"),f("已全部移除"),Z(LocalState.getSelected()),window.__APP.features.recentlyRemoved.rebuild(LocalState.getRecentlyRemoved()),G(),applySidebarColors(),xe(!1)}catch(e){m("op"),h("清空失败: "+e.message)}finally{Q.setAttribute("data-state","normal"),Q.textContent="移除所有"}}}else"normal"===(e.target.getAttribute("data-state")||"normal")&&(Q.setAttribute("data-state","confirming"),Q.innerHTML='\n        <div class="fc-clear-confirm">\n          <button type="button" id="confirmClearAll" class="bg-red-600 text-white hover:bg-red-700">确认</button>\n          <button type="button" id="cancelClearAll" class="bg-gray-400 text-white hover:bg-gray-500">取消</button>\n        </div>',ge())}),me(),document.addEventListener("mouseenter",e=>{const t=safeClosest(e.target,"#sidebar .fan-item");t&&function(e){fe(e,".truncate",".fc-sidebar-marquee-inner",60)}(t)},!0),document.addEventListener("mouseleave",e=>{const t=safeClosest(e.target,"#sidebar .fan-item");t&&function(e){he(e,".fc-sidebar-marquee-inner")}(t)},!0),window.syncQuickActionButtons=G,window.rebuildSelectedFans=Z,window.renderSearchResults=se,window.ensureCanAdd=de,window.computeNewPairsAfterDedup=ue,window.prepareSidebarMarquee=me,window.ensureLikeStatusBatch=N,window.refreshChartFromLocal=xe,window.logNewPairs=Se,window.syncTopTabsViewportHeight=q,window.initSnapTabScrolling=o,document.addEventListener("mouseenter",e=>{const t=safeClosest(e.target,"#recentLikesList .scenario-row");t&&function(e){fe(e,".scenario-text",".fc-recent-marquee-inner",60)}(t)},!0),document.addEventListener("mouseleave",e=>{const t=safeClosest(e.target,"#recentLikesList .scenario-row");t&&function(e){he(e,".fc-recent-marquee-inner")}(t)},!0);let ye=!1;function ge(){window.__VERT_DRAGGING||window.__SIDEBAR_USER_ADJUSTED_VERTICAL||ye||(ye=!0,requestAnimationFrame(()=>{ye=!1,window.__APP?.sidebar?.adjustBottomPanelAuto?.()}))}function we(){fetch("/api/query_count").then(e=>e.json()).then(e=>{const t=e&&"object"==typeof e?e.data&&"object"==typeof e.data&&void 0!==e.data.count?e.data.count:void 0!==e.count?e.count:0:0,n=document.getElementById("query-count");n&&(n.textContent=t)}).catch(e=>{console.warn("获取查询次数失败:",e)})}function be(){document.querySelectorAll("#recentLikesList .recent-like-group").forEach(e=>{const t=e.querySelector(".fc-group-header .fc-title-wrap"),n=t?.querySelector(".truncate");if(!t||!n)return;const o=Math.max(0,Math.ceil(n.getBoundingClientRect().width));t.style.setProperty("--title-w",o+"px")})}if(function(){function e(){const e=document.getElementById("chartRoot");e&&window.ChartRenderer&&"function"==typeof ChartRenderer.mount&&(ChartRenderer.mount(e),"function"==typeof ChartRenderer.setOnXAxisChange&&ChartRenderer.setOnXAxisChange(e=>{const t="noise"===e?"noise_db":e;try{localStorage.setItem("x_axis_type",t)}catch(e){}if(A=t,"function"==typeof LocalState?.setXAxisType)try{LocalState.setXAxisType(t)}catch(e){}S&&E(S)}))}"loading"!==document.readyState?e():document.addEventListener("DOMContentLoaded",e,{once:!0})}(),n(),Z(LocalState.getSelected()),async function(){try{const e=LocalState.getSelectionPairs();if(!e.length)return;let n=!1;if($())return F(),void(n=!0);if(LocalState.likes.shouldSkipStatus(t))return;const o=e.filter(e=>!LocalState.likes.has(`${e.model_id}_${e.condition_id}`));if(!o.length&&LocalState.likes.isSynced())return;const i=await fetch("/api/like_status",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairs:o})});if(!i.ok)return;const r=v(await i.json());if(!r.ok)return;const a=r.data||{};a.fp&&(LocalState.likes.updateServerFP(a.fp),LocalState.likes.logCompare());const s=x(a);if(!Array.isArray(s)||!s.length)return;s.forEach(e=>{if(!LocalState.likes.has(e)){LocalState.likes.add(e);const[t,n]=e.split("_");t&&n&&ce(t,n,!0)}});const c=LocalState.likes.getServerFP&&LocalState.likes.getServerFP();!n&&c&&"number"==typeof c.c&&c.c<20&&!LocalState.likes.isSynced()&&F()}catch(e){}}(),window.__APP.features.recentlyRemoved.rebuild(LocalState.getRecentlyRemoved()),async function(){try{const e=LocalState&&LocalState.getRecentlyRemoved&&LocalState.getRecentlyRemoved()||[];if(!Array.isArray(e)||!e.length)return;const t=new Set((LocalState.getSelectionPairs?.()||[]).map(e=>`${e.model_id}_${e.condition_id}`)),n=[],o=new Set;for(const i of e){if(!i)continue;const e=`${i.model_id}_${i.condition_id}`;if(t.has(e))continue;if(DisplayCache.get&&DisplayCache.get(i.model_id,i.condition_id))continue;if(o.has(e))continue;o.add(e);const r=Number(i.model_id),a=Number(i.condition_id);Number.isInteger(r)&&Number.isInteger(a)&&n.push({model_id:r,condition_id:a})}if(!n.length)return;const i=await async function(e){if(!Array.isArray(e)||!e.length)return[];const t=await fetch("/api/meta_by_ids",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairs:e})}),n=v(await t.json());if(!n.ok)return[];const o=n.data&&n.data.items||[];return Array.isArray(o)?o:[]}(n);i.length&&(DisplayCache.setFromMeta(i),window.__APP?.features?.recentlyRemoved?.rebuild?.(LocalState.getRecentlyRemoved()))}catch(e){}}(),applySidebarColors(),xe(!1),G&&G(),me(),function(){try{"1"===new URLSearchParams(window.location.search).get("share_loaded")&&window.addEventListener("load",()=>{setTimeout(()=>{const e=document.getElementById("chart-settings");e&&e.scrollIntoView({behavior:"smooth",block:"center"})},120)})}catch(e){}}(),function(){const e=document.querySelector("#selectedFansList");e&&(e.style.paddingBottom="var(--content-bottom-gap)")}(),window.addEventListener("resize",()=>{const e=document.getElementById("sidebar")?.classList.contains("collapsed");e||M()}),o({containerId:"sidebar-top-container",group:"sidebar-top",persistKey:null,onActiveChange:e=>{"recent-liked"===e&&(C||T())}}),o({containerId:"left-panel-container",group:"left-panel",persistKey:"activeTab_left-panel"}),window.__APP.modules={overlay:{open:window.overlayOpenSidebar,close:window.overlayCloseSidebar,toggle:window.overlayToggleSidebar},gesture:{ensureZone:window.ensureGestureZone||function(){}},layout:{scheduleAdjust:ge,adjustBottomAuto:window.__APP.sidebar.adjustBottomPanelAuto},search:{render:se,cache:window.__APP.cache},rankings:{reloadTopRatings:()=>window.RightPanel?.ratings?.reloadTopRatings?.(!1),loadLikesIfNeeded:()=>window.RightPanel?.ratings?.loadLikesIfNeeded?.()},state:{processState:function(e,t){new Set(j),e.error_message?(m("op"),h(e.error_message)):(t&&f(t),m("op"),m("op"),document.querySelectorAll(".fc-toast.fc-toast--loading").forEach(e=>{const t=e.querySelector(".msg");if(!t)return;const n=(t.textContent||"").trim();/^(添加中|移除中)/.test(n)&&e.remove()}));let n=null;if("chart_data"in e&&(n=e.chart_data),"share_meta"in e&&e.share_meta&&ColorManager.patchIndicesFromServer(e.share_meta),"like_keys"in e&&LocalState.likes.setAll(e.like_keys||[]),e.fp&&(LocalState.likes.updateServerFP(e.fp),LocalState.likes.logCompare()),"selected_fans"in e&&(ColorManager.assignUniqueIndices((e.selected_fans||[]).map(e=>e.key)),Z(e.selected_fans)),"recently_removed_fans"in e&&window.__APP.features.recentlyRemoved.rebuild(e.recently_removed_fans),"share_meta"in e&&e.share_meta&&(ee={show_raw_curves:e.share_meta.show_raw_curves,show_fit_curves:e.share_meta.show_fit_curves,pointer_x_rpm:e.share_meta.pointer_x_rpm,pointer_x_noise_db:e.share_meta.pointer_x_noise_db,legend_hidden_keys:e.share_meta.legend_hidden_keys},te&&!ne&&e.chart_data&&e.chart_data.x_axis_type)){A="noise"===e.chart_data.x_axis_type?"noise_db":e.chart_data.x_axis_type;try{localStorage.setItem("x_axis_type",A)}catch(e){}ne=!0}n&&E(n),G(),ge()}},theme:{setTheme:O},chart:{postChartData:E,resizeChart:M}},window.__APP.features?.recentlyRemoved?.mount?.(),n(),function(){function e(){try{const e=document.createElement("div");e.style.cssText="position:absolute;top:-9999px;left:-9999px;width:120px;height:120px;overflow:scroll;visibility:hidden;",document.body.appendChild(e);const t=Math.max(0,e.offsetWidth-e.clientWidth)||0;document.documentElement.style.setProperty("--sbw",t+"px"),document.documentElement.classList.toggle("overlay-scrollbars",0===t),e.remove()}catch(e){}}"loading"===document.readyState?document.addEventListener("DOMContentLoaded",e,{once:!0}):e();const t=()=>setTimeout(e,60);window.addEventListener("orientationchange",t),window.addEventListener("resize",t)}(),function(){const e=document.getElementById("sortBySelect"),t=document.getElementById("sortValueInput");function n(){const n="none"===e.value;t.disabled=n,n&&(t.value="")}e&&t&&(e.addEventListener("change",n),n())}(),document.addEventListener("DOMContentLoaded",()=>{we(),setInterval(we,6e4)}),"function"==typeof window.rebuildRecentLikes&&!window.__RECENT_TITLE_MASK_PATCHED__){window.__RECENT_TITLE_MASK_PATCHED__=!0;const e=window.rebuildRecentLikes;window.rebuildRecentLikes=function(t){e(t),requestAnimationFrame(be)}}let _e=null;function ve(e,t){const n=b(e||""),o=t??"";return""===String(o).trim()||"无"===String(o).trim()?n:`${n}(${b(o)})`}async function xe(e=!1){const t=LocalState.getSelectionPairs();if(0!==t.length)try{const n=await fetch("/api/curves",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify({pairs:t})}),o=v(await n.json());if(!o.ok)return void h(o.error_message||"获取曲线失败");const i=o.data||{},r={x_axis_type:LocalState.getXAxisType(),series:i.series||[]};DisplayCache.setFromSeries(r.series),Z(LocalState.getSelected()),window.__APP.features.recentlyRemoved.rebuild(LocalState.getRecentlyRemoved()),S=r,E(r),e&&f("已刷新曲线")}catch(e){h("曲线请求异常: "+e.message)}else E({x_axis_type:LocalState.getXAxisType(),series:[]})}async function Se(e,t="unknown"){if(!e||!e.length)return;const n=e.map(e=>({model_id:e.model_id,condition_id:e.condition_id}));if(!window.Analytics||"function"!=typeof window.Analytics.logQueryPairs)throw new Error("Analytics module not loaded: window.Analytics.logQueryPairs is unavailable");await window.Analytics.logQueryPairs(t,n)}window.addEventListener("resize",()=>{_e&&cancelAnimationFrame(_e),_e=requestAnimationFrame(be)}),function(){try{if("1"===sessionStorage.getItem("visit_started"))return}catch(e){}const e={screen_w:screen&&screen.width||null,screen_h:screen&&screen.height||null,device_pixel_ratio:window.devicePixelRatio||null,language:navigator.languages&&navigator.languages[0]||navigator.language||null,is_touch:"ontouchstart"in window||navigator.maxTouchPoints>0};fetch("/api/visit_start",{method:"POST",headers:{"Content-Type":"application/json"},body:JSON.stringify(e),keepalive:!0}).catch(()=>{}).finally(()=>{try{sessionStorage.setItem("visit_started","1")}catch(e){}})}(),function(){const e=".fc-expand-toggle",t=["[data-tooltip]",e,".fc-tooltip-target",".fc-btn-icon-add",".like-button",".js-remove-fan",".js-restore-fan","#sidebar-toggle","#themeToggle",".fc-info-btn"].join(", "),n="ontouchstart"in window||navigator.maxTouchPoints>0;let o=null,i=null,r=null,a=null,s=null;function c(){return o||(o=document.createElement("div"),o.id="appTooltip",o.style.whiteSpace="normal",o.style.wordBreak="break-word",o.style.maxWidth="min(70vw, 320px)",document.body.appendChild(o),o)}function l(e,t="top"){const n=c(),o=e.getBoundingClientRect(),i=window.innerWidth,r=window.innerHeight;n.style.visibility="hidden",n.dataset.show="1",n.style.left="-9999px",n.style.top="-9999px";const a=n.offsetWidth,s=n.offsetHeight;let l=t;const d=o.top,u=r-o.bottom;"top"===t&&d<s+12&&(l="bottom"),"bottom"===t&&u<s+12&&(l="top");let m=o.left+o.width/2;const f=a/2;m=Math.max(8+f,Math.min(i-8-f,m));const h="top"===l?o.top-s-10:o.bottom+10;n.dataset.placement=l,n.style.left=`${Math.round(m)}px`,n.style.top=`${Math.round(h)}px`,n.style.visibility=""}function d(e){e&&e.hasAttribute("title")&&(e.setAttribute("data-title",e.getAttribute("title")||""),e.removeAttribute("title"))}const u=t=>!(!t||!t.matches(e));function m(e){if(!u(e))return!1;try{return"1"===sessionStorage.getItem("suppress_expand_toggle_tooltip")}catch(e){return!1}}function f(e){e&&e.removeAttribute("data-tip-silence")}function h(e){return!(!e||"1"!==e.getAttribute("data-tip-silence"))}function p(){s&&(clearTimeout(s),s=null)}function y(e){if(p(),clearTimeout(r),clearTimeout(a),h(e))return;i=e;const t=function(e){if(u(e))return function(e){return"true"===e.getAttribute("aria-expanded")?"收起该型号的所有工况":"展开该型号的所有工况"}(e);if((e=>!(!e||!e.matches(".fc-btn-icon-add, .like-button, .js-remove-fan, .js-restore-fan")))(e))return function(e){if(!e)return"";if(e.matches(".fc-btn-icon-add"))return"remove"===(e.dataset.mode||"")?"从图表移除":"添加到图表";if(e.matches(".like-button")){const t=e.querySelector("i");return t&&t.classList.contains("text-red-500")?"取消点赞":"点赞"}return e.matches(".js-remove-fan")?"移除":e.matches(".js-restore-fan")?"恢复":""}(e);const t=e.getAttribute("data-tooltip");return t&&""!==t.trim()?t:e.hasAttribute("title")?e.getAttribute("title")||"":e.getAttribute("data-title")||""}(e);var o;t&&(o=t,c().innerHTML=o,l(e,e.getAttribute("data-tooltip-placement")||"top"),c().dataset.show="1",n&&(a=setTimeout(()=>w(!0),1200)))}function g(t){if(p(),h(t))return;const n=t&&(t.matches(e)||(o=t)&&(o.matches("#sidebar-toggle")||o.matches("#themeToggle")||o.matches(".fc-info-btn")))||t&&t.matches(".fc-btn-icon-add, .like-button, .js-remove-fan, .js-restore-fan")?700:0;var o;n<=0?y(t):s=setTimeout(()=>y(t),n)}function w(e=!1){const t=c(),n=()=>{t.dataset.show="0",i=null};if(e)return p(),n();r=setTimeout(n,60)}document.addEventListener("mouseenter",e=>{if(n)return;const o=safeClosest(e.target,t);o&&(u(o)&&m(o)||(d(o),g(o)))},!0),document.addEventListener("mouseout",e=>{if(n)return;const o=safeClosest(e.target,t);if(!o)return;const i=e.relatedTarget;i&&(i===o||o.contains(i))||(p(),w(!1),f(o))},!0),document.addEventListener("focusin",e=>{if(n)return;const o=safeClosest(e.target,t);o&&(u(o)&&m(o)||(d(o),g(o)))}),document.addEventListener("focusout",e=>{if(n)return;const o=safeClosest(e.target,t);o&&(p(),w(!1),f(o))}),document.addEventListener("touchstart",e=>{const n=safeClosest(e.target,t);n&&(u(n)&&m(n)||(d(n),y(n)))},{passive:!0,capture:!0}),document.addEventListener("click",e=>{const n=safeClosest(e.target,t);n&&(d(n),function(e){e&&e.setAttribute("data-tip-silence","1")}(n),p(),w(!0))},!0);const b=()=>{i&&document.body.contains(i)&&l(i,i.getAttribute("data-tooltip-placement")||"top")};window.addEventListener("resize",b),window.addEventListener("scroll",b,{passive:!0,capture:!0}),window.addEventListener("beforeunload",()=>{document.querySelectorAll("[data-title]").forEach(e=>{e.setAttribute("title",e.getAttribute("data-title")||""),e.removeAttribute("data-title")})})}(),window.formatScenario=ve,function(){const e=document.getElementById("announcementBar"),t=document.getElementById("fcAnnounceText"),n=document.getElementById("fcAnnounceClose");if(!e||!t||!n)return;const o=window.matchMedia&&window.matchMedia("(prefers-reduced-motion: reduce)").matches;let i=!1,r=null,a=0,s=0,c=0,l=!1,d=[],u=null,m=0;const f=e.querySelector(".fc-announce-inner");let h=document.createElement("div");h.className="fc-announce-roller",f.insertBefore(h,f.querySelector(".fc-announce-gradient")),h.appendChild(t);let p=null;try{p=sessionStorage.getItem("announce_closed_id")}catch(e){}function y(){const t=e.getBoundingClientRect().height;document.documentElement.style.setProperty("--announce-offset",t+"px")}function g(){i=!1,r&&cancelAnimationFrame(r),r=null,t.style.transform="translateX(0)",t.classList.remove("is-marquee")}function w(e){if(!i)return;a||(a=e);const n=(e-a)/c%1*-s;t.style.transform=`translateX(${n}px)`,r=requestAnimationFrame(w)}function b(){g();const e=t.scrollWidth,n=t.parentElement.clientWidth;if(e<=n+4)return;t.classList.add("is-marquee"),s=e-n;const o=s/80*1e3;c=Math.min(3e4,Math.max(6e3,o)),i=!0,a=0,r=requestAnimationFrame(w)}function _(n,i=!0){if(!d.length)return;n%=d.length,m=n;const r=d[n];r&&(i?function(e){if(o)return t.textContent=e,y(),void b();Array.from(h.children).forEach((e,n)=>{e!==t&&e.classList.contains("fc-announce-text")&&e.remove()});const n=document.createElement("span");n.className="fc-announce-text",n.textContent=e,h.appendChild(n);const i=t.offsetHeight||t.getBoundingClientRect().height||0,r=n.offsetHeight||n.getBoundingClientRect().height||0,a=Math.max(i,r);h.style.height=a+"px",g(),h.style.transform="translateY(0)",h.offsetWidth,h.classList.add("is-sliding"),requestAnimationFrame(()=>{h.style.transform=`translateY(-${i}px)`});let s=380;try{const e=getComputedStyle(h).transitionDuration.split(",")[0].trim();e.endsWith("ms")?s=parseFloat(e):e.endsWith("s")&&(s=1e3*parseFloat(e)),(!Number.isFinite(s)||s<=0)&&(s=380)}catch(e){}let c=!1;const l=setTimeout(()=>{c||d()},s+60);function d(){c||(c=!0,clearTimeout(l),h.removeEventListener("transitionend",d),h.classList.remove("is-sliding"),t.textContent=e,n.remove(),h.style.removeProperty("transition"),h.style.transform="translateY(0)",h.style.height="",y(),b())}h.addEventListener("transitionend",e=>{"transform"===e.propertyName&&d()})}(r.content_text):(t.textContent=r.content_text,y(),b()),e.setAttribute("data-id",r.id))}async function x(){try{const t=await fetch("/api/announcement"),n=v(await t.json());if(!n.ok)return;const o=n.data||{};let i=Array.isArray(o.items)?o.items.slice():[];if(p&&i.some(e=>String(e.id)===String(p)))return;if(d=i,!d.length)return;e.classList.remove("hidden"),_(0,!1),clearInterval(u),d.length<=1||(u=setInterval(()=>{l?clearInterval(u):_(m+1,!0)},1e4))}catch(e){}}n.addEventListener("click",()=>{e.classList.add("hidden"),l=!0,clearInterval(u),u=null,g(),document.documentElement.style.setProperty("--announce-offset","0px");try{const t=e.getAttribute("data-id");t&&sessionStorage.setItem("announce_closed_id",t)}catch(e){}}),x(),setInterval(()=>{l||x()},6e4),window.addEventListener("resize",()=>{e.classList.contains("hidden")||(y(),g(),b())});let S=null;function A(e){if(!t.classList.contains("is-marquee"))return;g();const n=e.touches?e.touches[0]:e;S={startX:n.clientX,baseX:0,currentX:0,minX:-(t.scrollWidth-t.parentElement.clientWidth),maxX:0},t.classList.add("dragging"),e.preventDefault()}function L(e){if(!S)return;const n=(e.touches?e.touches[0]:e).clientX-S.startX;let o=S.baseX+n;o<S.minX&&(o=S.minX),o>S.maxX&&(o=S.maxX),S.currentX=o,t.style.transform=`translateX(${o}px)`,e.preventDefault()}function E(){S&&(S=null,t.classList.remove("dragging"))}t.addEventListener("touchstart",A,{passive:!1}),t.addEventListener("touchmove",L,{passive:!1}),t.addEventListener("touchend",E,{passive:!0}),t.addEventListener("mousedown",A),window.addEventListener("mousemove",L),window.addEventListener("mouseup",E)}()}},t={};function n(o){var i=t[o];if(void 0!==i)return i.exports;var r=t[o]={exports:{}};return e[o](r,r.exports,n),r.exports}n.n=e=>{var t=e&&e.__esModule?()=>e.default:()=>e;return n.d(t,{a:t}),t},n.d=(e,t)=>{for(var o in t)n.o(t,o)&&!n.o(e,o)&&Object.defineProperty(e,o,{enumerable:!0,get:t[o]})},n.o=(e,t)=>Object.prototype.hasOwnProperty.call(e,t),(()=>{"use strict";n(285),n(5),n(839),n(768),n(442),n(905),n(946),n(391),n(911),n(654)})()})();